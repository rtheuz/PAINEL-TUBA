<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');

        /* Layout geral */
        :root {
            --accent: #1a73e8;
            --muted: #666;
            --card-bg: #fff;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 12px;
            background: #f5f7fb;
            color: #222;
        }

        h1,
        h2,
        h3 {
            margin: 0 0 8px 0;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Card/Section */
        .section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 14px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .section small {
            color: var(--muted);
        }

        /* Form grid */
        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .col {
            flex: 1 1 220px;
            min-width: 180px;
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        /* Buttons */
        button {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn {
            appearance: none;
            border: none;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            gap: 8px;
            align-items: center;
            background: #1a73e8;
            color: white;
        }

        button.secondary {
            background: #fff;
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .muted-btn {
            background: #f0f0f0;
            color: #333;
        }

        /* chapa / peca / processo cards */
        .chapa,
        .peca,
        .processo {
            border: 1px dashed #e0e6f0;
            padding: 10px;
            border-radius: 8px;
            background: #fafcff;
            margin-bottom: 10px;
        }

        .titulo {
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .controls {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* hidden groups */
        .hidden {
            display: none !important;
        }

        /* small inline labels */
        .inline {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .inline label {
            width: auto;
            margin: 0;
            font-size: 13px;
        }

        /* footer note */
        .note {
            font-size: 12px;
            color: var(--muted);
            margin-top: 8px;
        }

        /* Preview section styles */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #4caf50;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* responsive */
        @media (max-width: 720px) {
            .row {
                flex-direction: column;
            }
        }
    </style>
</head>
<div class="btn" style="position:absolute; top:16px; left:16px;" onclick="voltarPagina()" title="Voltar">
    ‚Üê Voltar
</div>

<body>
    <div class="container">
        <form id="mainForm" onsubmit="enviarArquivosCliente(event)">
        <h1>Novo Or√ßamento</h1>

        <!-- PROJETO / PASTA -->
        <div class="section" id="projetoSection">
            <div class="section-header">
                <div>
                    <h3>Projeto / Pasta</h3>
                    <small>Preencha os dados do c√≥digo do projeto.</small>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Data (YYMMDD):</label>
                    <input type="text" id="projetoData">
                </div>
                <div class="col">
                    <label>√çndice:</label>
                    <input type="text" id="projetoIndice" value="a">
                </div>
                <div class="col">
                    <label>Iniciais:</label>
                    <input type="text" id="projetoIniciais" value="">
                </div>
            </div>

            <div class="row" style="margin-top:10px;">
                <div class="col">
                    <label>Nome da Pasta:</label>
                    <input type="text" id="projetoPasta"
                        placeholder="Nome da pasta depois do n√∫mero do projeto (Ex: 250922aBR COT - Nome da pasta)">
                </div>
            </div>
        </div>

        <!-- CLIENTE -->
        <div class="section" id="clienteSection">
            <div class="section-header">
                <div>
                    <h3>Cliente</h3>
                    <small>Selecione um cliente existente ou preencha um novo</small>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Buscar Cliente (digite o nome):</label>
                    <input type="text" id="clienteBusca" placeholder="Digite o nome do cliente..." list="clientesList"
                        autocomplete="off" style="font-weight:600;">
                    <datalist id="clientesList">
                        <!-- Ser√° preenchido dinamicamente -->
                    </datalist>
                    <input type="hidden" id="clienteSelectIndex" value="">
                </div>
                <div class="col">
                    <label>Nome:</label>
                    <input type="text" id="clienteNome">
                </div>
                <div class="col">
                    <label>CPF/CNPJ:</label>
                    <input type="text" id="clienteCpf">
                </div>
            </div>

            <div class="row" style="margin-top:8px;">
                <div class="col">
                    <label>Endere√ßo:</label>
                    <input type="text" id="clienteEndereco">
                </div>
                <div class="col">
                    <label>Telefone:</label>
                    <input type="text" id="clienteTelefone">
                </div>
                <div class="col">
                    <label>Email:</label>
                    <input type="text" id="clienteEmail">
                </div>
            </div>

            <div class="row" style="margin-top:8px;">
                <div class="col">
                    <label>Cliente Respons√°vel:</label>
                    <input type="text" id="clienteResponsavel">
                </div>
                <div class="col">
                    <label>Data:</label>
                    <input type="date" id="clienteData">
                </div>
            </div>
        </div>

        <!-- ITENS DO OR√áAMENTO -->
        <div class="section" id="chapasSection">
            <div class="section-header">
                <div>
                    <h3>Criar Produto</h3>
                    <small>Crie e gere o pre√ßo automaticamente de novos produtos baseado em suas informa√ß√µes (material, tempo corte, dobra...).<br>
                    Ap√≥s criar, o produto ser√° cadastrado automaticamente.</small>
                </div>
                <div>
                    <button type="button" onclick="addChapa()">+ Adicionar Chapa</button>
                </div>
            </div>

            <div id="chapasContainer"></div>
        </div>

        <!-- PRODUTOS CADASTRADOS -->
        <div class="section" id="produtosCadastradosSection">
            <div class="section-header">
                <div>
                    <h3>Produtos Cadastrados / Novos produtos</h3>
                    <small>Adicione produtos cadastrados ou crie novos produtos com pre√ßo definido.<br>
                        Novos produtos ser√£o cadastrados automaticamente.</small>
                </div>
                <div>
                    <button type="button" onclick="addProdutoCadastrado()">+ Adicionar Produto</button>
                </div>
            </div>
            <div id="produtosCadastradosContainer"></div>
        </div>

        <!-- PROCESSOS ADICIONAIS DO PEDIDO -->
        <div class="section" id="processosPedidoSection">
            <div class="section-header">
                <div>
                    <h3>Processos Adicionais do Pedido</h3>
                    <small>Processos que englobam todo o pedido (embalagens, envios, etc.)</small>
                </div>
                <div>
                    <button type="button" onclick="addProcessoPedido()">+ Adicionar Processo</button>
                </div>
            </div>
            <div id="processosPedidoContainer"></div>
        </div>


        <!-- OUTRAS INFORMA√á√ïES -->
        <div class="section" id="observacoesSection">
            <div class="section-header">
                <div>
                    <h3>Outras Informa√ß√µes</h3>
                    <small>Informa√ß√µes adicionais para o or√ßamento/PDF</small>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Projeto (c√≥digo):</label>
                    <input type="text" id="obsProjeto" readonly>
                </div>
                <div class="col" style="flex: 2;">
                    <label>Descri√ß√£o do Or√ßamento/Projeto:</label>
                    <input type="text" id="obsDescricao" placeholder="Descri√ß√£o breve do que ser√° or√ßado">
                </div>
            </div>

            <div class="row" style="margin-top:8px;">
                <div class="col">
                    <label>Previs√£o de faturamento:</label>
                    <input type="date" id="obsFaturamento">
                </div>
                <div class="col">
                    <label>Prazo de entrega:</label>
                    <input type="date" id="obsPrazo">
                </div>
                <div class="col">
                    <label>Vendedor:</label>
                    <input type="text" id="obsVendedor" placeholder="Nome do vendedor">
                </div>
            </div>

            <div class="row" style="margin-top: 8px;">
                <div class="col">
                    <label>Condi√ß√µes do material:</label>
                    <select id="obsMaterialCond">
                        <option value="">Selecione</option>
                        <option value="Incluso">Incluso</option>
                        <option value="N√£o incluso">N√£o incluso</option>
                    </select>
                </div>
                <div class="col">
                    <label>Pagamento (dias para vencimento das parcelas):</label>
                    <input 
                        type="text" 
                        id="obsPagamento" 
                        list="pagamentoList" 
                        placeholder="Ex: √Ä vista, 30 / 60, 30 / 45 / 60"
                        autocomplete="off"
                        style="font-weight:600;">
                    <datalist id="pagamentoList">
                        <option value="√Ä vista">
                        <option value="30 dias">
                        <option value="30 / 60">
                        <option value="30 / 45">
                        <option value="30 / 45 / 60">
                        <option value="30 / 60 / 90">
                        <option value="30 / 60 / 90 / 120">
                    </datalist>
                    <small style="color:#666;">Digite os dias de vencimento de cada parcela separados por " / " (ex: 30 / 45 / 60 para 3 parcelas)</small>
                </div>
            </div>

            <div style="margin-top:8px;">
                <label>Observa√ß√µes adicionais:</label>
                <textarea id="obsAdicional" rows="4"></textarea>
            </div>
        </div>

        <!-- ARQUIVOS DO CLIENTE -->
        <div class="section" id="arquivosSection">
            <div class="section-header">
                <div>
                    <h3>Arquivos do Cliente</h3>
                    <small>Envie aqui desenhos, especifica√ß√µes e outros arquivos enviados pelo cliente para este or√ßamento</small>
                </div>
                <div>
                    <button type="button" id="btnCriarPasta" class="secondary" onclick="criarPastaOrcamento()">Criar/Confirmar Pasta do Or√ßamento</button>
                    <button type="button" id="btnAbrirPasta" class="secondary" onclick="abrirPastaOrcamento()">Abrir Pasta</button>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Arquivos do cliente (salvos em 01_IN):</label>
                    <input type="file" id="arquivosCliente" name="arquivosCliente" multiple>
                    <small class="note">Os arquivos ser√£o salvos na pasta do projeto em 01_IN, usando o mesmo c√≥digo e nome de pasta do or√ßamento.</small>
                    <!-- Campos hidden para passar dados do projeto junto com o formul√°rio -->
                    <input type="hidden" id="hiddenCodigoProjeto" name="codigoProjeto" value="">
                    <input type="hidden" id="hiddenNomePasta" name="nomePasta" value="">
                    <input type="hidden" id="hiddenDataProjeto" name="dataProjeto" value="">
                </div>
            </div>

            <div class="row" style="margin-top:8px;">
                <div class="col">
                    <button type="submit" id="btnEnviarArquivos" class="secondary">Enviar Arquivos para a Pasta</button>
                    <div id="arquivosStatus" class="note"></div>
                </div>
            </div>
        </div>

        <!-- PREVIEW DO OR√áAMENTO -->
        <div class="section" id="previewSection" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50;">
            <div class="section-header">
                <div>
                    <h3 style="color: #2e7d32;">üí∞ Preview do Or√ßamento</h3>
                    <small id="previewStatus" style="color: #666;">Preencha os dados para ver o preview</small>
                </div>
                <div id="previewLoading" class="hidden" style="display: flex; align-items: center; gap: 8px;">
                    <div class="spinner"></div>
                    <span style="color: #666;">Calculando...</span>
                </div>
            </div>
            
            <div id="previewContent">
                <div class="row" style="margin-top: 12px;">
                    <div class="col">
                        <div id="previewDetalhamento" style="font-size: 13px; color: #555;"></div>
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 16px; background: #fff; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 18px; font-weight: 600; color: #2e7d32;">TOTAL ESTIMADO:</span>
                        <span id="previewTotal" style="font-size: 28px; font-weight: 700; color: #2e7d32;">R$ 0,00</span>
                    </div>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:12px; align-items:center; margin-bottom:40px; flex-wrap:wrap;">
            <button type="button" class="secondary" onclick="salvarRascunho()">Salvar Rascunho</button>
            <button type="button" class="secondary" id="btnAtualizarRascunho" onclick="atualizarRascunhoSelecionado()" style="display:none;">Atualizar dados</button>
            <button type="button" class="secondary" onclick="salvarComoPedido()" style="background:#2e7d32; color:white;">Salvar como Pedido</button>

            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <div style="position:relative;">
                    <input type="text" id="rascunhoBusca" placeholder="Buscar or√ßamento..." 
                           list="rascunhosList" autocomplete="off" 
                           style="padding: 8px; border-radius: 6px; border: 1px solid #ddd; min-width: 250px; font-weight:600;">
                    <datalist id="rascunhosList">
                        <!-- Ser√° preenchido dinamicamente -->
                    </datalist>
                    <input type="hidden" id="rascunhoSelectKey" value="">
                </div>
                <button type="button" id="btnCarregarRascunho" class="secondary" onclick="carregarRascunhoSelecionado()">Carregar</button>
                <button type="button" id="btnDeletarRascunho" class="secondary muted-btn" onclick="deletarRascunhoSelecionado()">Deletar</button>
            </div>

            <button type="button" id="btnGerar" onclick="calcular()">Calcular Or√ßamento e Gerar PDF</button>
            <button class="secondary muted-btn" onclick="window.close()">Fechar</button>
            <div class="note">A vers√£o do or√ßamento ser√° detectada automaticamente baseada nos arquivos existentes na pasta.</div>
        </div>
        </form>
    </div>

    <script>
        const token = "<?= token ?>"; // token deve ser string

        if (token) {
            google.script.run
                .withSuccessHandler(function (usuarioObj) {
                    if (!usuarioObj) return;

                    // Preenche nome completo do vendedor
                    const vendedorInput = document.getElementById("obsVendedor");
                    vendedorInput.value = usuarioObj.usuario || "";

                    // Preenche iniciais personalizadas (edit√°vel pelo usu√°rio)
                    const iniciaisInput = document.getElementById("projetoIniciais");
                    if (!iniciaisInput.value) {
                        // S√≥ preenche se estiver vazio (n√£o sobrescreve se j√° tiver valor)
                        iniciaisInput.value = usuarioObj.iniciais || "";
                        // Atualiza o c√≥digo do projeto ap√≥s preencher as iniciais
                        if (typeof atualizarCamposProjeto === 'function') {
                            atualizarCamposProjeto();
                        }
                    }

                })
                .getUsuarioLogadoPorToken(token);
        }

        /* ---------- INICIALIZA√á√ÉO ---------- */


        const today = new Date();
        document.getElementById("projetoData").value = String(today.getFullYear()).slice(2) +
            String(today.getMonth() + 1).padStart(2, '0') +
            String(today.getDate()).padStart(2, '0');
        document.getElementById("clienteData").value = today.toISOString().slice(0, 10);
        document.getElementById("obsFaturamento").value = today.toISOString().slice(0, 10);

        /* ---------- CLIENTE ---------- */
        let listaClientes = [];
        function carregarClientes() {
            google.script.run.withSuccessHandler(function (clientes) {
                listaClientes = clientes;
                const datalist = document.getElementById("clientesList");
                datalist.innerHTML = clientes.map(c =>
                    `<option value="${c.nome}" data-nome="${c.nome}">${c.nome}</option>`
                ).join('');
            }).getTodosClientes();
        }
        carregarClientes();

        // Campo de busca de clientes
        const clienteBuscaInput = document.getElementById("clienteBusca");
        const clientesDatalist = document.getElementById("clientesList");
        const clienteSelectIndex = document.getElementById("clienteSelectIndex");

        // Fun√ß√£o para filtrar clientes e atualizar datalist
        function filtrarClientes(termo) {
            if (!termo || termo.length < 1) {
                // Mostra todos os clientes
                clientesDatalist.innerHTML = listaClientes.map(c =>
                    `<option value="${c.nome}" data-nome="${c.nome}">${c.nome}</option>`
                ).join('');
                clienteBuscaInput.style.background = "";
                return;
            }

            const termoLower = termo.toLowerCase();
            const clientesFiltrados = listaClientes.filter(c => {
                const nome = String(c.nome || '').toLowerCase();
                return nome.includes(termoLower);
            });

            // Atualiza o datalist com clientes filtrados
            clientesDatalist.innerHTML = clientesFiltrados.map(c =>
                `<option value="${c.nome}" data-nome="${c.nome}">${c.nome}</option>`
            ).join('');

            // Se encontrou exatamente um cliente e corresponde, seleciona automaticamente
            if (clientesFiltrados.length === 1) {
                const cliente = clientesFiltrados[0];
                if (cliente.nome.toLowerCase() === termoLower) {
                    preencherDadosCliente(cliente);
                    clienteBuscaInput.style.background = "#e8f5e9";
                } else {
                    clienteBuscaInput.style.background = "";
                }
            } else if (clientesFiltrados.length > 0) {
                clienteBuscaInput.style.background = "#fff9c4"; // Amarelo claro para indicar m√∫ltiplos resultados
            } else {
                clienteBuscaInput.style.background = "#ffebee"; // Vermelho claro para indicar nenhum resultado
            }
        }

        // Listener para quando o usu√°rio digita
        clienteBuscaInput.addEventListener("input", function () {
            filtrarClientes(this.value.trim());
        });

        // Listener para quando o usu√°rio seleciona uma op√ß√£o do datalist
        clienteBuscaInput.addEventListener("change", function () {
            const selectedOption = Array.from(clientesDatalist.options).find(opt =>
                opt.value === this.value
            );
            if (selectedOption) {
                const nomeCliente = selectedOption.getAttribute("data-nome");
                const cliente = listaClientes.find(c => c.nome === nomeCliente);
                if (cliente) {
                    preencherDadosCliente(cliente);
                    clienteBuscaInput.style.background = "#e8f5e9";
                }
            } else {
                // Se n√£o encontrou correspond√™ncia exata, limpa os campos
                ["clienteNome", "clienteCpf", "clienteEndereco", "clienteTelefone", "clienteEmail"].forEach(id =>
                    document.getElementById(id).value = ""
                );
                clienteBuscaInput.style.background = "";
            }
        });

        // Fun√ß√£o auxiliar para preencher dados do cliente
        function preencherDadosCliente(c) {
            if (c) {
                document.getElementById("clienteNome").value = c.nome;
                document.getElementById("clienteCpf").value = c.cpf || "";
                document.getElementById("clienteEndereco").value = c.endereco || "";
                document.getElementById("clienteTelefone").value = c.telefone || "";
                document.getElementById("clienteEmail").value = c.email || "";
            } else {
                ["clienteNome", "clienteCpf", "clienteEndereco", "clienteTelefone", "clienteEmail"].forEach(id =>
                    document.getElementById(id).value = ""
                );
            }
        }

        /* ---------- PRODUTOS CADASTRADOS ---------- */
        let produtosCatalogo = [];

        // Carrega produtos da planilha ao iniciar
        function carregarProdutosCadastrados() {
            google.script.run.withSuccessHandler(function (produtos) {
                produtosCatalogo = produtos;
            }).getProdutosCadastrados();
        }
        carregarProdutosCadastrados();

        /* ---------- GERA√á√ÉO DE C√ìDIGOS PRD ---------- */
        let proximoCodigoPRD = null;
        let contadorPRDLocal = 0;

        // Carrega o pr√≥ximo c√≥digo PRD da planilha ao iniciar
        function carregarProximoCodigoPRD() {
            google.script.run.withSuccessHandler(function (codigoPRD) {
                proximoCodigoPRD = codigoPRD;
                contadorPRDLocal = 0;
            }).getProximoCodigoPRD();
        }
        carregarProximoCodigoPRD();

        // Gera o pr√≥ximo c√≥digo PRD localmente
        function gerarCodigoPRDLocal() {
            if (!proximoCodigoPRD) {
                return "PRD00001"; // Fallback se ainda n√£o carregou
            }

            // Extrai o n√∫mero do c√≥digo base
            const numeroBase = parseInt(proximoCodigoPRD.substring(3), 10);
            const novoNumero = numeroBase + contadorPRDLocal;
            contadorPRDLocal++;

            return "PRD" + String(novoNumero).padStart(5, "0");
        }

        function addProdutoCadastrado() {
            const container = document.getElementById("produtosCadastradosContainer");
            const div = document.createElement("div");
            div.className = "produto-cadastrado";
            div.style.border = "1px solid #e0e6f0";
            div.style.padding = "12px";
            div.style.marginBottom = "12px";
            div.style.borderRadius = "8px";
            div.style.background = "#f9fbff";

            // Gera c√≥digo PRD padr√£o
            const codigoPRDPadrao = gerarCodigoPRDLocal();

            div.innerHTML = `
                <div class="row">
                    <div class="col" style="flex: 2;">
                        <label>Buscar Produto (digite c√≥digo ou descri√ß√£o):</label>
                        <input type="text" class="produtoBusca" placeholder="Digite c√≥digo ou descri√ß√£o do produto..." 
                               list="produtosList-${Date.now()}" 
                               autocomplete="off"
                               style="font-weight:600;">
                        <datalist id="produtosList-${Date.now()}" class="produtosDatalist">
                            ${produtosCatalogo.map((p, idx) =>
                `<option value="${p.codigo} - ${p.descricao} (${p.familia || 'N/A'})" data-index="${idx}">${p.codigo} - ${p.descricao}</option>`
            ).join('')}
                        </datalist>
                        <input type="hidden" class="produtoSelectIndex" value="">
                    </div>
                </div>
                
                <div class="row" style="margin-top:8px;">
                    <div class="col">
                        <label>C√≥digo:</label>
                        <input type="text" class="produtoCodigo" value="${codigoPRDPadrao}" style="font-weight:600;">
                        <small style="color:#666;">PRD gerado automaticamente, edit√°vel</small>
                    </div>
                    <div class="col" style="flex: 2;">
                        <label>Descri√ß√£o:</label>
                        <input type="text" class="produtoDescricao" placeholder="Descri√ß√£o do produto" style="font-weight:600;">
                    </div>
                </div>
                
                <div class="row" style="margin-top:8px;">
                    <div class="col">
                        <label>Fam√≠lia:</label>
                        <input type="text" class="produtoFamilia" placeholder="Fam√≠lia">
                    </div>
                    <div class="col">
                        <label>Tipo:</label>
                        <input type="text" class="produtoTipo" placeholder="Tipo">
                    </div>
                    <div class="col">
                        <label>Unidade:</label>
                        <select class="produtoUnidade">
                            <option value="UN">UN</option>
                            <option value="TN">TN</option>
                            <option value="T">T</option>
                            <option value="RL">RL</option>
                            <option value="PT">PT</option>
                            <option value="P√á">P√á</option>
                            <option value="PAR">PAR</option>
                            <option value="MT">MT</option>
                            <option value="M¬≤">M¬≤</option>
                            <option value="M¬≥">M¬≥</option>
                            <option value="LT">LT</option>
                            <option value="L">L</option>
                            <option value="KG">KG</option>
                            <option value="JOGO">JOGO</option>
                            <option value="H">H</option>
                            <option value="GL">GL</option>
                            <option value="CX">CX</option>
                            <option value="CT">CT</option>
                            <option value="CH">CH</option>
                            <option value="CENTO">CENTO</option>
                            <option value="OUTRO">OUTRO</option>
                        </select>
                    </div>
                </div>
                
                <div class="row" style="margin-top:8px;">
                    <div class="col">
                        <label>Pre√ßo Unit√°rio (R$):</label>
                        <input type="number" step="0.01" class="produtoPrecoUnit" placeholder="0.00" style="font-weight:600; background:#fff8e1;">
                        <small style="color:#ff9800;">Edit√°vel apenas para este or√ßamento</small>
                    </div>
                    <div class="col">
                        <label>Quantidade:</label>
                        <input type="number" class="produtoQuantidade" value="1" min="1" style="font-weight:600;">
                    </div>
                    <div class="col">
                        <label>Pre√ßo Total (R$):</label>
                        <input type="number" step="0.01" class="produtoPrecoTotal" readonly style="background:#e8f5e9; font-weight:600;">
                    </div>
                </div>
                
                <div class="controls" style="margin-top:8px;">
                    <button type="button" class="secondary" onclick="atualizarPRDNoCatalogo(this.parentElement.parentElement)" style="background:#4caf50; color:white;">Atualizar PRD no Cat√°logo</button>
                    <button type="button" class="secondary" onclick="removeElement(this.parentElement.parentElement)">Remover Produto</button>
                </div>
            `;

            if (container.firstChild) {
                container.insertBefore(div, container.firstChild);
            } else {
                container.appendChild(div);
            }

            // Adiciona listener para atualizar total quando quantidade mudar
            const qtdInput = div.querySelector(".produtoQuantidade");
            qtdInput.addEventListener("input", function () {
                calcularTotalProduto(div);
            });

            // Adiciona listener para atualizar total quando pre√ßo unit√°rio mudar
            const precoUnitInput = div.querySelector(".produtoPrecoUnit");
            precoUnitInput.addEventListener("input", function () {
                calcularTotalProduto(div);
            });

            // Campo de busca integrado que filtra produtos por c√≥digo ou descri√ß√£o
            const buscaInput = div.querySelector(".produtoBusca");
            const datalist = div.querySelector(".produtosDatalist");
            const hiddenIndex = div.querySelector(".produtoSelectIndex");

            // Fun√ß√£o para filtrar produtos e atualizar datalist
            function filtrarProdutos(termo) {
                if (!termo || termo.length < 1) {
                    // Mostra todos os produtos
                    datalist.innerHTML = produtosCatalogo.map((p, idx) =>
                        `<option value="${p.codigo} - ${p.descricao} (${p.familia || 'N/A'})" data-index="${idx}">${p.codigo} - ${p.descricao}</option>`
                    ).join('');
                    buscaInput.style.background = "";
                    return;
                }

                const termoLower = termo.toLowerCase();
                // Divide o termo em palavras (separadas por espa√ßos)
                const palavras = termoLower.trim().split(/\s+/).filter(p => p.length > 0);
                
                const produtosFiltrados = produtosCatalogo.filter((p, idx) => {
                    const codigo = String(p.codigo || '').toLowerCase();
                    const descricao = String(p.descricao || '').toLowerCase();
                    const familia = String(p.familia || '').toLowerCase();
                    const textoCompleto = `${codigo} ${descricao} ${familia}`;
                    
                    // Se n√£o h√° palavras, retorna todos
                    if (palavras.length === 0) return true;
                    
                    // Se h√° apenas uma palavra, busca simples (compatibilidade)
                    if (palavras.length === 1) {
                        return codigo.includes(palavras[0]) || descricao.includes(palavras[0]) || familia.includes(palavras[0]);
                    }
                    
                    // Se h√° m√∫ltiplas palavras, todas devem aparecer no texto completo (em qualquer ordem)
                    return palavras.every(palavra => textoCompleto.includes(palavra));
                });

                // Atualiza o datalist com produtos filtrados
                datalist.innerHTML = produtosFiltrados.map((p, idx) => {
                    const originalIdx = produtosCatalogo.indexOf(p);
                    return `<option value="${p.codigo} - ${p.descricao} (${p.familia || 'N/A'})" data-index="${originalIdx}">${p.codigo} - ${p.descricao}</option>`;
                }).join('');

                // Apenas indica visualmente quantos resultados foram encontrados, sem preencher automaticamente
                if (produtosFiltrados.length === 1) {
                    buscaInput.style.background = "#fff9c4"; // Amarelo para indicar que h√° um resultado dispon√≠vel
                } else if (produtosFiltrados.length > 0) {
                    buscaInput.style.background = "#fff9c4"; // Amarelo claro para indicar m√∫ltiplos resultados
                } else {
                    buscaInput.style.background = "#ffebee"; // Vermelho claro para indicar nenhum resultado
                }
            }

            // Fun√ß√£o para verificar se o valor atual corresponde a uma op√ß√£o e preencher dados
            // Esta fun√ß√£o s√≥ deve ser chamada quando h√° certeza de sele√ß√£o (change, blur, Enter)
            function verificarEPreencherProduto(valor, forcarPreenchimento = false) {
                if (!valor || valor.trim() === "") {
                    return false;
                }

                const valorTrimmed = valor.trim();
                const valorLower = valorTrimmed.toLowerCase();

                // Primeiro, procura uma op√ß√£o que corresponda EXATAMENTE ao valor digitado/selecionado
                let selectedOption = Array.from(datalist.options).find(opt =>
                    opt.value === valorTrimmed || opt.value.toLowerCase() === valorLower
                );

                // Se n√£o encontrou correspond√™ncia exata, tenta encontrar por c√≥digo completo (formato "CODIGO - descri√ß√£o")
                if (!selectedOption) {
                    // Extrai o c√≥digo do in√≠cio do valor (formato: "CODIGO - descri√ß√£o")
                    const matchCodigo = valorTrimmed.match(/^([A-Z0-9]+)\s*-/i);
                    if (matchCodigo) {
                        const codigoBuscado = matchCodigo[1].toUpperCase();
                        selectedOption = Array.from(datalist.options).find(opt => {
                            const optCodigo = opt.value.match(/^([A-Z0-9]+)\s*-/i);
                            return optCodigo && optCodigo[1].toUpperCase() === codigoBuscado;
                        });
                    }
                }

                // Se encontrou uma op√ß√£o correspondente EXATA
                if (selectedOption) {
                    const idx = parseInt(selectedOption.getAttribute("data-index"));
                    if (!isNaN(idx) && idx >= 0 && idx < produtosCatalogo.length) {
                        hiddenIndex.value = idx;
                        preencherDadosProdutoPorIndex(div, idx);
                        buscaInput.style.background = "#e8f5e9";
                        // Garante que o valor do campo est√° no formato completo
                        const produto = produtosCatalogo[idx];
                        buscaInput.value = `${produto.codigo} - ${produto.descricao} (${produto.familia || 'N/A'})`;
                        return true;
                    }
                }

                // S√≥ busca no cat√°logo completo se for√ßar preenchimento (blur, Enter) ou se houver correspond√™ncia exata
                if (forcarPreenchimento) {
                    const produtoEncontrado = produtosCatalogo.find((p) => {
                        const codigo = String(p.codigo || '').toLowerCase();
                        const valorCompleto = `${p.codigo} - ${p.descricao} (${p.familia || 'N/A'})`.toLowerCase();

                        // Apenas correspond√™ncia exata ou c√≥digo completo
                        return valorCompleto === valorLower || codigo === valorLower;
                    });

                    if (produtoEncontrado) {
                        const idx = produtosCatalogo.indexOf(produtoEncontrado);
                        hiddenIndex.value = idx;
                        preencherDadosProdutoPorIndex(div, idx);
                        buscaInput.style.background = "#e8f5e9";
                        buscaInput.value = `${produtoEncontrado.codigo} - ${produtoEncontrado.descricao} (${produtoEncontrado.familia || 'N/A'})`;
                        return true;
                    }
                }

                return false;
            }

            // Listener para quando o usu√°rio digita - APENAS FILTRA, n√£o preenche
            buscaInput.addEventListener("input", function () {
                const valor = this.value.trim();
                // Apenas filtra a lista, n√£o preenche automaticamente
                filtrarProdutos(valor);
            });

            // Listener para quando o usu√°rio seleciona uma op√ß√£o do datalist (evento change)
            buscaInput.addEventListener("change", function () {
                const valor = this.value.trim();
                // Quando seleciona do datalist, preenche os dados
                verificarEPreencherProduto(valor, true);
            });

            // Listener adicional para quando o campo perde o foco (blur)
            buscaInput.addEventListener("blur", function () {
                const valor = this.value.trim();
                if (valor) {
                    // Tenta preencher apenas se houver correspond√™ncia exata
                    setTimeout(() => {
                        verificarEPreencherProduto(valor, true);
                    }, 150);
                }
            });

            // Listener para capturar quando pressiona Enter (seleciona op√ß√£o do datalist)
            buscaInput.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault(); // Previne submit se houver formul√°rio
                    const valor = this.value.trim();
                    if (valor) {
                        // Preenche quando pressiona Enter
                        setTimeout(() => {
                            verificarEPreencherProduto(valor, true);
                        }, 50);
                    }
                }
            });

            // Inicializa com todos os produtos vis√≠veis
            filtrarProdutos("");
        }

        function preencherDadosProdutoPorIndex(div, idx) {
            if (idx === "" || idx === null || idx === undefined || idx < 0 || idx >= produtosCatalogo.length) {
                div.querySelector(".produtoDescricao").value = "";
                div.querySelector(".produtoFamilia").value = "";
                div.querySelector(".produtoTipo").value = "";
                div.querySelector(".produtoPrecoUnit").value = "";
                div.querySelector(".produtoUnidade").value = "UN";
                div.querySelector(".produtoQuantidade").value = "1";
                div.querySelector(".produtoPrecoTotal").value = "";
                return;
            }

            const produto = produtosCatalogo[idx];
            div.querySelector(".produtoCodigo").value = produto.codigo;
            div.querySelector(".produtoDescricao").value = produto.descricao;
            div.querySelector(".produtoFamilia").value = produto.familia || "";
            div.querySelector(".produtoTipo").value = produto.tipo || "";
            div.querySelector(".produtoPrecoUnit").value = produto.preco.toFixed(2);
            div.querySelector(".produtoUnidade").value = produto.unidade;
            div.querySelector(".produtoQuantidade").value = "1";
            calcularTotalProduto(div);
        }

        function preencherDadosProduto(selectElement) {
            // Compatibilidade com c√≥digo antigo - agora usa o novo sistema
            const div = selectElement.closest(".produto-cadastrado");
            const idx = selectElement.value;
            preencherDadosProdutoPorIndex(div, idx);
        }

        function calcularTotalProduto(div) {
            const precoUnit = parseFloat(div.querySelector(".produtoPrecoUnit").value) || 0;
            const qtd = parseFloat(div.querySelector(".produtoQuantidade").value) || 0;
            const total = precoUnit * qtd;
            div.querySelector(".produtoPrecoTotal").value = total.toFixed(2);
        }

        function atualizarPRDNoCatalogo(div) {
            const codigo = div.querySelector(".produtoCodigo").value.trim();
            const descricao = div.querySelector(".produtoDescricao").value.trim();
            const familia = div.querySelector(".produtoFamilia").value.trim();
            const tipo = div.querySelector(".produtoTipo").value.trim();
            const unidade = div.querySelector(".produtoUnidade").value.trim();
            const precoUnitario = parseFloat(div.querySelector(".produtoPrecoUnit").value) || 0;

            if (!codigo) {
                alert("Por favor, preencha o c√≥digo do produto antes de atualizar.");
                return;
            }

            if (!codigo.startsWith("PRD")) {
                alert("Apenas produtos com c√≥digo PRD podem ser atualizados no cat√°logo.");
                return;
            }

            if (!confirm(`Tem certeza que deseja atualizar o PRD ${codigo} no cat√°logo?\n\nOs dados antigos ser√£o salvos em um log.`)) {
                return;
            }

            const dadosProduto = {
                codigo: codigo,
                descricao: descricao,
                familia: familia,
                tipo: tipo,
                unidade: unidade,
                preco: precoUnitario
            };

            google.script.run
                .withSuccessHandler(function (resultado) {
                    alert(`PRD ${codigo} atualizado com sucesso!\n\n${resultado.mensagem}`);
                    // Recarrega o cat√°logo de produtos para refletir as mudan√ßas
                    carregarProdutosCadastrados();
                })
                .withFailureHandler(function (err) {
                    alert("Erro ao atualizar PRD:\n" + (err?.message || JSON.stringify(err)));
                })
                .atualizarPRDNoCatalogo(dadosProduto);
        }

        function coletarProdutosCadastrados() {
            const produtos = [];
            document.querySelectorAll(".produto-cadastrado").forEach(div => {
                const codigo = div.querySelector(".produtoCodigo").value;
                if (!codigo) return; // pula se n√£o foi selecionado

                produtos.push({
                    codigo: codigo,
                    descricao: div.querySelector(".produtoDescricao").value,
                    familia: div.querySelector(".produtoFamilia").value,
                    tipo: div.querySelector(".produtoTipo").value,
                    unidade: div.querySelector(".produtoUnidade").value,
                    precoUnitario: parseFloat(div.querySelector(".produtoPrecoUnit").value) || 0,
                    quantidade: parseFloat(div.querySelector(".produtoQuantidade").value) || 0,
                    precoTotal: parseFloat(div.querySelector(".produtoPrecoTotal").value) || 0
                });
            });
            return produtos;
        }

        /* ---------- PROJETO / PASTA ---------- */
        // preserveIndice = true: n√£o altera o √≠ndice (ex.: ao carregar or√ßamento existente)
        function atualizarCamposProjeto(preserveIndice) {
            const data = document.getElementById("projetoData").value.trim();
            const iniciais = document.getElementById("projetoIniciais").value.trim();
            const indiceAtual = document.getElementById("projetoIndice").value.trim();

            // Ao carregar or√ßamento, apenas atualiza o campo Projeto (obsProjeto) sem alterar o √≠ndice
            if (preserveIndice === true && indiceAtual !== "") {
                const codigoProjeto = data + indiceAtual + iniciais;
                document.getElementById("obsProjeto").value = codigoProjeto;
                return;
            }

            // Se data e iniciais est√£o preenchidos, calcula o √≠ndice automaticamente (novo or√ßamento)
            if (data && iniciais && data.length === 6) {
                google.script.run
                    .withSuccessHandler(function (proximoIndice) {
                        document.getElementById("projetoIndice").value = proximoIndice || "a";
                        const indice = document.getElementById("projetoIndice").value;
                        const codigoProjeto = data + indice + iniciais;
                        document.getElementById("obsProjeto").value = codigoProjeto;
                    })
                    .withFailureHandler(function (err) {
                        document.getElementById("projetoIndice").value = "a";
                        const indice = document.getElementById("projetoIndice").value;
                        const codigoProjeto = data + indice + iniciais;
                        document.getElementById("obsProjeto").value = codigoProjeto;
                    })
                    .detectarProximoIndice(data, iniciais);
            } else {
                const indice = document.getElementById("projetoIndice").value || "a";
                const codigoProjeto = data + indice + iniciais;
                document.getElementById("obsProjeto").value = codigoProjeto;
            }
        }

        ["projetoData", "projetoIniciais"].forEach(id => {
            document.getElementById(id).addEventListener("input", atualizarCamposProjeto);
        });
        atualizarCamposProjeto();

        // Cria/garante a pasta do or√ßamento (inclusive para rascunhos) usando a mesma l√≥gica do PDF
        function criarPastaOrcamento() {
            const btn = event?.target || document.getElementById('btnCriarPasta');
            if (!btn) return;
            const originalText = btn.textContent;
            const originalDisabled = btn.disabled;

            // Valida√ß√£o
            const data = document.getElementById("projetoData").value.trim();
            const indice = document.getElementById("projetoIndice").value.trim();
            const iniciais = document.getElementById("projetoIniciais").value.trim();
            const codigoProjeto = data + indice + iniciais;
            const nomePastaCampo = document.getElementById("projetoPasta").value.trim();
            const descricao = document.getElementById("obsDescricao").value.trim();
            const nomePasta = nomePastaCampo || descricao;

            if (!data || !indice || !iniciais || !nomePasta) {
                alert("Preencha Data, √çndice, Iniciais e Nome/Descri√ß√£o da pasta antes de criar a pasta do or√ßamento.");
                return;
            }

            // Feedback visual: desabilita bot√£o e mostra loading
            btn.disabled = true;
            btn.textContent = "Criando pasta...";

            google.script.run
                .withSuccessHandler(function (info) {
                    btn.disabled = originalDisabled;
                    btn.textContent = originalText;
                    let msg = "Pasta do or√ßamento criada/encontrada com sucesso.";
                    if (info && info.pastaUrl) {
                        msg += "\n\nNome: " + (info.pastaNome || "") + "\nLink: " + info.pastaUrl;
                    }
                    alert(msg);
                })
                .withFailureHandler(function (err) {
                    btn.disabled = originalDisabled;
                    btn.textContent = originalText;
                    alert("Erro ao criar/obter pasta do or√ßamento:\n" + (err && err.message ? err.message : err));
                })
                .criarPastaOrcamento(codigoProjeto, nomePasta, data);
        }

        // Abre diretamente a pasta do or√ßamento no Drive (SEM criar - apenas busca pastas existentes)
        function abrirPastaOrcamento() {
            const btn = event?.target || document.getElementById('btnAbrirPasta');
            if (!btn) return;
            const originalText = btn.textContent;
            const originalDisabled = btn.disabled;

            // Valida√ß√£o
            const data = document.getElementById("projetoData").value.trim();
            const indice = document.getElementById("projetoIndice").value.trim();
            const iniciais = document.getElementById("projetoIniciais").value.trim();
            const codigoProjeto = data + indice + iniciais;

            if (!data || !indice || !iniciais) {
                alert("Preencha Data, √çndice e Iniciais antes de abrir a pasta do or√ßamento.");
                return;
            }

            // Feedback visual: desabilita bot√£o e mostra loading
            btn.disabled = true;
            btn.textContent = "Buscando pasta...";

            google.script.run
                .withSuccessHandler(function (info) {
                    btn.disabled = originalDisabled;
                    btn.textContent = originalText;
                    if (info && info.pastaUrl) {
                        window.open(info.pastaUrl, "_blank");
                    } else {
                        alert("Pasta encontrada, mas n√£o foi poss√≠vel obter o link.");
                    }
                })
                .withFailureHandler(function (err) {
                    btn.disabled = originalDisabled;
                    btn.textContent = originalText;
                    alert("Erro ao abrir pasta do or√ßamento:\n" + (err && err.message ? err.message : err) + 
                          "\n\nDica: Crie a pasta primeiro usando o bot√£o 'Criar/Confirmar Pasta do Or√ßamento'.");
                })
                .buscarPastaOrcamento(codigoProjeto, data);
        }

        /* ---------- CHAPAS / PE√áAS ---------- */
        let chapaCount = 0;

        function addChapa() {
            chapaCount++;
            const div = document.createElement("div");
            div.className = "chapa";
            div.id = "chapa" + chapaCount;
            div.innerHTML = `
    <div class="titulo">Dados da Chapa</div>

    <div class="row">
      <div class="col">
        <label>Material:</label>
        <select class="material">
          <option>A√áO CARBONO</option>
          <option>ALUM√çNIO</option>
          <option>INOX 200 OU 300</option>
          <option>INOX 400</option>
          <option>LAT√ÉO</option>
          <option>COBRE</option>
        </select>
      </div>
      <div class="col">
        <label>Comprimento (mm):</label>
        <input type="number" class="chapaComprimento">
      </div>
      <div class="col">
        <label>Largura (mm):</label>
        <input type="number" class="chapaLargura">
      </div>
      <div class="col">
        <label>Espessura (mm):</label>
        <input type="number" class="chapaEspessura">
      </div>
    </div>

<div style="margin-top:8px;" class="inline">
  <label>Conjunto de pe√ßas:</label><input type="checkbox" class="isConjunto">
  <div class="conjuntoFields hidden" style="margin-left:12px;">
    <label>Descri√ß√£o do conjunto:</label><input type="text" class="descricaoConjunto"><br>
    <label>C√≥digo do conjunto:</label><input type="text" class="codigoConjunto"><br>
    <label>Quantidade:</label><input type="number" class="quantidadeConjunto" value="1" min="1">
  </div>
</div>


    <div class="pecasContainer" style="margin-top:12px;"></div>

    <div class="controls">
      <button type="button" onclick="addPeca('${div.id}')">+ Adicionar Pe√ßa</button>
      <button type="button" class="secondary" onclick="removeElement('${div.id}')">Remover Chapa</button>
    </div>
  `;
            const container = document.getElementById("chapasContainer");
            if (container.firstChild) {
                container.insertBefore(div, container.firstChild);
            } else {
                if (container.firstChild) {
                container.insertBefore(div, container.firstChild);
            } else {
                container.appendChild(div);
            }
            }

            // toggle conjunto
            const isConjunto = div.querySelector(".isConjunto");
            const conjuntoFields = div.querySelector(".conjuntoFields");
            // ensure initial state
            isConjunto.checked = false;
            conjuntoFields.classList.add("hidden");
            isConjunto.addEventListener("change", () => {
                if (isConjunto.checked) conjuntoFields.classList.remove("hidden");
                else conjuntoFields.classList.add("hidden");
                div.querySelectorAll(".peca").forEach(p => {
                    togglePecaDescCod(p, isConjunto.checked);
                });
            });

            addPeca(div.id);
        }

        function togglePecaDescCod(pDiv, hide) {
            const desc = pDiv.querySelector(".descricao");
            const cod = pDiv.querySelector(".codigo");
            const lblDesc = pDiv.querySelector(".lblDescricao");
            const lblCod = pDiv.querySelector(".lblCodigo");
            if (!desc || !cod) return;
            desc.style.display = hide ? "none" : "inline-block";
            cod.style.display = hide ? "none" : "inline-block";
            if (lblDesc) lblDesc.style.display = hide ? "none" : "inline-block";
            if (lblCod) lblCod.style.display = hide ? "none" : "inline-block";
        }

        // add piece
        function addPeca(chapaId) {
            const chapaDiv = document.getElementById(chapaId);
            const container = chapaDiv.querySelector(".pecasContainer");
            const div = document.createElement("div");
            div.className = "peca";
            div.innerHTML = `
    <div class="titulo">Dados da Pe√ßa</div>

    <div class="row">
      <div class="col">
        <label class="lblDescricao">Descri√ß√£o:</label><input type="text" class="descricao">
      </div>
      <div class="col">
        <label class="lblCodigo">C√≥digo:</label><input type="text" class="codigo">
      </div>
      <div class="col">
        <label>Comprimento (mm):</label><input type="number" class="pecaComprimento">
      </div>
      <div class="col">
        <label>Largura (mm):</label><input type="number" class="pecaLargura">
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="col"><label>N¬∫ Pe√ßas Lote:</label><input type="number" class="numPecasLote"></div>
      <div class="col"><label>N¬∫ Pe√ßas/Chapa:</label><input type="number" class="numPecasChapa"></div>
    </div>

    <div style="margin-top:8px;" class="inline">
      <label>Pe√ßa possui corte:</label><input type="checkbox" class="temCorte">
      <div class="corteFields hidden" style="margin-left:12px;">
        <label>Tempo de Corte (s):</label><input type="number" class="tempoCorte"><br>
      </div>
    </div>

    <div style="margin-top:8px;" class="inline">
      <label>Pe√ßa possui dobra:</label><input type="checkbox" class="temDobra">
      <div class="dobraFields hidden" style="margin-left:12px;">
        <label>N¬∫ Dobras:</label><input type="number" class="numDobras"><br>
        <label>Tempo por dobra (s):</label><input type="number" class="tempoDobra">
        <label>Tempo de Setup (min): </label><input type="number" class="setupDobra">
      </div>
    </div>

    <div style="margin-top:8px;" class="inline">
      <label>Processos adicionais:</label><input type="checkbox" class="temProcessos">
      
      <div class="processosContainer hidden" style="margin-left:12px;">
        <div class="processosList"></div>
        <div style="margin-top:6px;">
          <button type="button" class="secondary btnAddProcess">+ Adicionar Processo</button>
        </div>
      </div>
    </div>

    <div class="controls" style="margin-top:8px;">
      <button type="button" onclick="removeElement(this.parentElement.parentElement)">Remover Pe√ßa</button>
    </div>
  `;
            if (container.firstChild) {
                container.insertBefore(div, container.firstChild);
            } else {
                container.appendChild(div);
            }

            // corte toggle
            const temCorte = div.querySelector(".temCorte");
            const corteFields = div.querySelector(".corteFields");
            temCorte.checked = false;
            corteFields.classList.add("hidden");
            temCorte.addEventListener("change", () => {
                if (temCorte.checked) corteFields.classList.remove("hidden");
                else corteFields.classList.add("hidden");
            });

            // dobra toggle
            const temDobra = div.querySelector(".temDobra");
            const dobraFields = div.querySelector(".dobraFields");
            temDobra.checked = false;
            dobraFields.classList.add("hidden");
            temDobra.addEventListener("change", () => {
                if (temDobra.checked) dobraFields.classList.remove("hidden");
                else dobraFields.classList.add("hidden");
            });

            // processos toggle & add
            const temProcessos = div.querySelector(".temProcessos");
            const processosContainer = div.querySelector(".processosContainer");
            const processosList = div.querySelector(".processosList");
            const btnAddProcess = div.querySelector(".btnAddProcess");
            temProcessos.checked = false;
            processosContainer.classList.add("hidden");
            temProcessos.addEventListener("change", () => {
                if (temProcessos.checked) processosContainer.classList.remove("hidden");
                else processosContainer.classList.add("hidden");
            });
            div.querySelector(".btnAddProcess").addEventListener("click", () => addProcesso(processosList));

            // if parent chapa has conjunto checked -> hide desc/cod
            const parentConjunto = chapaDiv.querySelector(".isConjunto");
            if (parentConjunto && parentConjunto.checked) {
                div.querySelector(".descricao").style.display = "none";
                div.querySelector(".codigo").style.display = "none";
                const lblD = div.querySelector(".lblDescricao");
                if (lblD) lblD.style.display = "none";
                const lblC = div.querySelector(".lblCodigo");
                if (lblC) lblC.style.display = "none";
            } else {
                // Auto-preenche o c√≥digo PRD se n√£o for conjunto
                const codigoInput = div.querySelector(".codigo");
                codigoInput.value = gerarCodigoPRDLocal();
            }
        }

        function addProcesso(listDiv) {
            const div = document.createElement("div");
            div.className = "processo";
            div.style.marginBottom = "8px";
            div.innerHTML = `
    <div class="row">
      <div class="col"><label>Descri√ß√£o:</label><input type="text" class="procDescricao"></div>
      <div class="col"><label>Tempo de setup (h):</label><input type="number" step="any" class="procSetup"></div>
      <div class="col"><label>Valor da hora:</label><input type="number" step="any" class="procValorHora"></div>
    </div>
    <div class="row" style="margin-top:8px;">
      <div class="col"><label>Horas:</label><input type="number" step="any" class="procHoras"></div>
      <div class="col"><label>Material:</label><input type="text" class="procMaterial"></div>
      <div class="col"><label>Quantidade (mat):</label><input type="number" step="any" class="procQtdMat"></div>
      <div class="col"><label>Valor venda (mat):</label><input type="number" step="any" class="procValorMat"></div>
    </div>
    <div style="margin-top:6px;">
      <button type="button" onclick="removeElement(this.parentElement.parentElement)">Remover Processo</button>
    </div>
  `;
            if (listDiv.firstChild) {
                listDiv.insertBefore(div, listDiv.firstChild);
            } else {
                listDiv.appendChild(div);
            }
        }

        function addProcessoPedido() {
            const container = document.getElementById("processosPedidoContainer");
            const div = document.createElement("div");
            div.className = "procPedido";
            div.style.border = "1px dashed #e0e6f0";
            div.style.padding = "10px";
            div.style.marginBottom = "8px";
            div.innerHTML = `
    <div class="row">
      <div class="col" style="flex-basis: 100%; margin-bottom:4px;">
        <label>Descri√ß√£o:</label>
        <input type="text" class="procPedidoDescricao" placeholder="Descri√ß√£o do processo" style="width: 100%;">
      </div>
      <div class="col"><label>Valor hora:</label><input type="number" step="any" class="procPedidoValorHora"></div>
      <div class="col"><label>Horas:</label><input type="number" step="any" class="procPedidoHoras"></div>
      <div class="col"><label>Material:</label><input type="text" class="procPedidoMaterial"></div>
      <div class="col"><label>Valor venda (mat):</label><input type="number" step="any" class="procPedidoValorMat"></div>
      <div class="col"><label>Quantidade (mat):</label><input type="number" step="any" class="procPedidoQtdMat"></div>
      <div class="col"><label>Valor fixo:</label><input type="number" step="any" class="procPedidoValorFixo"></div>
    </div>
    <div style="margin-top:6px;">
      <button type="button" onclick="removeElement(this.parentElement.parentElement)">Remover Processo</button>
    </div>
  `;
            if (container.firstChild) {
                container.insertBefore(div, container.firstChild);
            } else {
                container.appendChild(div);
            }
        }


        function removeElement(idOrElem) {
            const el = typeof idOrElem === "string" ? document.getElementById(idOrElem) : idOrElem;
            if (!el) return;

            if (el.classList && (el.classList.contains('peca') || el.classList.contains('processo') || el.classList.contains('chapa') || el.classList.contains('produto-cadastrado'))) {
                el.remove();
                return;
            }

            const peca = el.closest('.peca');
            if (peca && el !== peca) {
                el.remove();
                return;
            }

            el.remove();
        }

        /* ------------------------------------------------------------- */
        /* ---------- NOVAS FUN√á√ïES: RASCUNHO (SALVAR/CARREGAR) ---------- */
        /* ------------------------------------------------------------- */

        // Fun√ß√£o para coletar todos os dados do formul√°rio em um objeto JSON
        function coletarDadosFormulario() {
            const formData = {};

            // 1. Projeto
            formData.projeto = {
                data: document.getElementById("projetoData").value,
                indice: document.getElementById("projetoIndice").value,
                iniciais: document.getElementById("projetoIniciais").value,
                versao: "", // Vers√£o ser√° detectada automaticamente no backend
                pasta: document.getElementById("projetoPasta").value
            };

            // 2. Cliente
            formData.cliente = {
                select: document.getElementById("clienteBusca").value || "",
                nome: document.getElementById("clienteNome").value,
                cpf: document.getElementById("clienteCpf").value,
                endereco: document.getElementById("clienteEndereco").value,
                telefone: document.getElementById("clienteTelefone").value,
                email: document.getElementById("clienteEmail").value,
                responsavel: document.getElementById("clienteResponsavel").value,
                data: document.getElementById("clienteData").value
            };

            // 3. Chapas / Pe√ßas / Processos
            formData.chapas = [];
            document.querySelectorAll(".chapa").forEach(cDiv => {
                const chapa = {
                    material: cDiv.querySelector(".material")?.value || "",
                    comprimento: cDiv.querySelector(".chapaComprimento")?.value || "",
                    largura: cDiv.querySelector(".chapaLargura")?.value || "",
                    espessura: cDiv.querySelector(".chapaEspessura")?.value || "",
                    isConjunto: cDiv.querySelector(".isConjunto")?.checked || false,
                    descricaoConjunto: cDiv.querySelector(".descricaoConjunto")?.value || "",
                    codigoConjunto: cDiv.querySelector(".codigoConjunto")?.value || "",
                    quantidadeConjunto: cDiv.querySelector(".quantidadeConjunto")?.value || "1",
                    pecas: []
                };

                cDiv.querySelectorAll(".peca").forEach(pDiv => {
                    const peca = {
                        descricao: pDiv.querySelector(".descricao")?.value || "",
                        codigo: pDiv.querySelector(".codigo")?.value || "",
                        comprimento: pDiv.querySelector(".pecaComprimento")?.value || "",
                        largura: pDiv.querySelector(".pecaLargura")?.value || "",
                        numPecasLote: pDiv.querySelector(".numPecasLote")?.value || "",
                        numPecasChapa: pDiv.querySelector(".numPecasChapa")?.value || "",
                        // Corte
                        temCorte: pDiv.querySelector(".temCorte")?.checked || false,
                        tempoCorte: pDiv.querySelector(".tempoCorte")?.value || "",
                        // Dobra
                        temDobra: pDiv.querySelector(".temDobra")?.checked || false,
                        numDobras: pDiv.querySelector(".numDobras")?.value || "",
                        tempoDobra: pDiv.querySelector(".tempoDobra")?.value || "",
                        setupDobra: pDiv.querySelector(".setupDobra")?.value || "",
                        // Processos Adicionais
                        temProcessos: pDiv.querySelector(".temProcessos")?.checked || false,
                        processos: []
                    };

                    pDiv.querySelectorAll(".processo").forEach(procDiv => {
                        peca.processos.push({
                            descricao: procDiv.querySelector(".procDescricao")?.value || "",
                            setup: procDiv.querySelector(".procSetup")?.value || "",
                            valorHora: procDiv.querySelector(".procValorHora")?.value || "",
                            horas: procDiv.querySelector(".procHoras")?.value || "",
                            material: procDiv.querySelector(".procMaterial")?.value || "",
                            qtdMat: procDiv.querySelector(".procQtdMat")?.value || "",
                            valorMat: procDiv.querySelector(".procValorMat")?.value || ""
                        });
                    });

                    chapa.pecas.push(peca);
                });

                formData.chapas.push(chapa);
            });

            // 4. Processos do Pedido
            formData.processosPedido = [];
            document.querySelectorAll(".procPedido").forEach(procDiv => {
                formData.processosPedido.push({
                    descricao: procDiv.querySelector(".procPedidoDescricao")?.value || "",
                    valorHora: procDiv.querySelector(".procPedidoValorHora")?.value || "",
                    horas: procDiv.querySelector(".procPedidoHoras")?.value || "",
                    material: procDiv.querySelector(".procPedidoMaterial")?.value || "",
                    valorMat: procDiv.querySelector(".procPedidoValorMat")?.value || "",
                    qtdMat: procDiv.querySelector(".procPedidoQtdMat")?.value || "",
                    valorFixo: procDiv.querySelector(".procPedidoValorFixo")?.value || ""
                });
            });

            // 5. Outras Informa√ß√µes
            formData.observacoes = {
                faturamento: document.getElementById("obsFaturamento").value,
                prazo: document.getElementById("obsPrazo").value,
                vendedor: document.getElementById("obsVendedor").value,
                materialCond: document.getElementById("obsMaterialCond").value,
                pagamento: document.getElementById("obsPagamento").value,
                adicional: document.getElementById("obsAdicional").value,
                projeto: document.getElementById("obsProjeto").value,
                descricao: document.getElementById("obsDescricao").value
            };

            // 6. Produtos Cadastrados
            formData.produtosCadastrados = coletarProdutosCadastrados();

            return formData;
        }

        // Fun√ß√£o para preencher o formul√°rio a partir de um objeto JSON
        function preencherFormulario(data) {
            // Garante que sempre teremos um objeto, mesmo que venha null/undefined
            const safeData = data || {};

            // Cria objetos vazios padr√£o para evitar erros de "undefined"
            const projeto = safeData.projeto || {};
            const cliente = safeData.cliente || {};
            const observacoes = safeData.observacoes || {};
            const chapas = Array.isArray(safeData.chapas) ? safeData.chapas : [];
            const processosPedido = Array.isArray(safeData.processosPedido) ? safeData.processosPedido : [];

            // 1. Projeto
            document.getElementById("projetoData").value = projeto.data || "";
            document.getElementById("projetoIndice").value = projeto.indice || "";
            document.getElementById("projetoIniciais").value = projeto.iniciais || "";
            // Vers√£o n√£o √© mais edit√°vel pelo usu√°rio, ser√° detectada automaticamente
            document.getElementById("projetoPasta").value = projeto.pasta || "";
            // preserveIndice = true para n√£o sobrescrever o √≠ndice com o "pr√≥ximo" ao carregar or√ßamento
            atualizarCamposProjeto(true);

            // 2. Cliente
            const clienteBusca = document.getElementById("clienteBusca");
            if (cliente.select) {
                clienteBusca.value = cliente.select;
            } else if (cliente.nome) {
                clienteBusca.value = cliente.nome;
                // Tenta encontrar e preencher dados do cliente se existir na lista
                const clienteExistente = listaClientes.find(c => c.nome === cliente.nome);
                if (clienteExistente) {
                    preencherDadosCliente(clienteExistente);
                    clienteBusca.style.background = "#e8f5e9";
                }
            }
            document.getElementById("clienteNome").value = cliente.nome || "";
            document.getElementById("clienteCpf").value = cliente.cpf || "";
            document.getElementById("clienteEndereco").value = cliente.endereco || "";
            document.getElementById("clienteTelefone").value = cliente.telefone || "";
            document.getElementById("clienteEmail").value = cliente.email || "";
            document.getElementById("clienteResponsavel").value = cliente.responsavel || "";
            document.getElementById("clienteData").value = cliente.data || "";

            // 3. Outras Informa√ß√µes
            document.getElementById("obsFaturamento").value = observacoes.faturamento || "";
            document.getElementById("obsPrazo").value = observacoes.prazo || "";
            document.getElementById("obsVendedor").value = observacoes.vendedor || "";
            document.getElementById("obsMaterialCond").value = observacoes.materialCond || "";
            document.getElementById("obsPagamento").value = observacoes.pagamento || "";
            document.getElementById("obsAdicional").value = observacoes.adicional || "";
            document.getElementById("obsProjeto").value = observacoes.projeto || "";
            document.getElementById("obsDescricao").value = observacoes.descricao || "";

            // 4. Chapas / Pe√ßas / Processos (limpar e recriar)
            document.getElementById("chapasContainer").innerHTML = "";
            document.getElementById("processosPedidoContainer").innerHTML = "";

            chapas.forEach(chapaData => {
                addChapa();
                const cDiv = document.querySelector("#chapasContainer .chapa:last-child");

                cDiv.querySelector(".material").value = chapaData.material || "";
                cDiv.querySelector(".chapaComprimento").value = chapaData.comprimento || "";
                cDiv.querySelector(".chapaLargura").value = chapaData.largura || "";
                cDiv.querySelector(".chapaEspessura").value = chapaData.espessura || "";

                // Conjunto
                const isConjuntoInput = cDiv.querySelector(".isConjunto");
                isConjuntoInput.checked = chapaData.isConjunto;
                isConjuntoInput.dispatchEvent(new Event('change'));
                cDiv.querySelector(".descricaoConjunto").value = chapaData.descricaoConjunto || "";
                cDiv.querySelector(".codigoConjunto").value = chapaData.codigoConjunto || "";
                cDiv.querySelector(".quantidadeConjunto").value = chapaData.quantidadeConjunto || "1";

                // Remove a pe√ßa inicial vazia que addChapa cria
                cDiv.querySelector(".peca").remove();

                chapaData.pecas.forEach(pecaData => {
                    addPeca(cDiv.id);
                    const pDiv = cDiv.querySelector(".peca:last-child");

                    pDiv.querySelector(".descricao").value = pecaData.descricao || "";
                    pDiv.querySelector(".codigo").value = pecaData.codigo || "";
                    pDiv.querySelector(".pecaComprimento").value = pecaData.comprimento || "";
                    pDiv.querySelector(".pecaLargura").value = pecaData.largura || "";
                    pDiv.querySelector(".numPecasLote").value = pecaData.numPecasLote || "";
                    pDiv.querySelector(".numPecasChapa").value = pecaData.numPecasChapa || "";

                    // Corte
                    const temCorteInput = pDiv.querySelector(".temCorte");
                    temCorteInput.checked = pecaData.temCorte;
                    temCorteInput.dispatchEvent(new Event('change'));
                    pDiv.querySelector(".tempoCorte").value = pecaData.tempoCorte || "";

                    // Dobra
                    const temDobraInput = pDiv.querySelector(".temDobra");
                    temDobraInput.checked = pecaData.temDobra;
                    temDobraInput.dispatchEvent(new Event('change'));
                    pDiv.querySelector(".numDobras").value = pecaData.numDobras || "";
                    pDiv.querySelector(".tempoDobra").value = pecaData.tempoDobra || "";
                    pDiv.querySelector(".setupDobra").value = pecaData.setupDobra || "";

                    // Processos Adicionais
                    const temProcessosInput = pDiv.querySelector(".temProcessos");
                    temProcessosInput.checked = pecaData.temProcessos;
                    temProcessosInput.dispatchEvent(new Event('change'));

                    const processosList = pDiv.querySelector(".processosList");
                    pecaData.processos.forEach(procData => {
                        addProcesso(processosList);
                        const procDiv = processosList.querySelector(".processo:last-child");
                        procDiv.querySelector(".procDescricao").value = procData.descricao || "";
                        procDiv.querySelector(".procSetup").value = procData.setup || "";
                        procDiv.querySelector(".procValorHora").value = procData.valorHora || "";
                        procDiv.querySelector(".procHoras").value = procData.horas || "";
                        procDiv.querySelector(".procMaterial").value = procData.material || "";
                        procDiv.querySelector(".procQtdMat").value = procData.qtdMat || "";
                        procDiv.querySelector(".procValorMat").value = procData.valorMat || "";
                    });
                });
            });

            // 5. Processos do Pedido
            processosPedido.forEach(procData => {
                addProcessoPedido();
                const procDiv = document.querySelector("#processosPedidoContainer .procPedido:last-child");
                procDiv.querySelector(".procPedidoDescricao").value = procData.descricao || "";
                procDiv.querySelector(".procPedidoValorHora").value = procData.valorHora || "";
                procDiv.querySelector(".procPedidoHoras").value = procData.horas || "";
                procDiv.querySelector(".procPedidoMaterial").value = procData.material || "";
                procDiv.querySelector(".procPedidoValorMat").value = procData.valorMat || "";
                procDiv.querySelector(".procPedidoQtdMat").value = procData.qtdMat || "";
                procDiv.querySelector(".procPedidoValorFixo").value = procData.valorFixo || "";
            });

            // 6. Produtos Cadastrados
            document.getElementById("produtosCadastradosContainer").innerHTML = "";
            if (data.produtosCadastrados && data.produtosCadastrados.length > 0) {
                data.produtosCadastrados.forEach(prodData => {
                    addProdutoCadastrado();
                    const prodDiv = document.querySelector("#produtosCadastradosContainer .produto-cadastrado:last-child");

                    // Tenta encontrar o √≠ndice do produto no cat√°logo
                    const idx = produtosCatalogo.findIndex(p => p.codigo === prodData.codigo);
                    if (idx >= 0) {
                        // Preenche o campo de busca e o √≠ndice oculto
                        const buscaInput = prodDiv.querySelector(".produtoBusca");
                        const hiddenIndex = prodDiv.querySelector(".produtoSelectIndex");
                        const produto = produtosCatalogo[idx];
                        buscaInput.value = `${produto.codigo} - ${produto.descricao} (${produto.familia || 'N/A'})`;
                        hiddenIndex.value = idx;
                        buscaInput.style.background = "#e8f5e9";
                    }

                    // Preenche os campos diretamente (suporta produtos manuais e customizados)
                    prodDiv.querySelector(".produtoCodigo").value = prodData.codigo || "";
                    prodDiv.querySelector(".produtoDescricao").value = prodData.descricao || "";
                    prodDiv.querySelector(".produtoFamilia").value = prodData.familia || "";
                    prodDiv.querySelector(".produtoTipo").value = prodData.tipo || "";
                    prodDiv.querySelector(".produtoUnidade").value = prodData.unidade || "UN";
                    prodDiv.querySelector(".produtoPrecoUnit").value = prodData.precoUnitario || "";
                    prodDiv.querySelector(".produtoQuantidade").value = prodData.quantidade || 1;
                    calcularTotalProduto(prodDiv);
                });
            }

            // N√£o mostra mais o alert aqui, ser√° mostrado na fun√ß√£o carregarRascunhoSelecionado ap√≥s verificar o status
        }

        // Vari√°vel global para armazenar todos os or√ßamentos
        let listaOrcamentosCompleta = [];

        // Inicializa a lista de rascunhos no datalist (inclui rascunhos e projetos enviados)
        function carregarListaRascunhos() {
            google.script.run
                .withSuccessHandler(function (orcamentos) {
                    listaOrcamentosCompleta = orcamentos; // Armazena a lista completa
                    atualizarDatalistRascunhos("");
                })
                .getListaRascunhos(true); // true = incluir projetos enviados tamb√©m
        }

        // Atualiza o datalist com base no termo de busca
        function atualizarDatalistRascunhos(termo) {
            const datalist = document.getElementById("rascunhosList");
            const termoLower = termo ? termo.toLowerCase().trim() : "";

            if (!termoLower) {
                // Se n√£o h√° termo, mostra todos os or√ßamentos
                datalist.innerHTML = listaOrcamentosCompleta.map(r =>
                    `<option value="${r.nome}" data-key="${r.key}">${r.nome}</option>`
                ).join('');
                return;
            }

            // Filtra or√ßamentos que correspondem ao termo de busca
            const orcamentosFiltrados = listaOrcamentosCompleta.filter(r => {
                const nomeLower = r.nome.toLowerCase();
                return nomeLower.includes(termoLower);
            });

            // Atualiza o datalist com os resultados filtrados
            datalist.innerHTML = orcamentosFiltrados.map(r =>
                `<option value="${r.nome}" data-key="${r.key}">${r.nome}</option>`
            ).join('');

            // Atualiza visualmente o campo de busca
            const buscaInput = document.getElementById("rascunhoBusca");
            if (orcamentosFiltrados.length === 0) {
                buscaInput.style.background = "#ffebee"; // Vermelho claro para indicar nenhum resultado
            } else if (orcamentosFiltrados.length === 1 && orcamentosFiltrados[0].nome.toLowerCase() === termoLower) {
                buscaInput.style.background = "#e8f5e9"; // Verde claro para indicar correspond√™ncia exata
            } else {
                buscaInput.style.background = "#fff9c4"; // Amarelo claro para indicar m√∫ltiplos resultados
            }
        }

        // Fun√ß√£o auxiliar para limpar o estado de rascunho carregado
        function limparEstadoRascunho() {
            linhaOrcamentoCarregado = null;
            document.getElementById("btnAtualizarRascunho").style.display = "none";
            document.getElementById("rascunhoBusca").value = "";
            document.getElementById("rascunhoSelectKey").value = "";
            atualizarDatalistRascunhos(""); // Reseta o datalist
        }

        // Fun√ß√£o de salvar rascunho (chama o Apps Script)
        function salvarRascunho() {
            const nomeRascunho = prompt("Digite um nome para este rascunho (ex: CORTE DE TUBOS 7mm JOALMI):");
            if (!nomeRascunho) return;

            const btn = document.querySelector('button[onclick="salvarRascunho()"]');
            if (!btn) return;
            const originalText = btn.textContent;
            const originalDisabled = btn.disabled;

            // Feedback visual: desabilita bot√£o e mostra loading
            btn.disabled = true;
            btn.textContent = "Salvando rascunho...";

            const dados = coletarDadosFormulario();
            google.script.run
                .withSuccessHandler(function () {
                    btn.disabled = originalDisabled;
                    btn.textContent = originalText;
                    alert(`Rascunho "${nomeRascunho}" salvo com sucesso!`);
                    limparEstadoRascunho(); // Limpa a refer√™ncia ao salvar novo rascunho
                    carregarListaRascunhos(); // Atualiza a lista
                })
                .withFailureHandler(function (err) {
                    btn.disabled = originalDisabled;
                    btn.textContent = originalText;
                    alert("Erro ao salvar rascunho:\n" + err.message);
                })
                .salvarRascunho(nomeRascunho, dados);
        }

        // Vari√°vel global para armazenar a linha/key do or√ßamento carregado
        let linhaOrcamentoCarregado = null;

        // Fun√ß√£o de carregar or√ßamento (rascunho ou enviado) - chama o Apps Script
        function carregarRascunhoSelecionado() {
            const buscaInput = document.getElementById("rascunhoBusca");
            const hiddenKey = document.getElementById("rascunhoSelectKey");
            const valorBusca = buscaInput.value.trim();

            // Tenta encontrar a chave do or√ßamento selecionado
            let key = hiddenKey.value;

            // Se n√£o tem chave no hidden, tenta encontrar pelo nome digitado
            if (!key && valorBusca) {
                const orcamentoEncontrado = listaOrcamentosCompleta.find(r => 
                    r.nome.toLowerCase() === valorBusca.toLowerCase()
                );
                if (orcamentoEncontrado) {
                    key = orcamentoEncontrado.key;
                }
            }

            if (!key) {
                alert("Selecione um or√ßamento da lista para carregar.");
                return;
            }

            const btn = document.getElementById("btnCarregarRascunho");
            const originalText = btn ? btn.textContent : "";
            const originalDisabled = btn ? btn.disabled : false;

            // Feedback visual: desabilita bot√£o e mostra loading
            if (btn) {
                btn.disabled = true;
                btn.textContent = "Carregando...";
            }

            google.script.run
                .withSuccessHandler(function (dados) {
                    if (btn) {
                        btn.disabled = originalDisabled;
                        btn.textContent = originalText;
                    }
                    // Mesmo que o backend retorne null/undefined, garantimos um objeto vazio
                    const dadosValidos = dados || {};

                    linhaOrcamentoCarregado = key; // Armazena a linha/key do or√ßamento carregado
                    preencherFormulario(dadosValidos);
                    
                    // Mostra o bot√£o "Atualizar dados" para qualquer or√ßamento carregado (rascunho, enviado ou convertido em pedido)
                    const btnAtualizar = document.getElementById("btnAtualizarRascunho");
                    btnAtualizar.style.display = "inline-block";
                    
                    alert("Or√ßamento carregado com sucesso!");
                })
                .withFailureHandler(function (err) {
                    if (btn) {
                        btn.disabled = originalDisabled;
                        btn.textContent = originalText;
                    }
                    alert("Erro ao carregar or√ßamento:\n" + err.message);
                    linhaOrcamentoCarregado = null;
                    document.getElementById("btnAtualizarRascunho").style.display = "none";
                })
                .carregarRascunho(key);
        }

        // Fun√ß√£o para atualizar dados do or√ßamento carregado (rascunho, enviado ou convertido em pedido)
        function atualizarRascunhoSelecionado() {
            if (!linhaOrcamentoCarregado) {
                alert("Nenhum or√ßamento carregado para atualizar.");
                return;
            }

            const btn = document.getElementById("btnAtualizarRascunho");
            const originalText = btn.textContent;
            const originalDisabled = btn.disabled;

            btn.disabled = true;
            btn.textContent = "Atualizando...";

            const dados = coletarDadosFormulario();
            
            google.script.run
                .withSuccessHandler(function () {
                    btn.disabled = originalDisabled;
                    btn.textContent = originalText;
                    alert("Dados atualizados com sucesso!");
                    carregarListaRascunhos();
                })
                .withFailureHandler(function (err) {
                    btn.disabled = originalDisabled;
                    btn.textContent = originalText;
                    alert("Erro ao atualizar:\n" + err.message);
                })
                .atualizarRascunho(linhaOrcamentoCarregado, dados);
        }

        // Salva o formul√°rio diretamente como pedido (sem passar por or√ßamento enviado)
        function salvarComoPedido() {
            const dados = coletarDadosFormulario();
            const codigoProjeto = (dados.projeto.data || "") + (dados.projeto.indice || "") + (dados.projeto.iniciais || "");
            if (!codigoProjeto || codigoProjeto.length < 8) {
                alert("Preencha Projeto / Pasta (Data, √çndice e Iniciais) antes de salvar como pedido.");
                return;
            }
            if (!dados.cliente || !dados.cliente.nome) {
                alert("Preencha o cliente antes de salvar como pedido.");
                return;
            }
            if (!confirm("Salvar este projeto diretamente como PEDIDO?\n\nO projeto ser√° registrado j√° como \"Convertido em Pedido\" (sem gerar PDF de or√ßamento).")) {
                return;
            }

            const btn = document.querySelector('button[onclick="salvarComoPedido()"]');
            const originalText = btn ? btn.textContent : "";
            if (btn) {
                btn.disabled = true;
                btn.textContent = "Salvando...";
            }

            google.script.run
                .withSuccessHandler(function () {
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                    alert("Pedido registrado com sucesso!");
                    limparEstadoRascunho();
                    carregarListaRascunhos();
                })
                .withFailureHandler(function (err) {
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                    alert("Erro ao salvar como pedido:\n" + (err?.message || err));
                })
                .salvarComoPedido(dados);
        }

        // Fun√ß√£o de deletar rascunho (chama o Apps Script)
        function deletarRascunhoSelecionado() {
            const buscaInput = document.getElementById("rascunhoBusca");
            const hiddenKey = document.getElementById("rascunhoSelectKey");
            const valorBusca = buscaInput.value.trim();

            // Tenta encontrar a chave do or√ßamento selecionado
            let key = hiddenKey.value;
            let nome = "";

            // Se n√£o tem chave no hidden, tenta encontrar pelo nome digitado
            if (!key && valorBusca) {
                const orcamentoEncontrado = listaOrcamentosCompleta.find(r => 
                    r.nome.toLowerCase() === valorBusca.toLowerCase()
                );
                if (orcamentoEncontrado) {
                    key = orcamentoEncontrado.key;
                    nome = orcamentoEncontrado.nome;
                }
            } else if (key) {
                const orcamento = listaOrcamentosCompleta.find(r => r.key === key);
                nome = orcamento ? orcamento.nome : valorBusca;
            }

            if (!key) {
                alert("Selecione um or√ßamento da lista para deletar.");
                return;
            }

            // ALTERADO: Permite deletar qualquer or√ßamento com confirma√ß√£o extra
            let mensagemConfirmacao = `Tem certeza que deseja DELETAR "${nome}"?`;
            if (nome && nome.includes("[ENVIADO]")) {
                mensagemConfirmacao = `‚ö†Ô∏è ATEN√á√ÉO: Voc√™ est√° prestes a deletar um or√ßamento J√Å ENVIADO!\n\n"${nome}"\n\nEsta a√ß√£o √© IRREVERS√çVEL e pode afetar registros importantes.\n\nTem CERTEZA ABSOLUTA que deseja continuar?`;
            } else {
                mensagemConfirmacao += " Esta a√ß√£o √© irrevers√≠vel.";
            }

            if (!confirm(mensagemConfirmacao)) return;

            google.script.run
                .withSuccessHandler(function () {
                    alert(`Or√ßamento "${nome}" deletado com sucesso.`);
                    carregarListaRascunhos();
                })
                .withFailureHandler(function (err) {
                    alert("Erro ao deletar:\n" + err.message);
                })
                .deletarRascunho(key);
        }

        /* ------------------------------------------------------------- */
        /* ---------- FIM DAS NOVAS FUN√á√ïES ----------------------------- */
        /* ------------------------------------------------------------- */

        /* ---------- CALCULAR E CHAMAR SERVER (mantido) ---------- */
        function formatarDataBrasil(dataIso) {
            const d = new Date(dataIso);
            const dia = String(d.getDate()).padStart(2, '0');
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const ano = d.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }

        function calcular() {
            const btn = document.getElementById("btnGerar");
            btn.disabled = true;
            btn.textContent = "Gerando PDF...";

            const chapas = [];

            // --- percorre todas as chapas e pe√ßas (usando a l√≥gica do coletarDadosFormulario) ---
            const dadosColetados = coletarDadosFormulario();

            // Refaz o c√°lculo com os dados brutos coletados
            dadosColetados.chapas.forEach(chapaData => {
                const chapa = {
                    material: chapaData.material,
                    comprimento: parseFloat(chapaData.comprimento) || 0,
                    largura: parseFloat(chapaData.largura) || 0,
                    espessura: parseFloat(chapaData.espessura) || 0,
                    isConjunto: chapaData.isConjunto,
                    descricaoConjunto: chapaData.descricaoConjunto,
                    codigoConjunto: chapaData.codigoConjunto,
                    quantidadeConjunto: parseInt(chapaData.quantidadeConjunto) || 1,
                    pecas: []
                };

                chapaData.pecas.forEach(pecaData => {
                    let somaProcessos = 0;
                    let tempoProc = 0;
                    const processos = [];

                    pecaData.processos.forEach(procData => {
                        const descproc = procData.descricao || "";
                        const tempoSetup = parseFloat(procData.setup) || 0;
                        const valorHora = parseFloat(procData.valorHora) || 0;
                        const horas = parseFloat(procData.horas) || 0;
                        const qtdMat = parseFloat(procData.qtdMat) || 0;
                        const valorMat = parseFloat(procData.valorMat) || 0;
                        const precoProc = (tempoSetup + horas) * valorHora + (qtdMat * valorMat);
                        const tempoadc = (tempoSetup + horas);
                        tempoProc += tempoadc;
                        somaProcessos += precoProc;

                        processos.push({
                            descproc,
                            tempoSetup,
                            valorHora,
                            horas,
                            material: procData.material,
                            qtdMat,
                            valorMat,
                            precoProc
                        });
                    });

                    const numPecasLote = parseInt(pecaData.numPecasLote) || 1;

                    const peca = {
                        descricao: pecaData.descricao,
                        codigo: pecaData.codigo,
                        comprimento: parseFloat(pecaData.comprimento) || 0,
                        largura: parseFloat(pecaData.largura) || 0,
                        numPecasLote,
                        numPecasChapa: parseInt(pecaData.numPecasChapa) || 0,
                        tempoCorte: pecaData.temCorte ? parseInt(pecaData.tempoCorte) || 0 : 0,
                        numDobras: pecaData.temDobra ? parseInt(pecaData.numDobras) || 0 : 0,
                        tempoDobra: pecaData.temDobra ? parseFloat(pecaData.tempoDobra) || 0 : 0,
                        setupDobra: pecaData.temDobra ? parseFloat(pecaData.setupDobra) || 0 : 0,
                        tempoTotal: tempoProc,
                        adicionaisTotal: somaProcessos,
                        processos,
                        precoUnitario: somaProcessos / numPecasLote,
                        precoTotal: somaProcessos
                    };

                    chapa.pecas.push(peca);
                });

                chapas.push(chapa);
            });


            // --- PROCESSOS ADICIONAIS DO PEDIDO ---
            let somaProcessosPedido = 0;
            const processosPedidoDescricoes = [];
            dadosColetados.processosPedido.forEach(procData => {
                const valorHora = parseFloat(procData.valorHora) || 0;
                const horas = parseFloat(procData.horas) || 0;
                const valorMat = parseFloat(procData.valorMat) || 0;
                const qtdMat = parseFloat(procData.qtdMat) || 0;
                const valorFixo = parseFloat(procData.valorFixo) || 0;
                somaProcessosPedido += valorHora * horas + valorMat * qtdMat + valorFixo;
                if (procData.descricao) {
                    processosPedidoDescricoes.push(procData.descricao);
                }
            });

            const valorTotalOrcamento = chapas.reduce((acc, ch) => {
                return acc + ch.pecas.reduce((sum, p) => sum + p.precoTotal, 0);
            }, 0) + somaProcessosPedido;

            // --- CLIENTE ---
            const cliente = {
                nome: dadosColetados.cliente.nome,
                cpf: dadosColetados.cliente.cpf,
                endereco: dadosColetados.cliente.endereco,
                telefone: dadosColetados.cliente.telefone,
                email: dadosColetados.cliente.email,
                responsavel: dadosColetados.cliente.responsavel,
                dataCliente: formatarDataBrasil(dadosColetados.cliente.data)
            };

            const data = dadosColetados.projeto.data;
            const indice = dadosColetados.projeto.indice;
            const iniciais = dadosColetados.projeto.iniciais;
            const codigoProjeto = data + indice + iniciais;
            const nomePasta = dadosColetados.projeto.pasta;
            // Vers√£o ser√° detectada automaticamente pelo backend baseada nos arquivos existentes
            const versao = "";

            const observacoes = {
                projeto: codigoProjeto,
                descricao: dadosColetados.observacoes.descricao,  // Adicionado campo descri√ß√£o
                prazo: dadosColetados.observacoes.prazo,  // Adicionado campo prazo
                faturamento: dadosColetados.observacoes.faturamento,
                vendedor: dadosColetados.observacoes.vendedor,
                materialCond: dadosColetados.observacoes.materialCond,
                pagamento: dadosColetados.observacoes.pagamento,
                adicional: dadosColetados.observacoes.adicional
            };

            // --- salvar cliente novo ---
            if (cliente.nome && !listaClientes.find(c => c.nome === cliente.nome)) {
                google.script.run.salvarClienteSeNovo(cliente);
            }

            // Cria a descri√ß√£o do(s) processo(s) do pedido
            let descricaoProcessosPedido = processosPedidoDescricoes.join(" / ");

            // --- coletar produtos cadastrados ---
            const produtosCadastrados = coletarProdutosCadastrados();

            // --- coletar TODOS os dados do formul√°rio para salvar junto com o or√ßamento ---
            const dadosFormularioCompleto = coletarDadosFormulario();

            // NOVO: Preparar informa√ß√µes de pagamento para gerar tabela de parcelas
            const infoPagamento = {
                texto: dadosColetados.observacoes.pagamento || "",
                valorTotal: valorTotalOrcamento
            };

            // --- gerar PDF ---
            google.script.run
                .withSuccessHandler(function (pdf) {
                    // mostra alert com link
                    alert("PDF gerado com sucesso!\n\nClique no link para abrir:\n" + pdf.url);

                    // abre o PDF em nova aba automaticamente
                    window.open(pdf.url, "_blank");

                    // Limpa a refer√™ncia ao or√ßamento carregado ap√≥s calcular (status mudou para "Enviado")
                    limparEstadoRascunho();

                    // Atualiza lista de rascunhos para refletir a mudan√ßa de status
                    carregarListaRascunhos();

                    btn.disabled = false;
                    btn.textContent = "Calcular Or√ßamento e Gerar PDF";
                })
                .withFailureHandler(function (err) {
                    alert("Erro ao gerar PDF:\n" + (err?.message || JSON.stringify(err)));
                    btn.disabled = false;
                    btn.textContent = "Calcular Or√ßamento e Gerar PDF";
                })
                .gerarPdfOrcamento(chapas, cliente, observacoes, codigoProjeto, nomePasta, data, versao, somaProcessosPedido, descricaoProcessosPedido, produtosCadastrados, dadosFormularioCompleto, infoPagamento);

        }
        function voltarPagina() {
            if (!token) {
                alert("Token n√£o encontrado ‚Äî recarregue a p√°gina.");
                return;
            }
            const baseUrl = "https://script.google.com/macros/s/AKfycbyqo2sqE_x5VhtQPInTBS4XO78vk-S0Ec2LbgDtbUYVyX98oOA_oh4VRMdrmk8DBWvx6g/exec";
            window.location.href = `${baseUrl}?page=dashboard&token=${token}`;
        }

        // ---------- INICIAL (Alterado para incluir carregamento de rascunhos) ----------
        // Aguarda o DOM estar pronto antes de adicionar event listeners
        document.addEventListener("DOMContentLoaded", function() {
            inicializarBuscaOrcamentos();
        });
        
        // Se o DOM j√° estiver carregado, inicializa imediatamente
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", inicializarBuscaOrcamentos);
        } else {
            inicializarBuscaOrcamentos();
        }

        function inicializarBuscaOrcamentos() {
            // Event listeners para o campo de busca de or√ßamentos
            const rascunhoBuscaInput = document.getElementById("rascunhoBusca");
            const rascunhosDatalist = document.getElementById("rascunhosList");
            const rascunhoSelectKey = document.getElementById("rascunhoSelectKey");

            if (!rascunhoBuscaInput || !rascunhosDatalist || !rascunhoSelectKey) {
                console.error("Elementos de busca de or√ßamentos n√£o encontrados");
                return;
            }

            // Listener para quando o usu√°rio digita
            rascunhoBuscaInput.addEventListener("input", function () {
                atualizarDatalistRascunhos(this.value);
                rascunhoSelectKey.value = ""; // Limpa a chave quando o usu√°rio digita
            });

            // Listener para quando o usu√°rio seleciona uma op√ß√£o do datalist
            rascunhoBuscaInput.addEventListener("change", function () {
                const valor = this.value.trim();
                if (!valor) {
                    rascunhoSelectKey.value = "";
                    this.style.background = "";
                    return;
                }

                // Procura a op√ß√£o correspondente no datalist
                const selectedOption = Array.from(rascunhosDatalist.options).find(opt =>
                    opt.value === valor || opt.value.toLowerCase() === valor.toLowerCase()
                );

                if (selectedOption) {
                    const key = selectedOption.getAttribute("data-key");
                    if (key) {
                        rascunhoSelectKey.value = key;
                        this.style.background = "#e8f5e9"; // Verde claro para indicar sele√ß√£o v√°lida
                    }
                } else {
                    // Tenta encontrar na lista completa
                    const orcamentoEncontrado = listaOrcamentosCompleta.find(r =>
                        r.nome.toLowerCase() === valor.toLowerCase()
                    );
                    if (orcamentoEncontrado) {
                        rascunhoSelectKey.value = orcamentoEncontrado.key;
                        this.style.background = "#e8f5e9";
                    } else {
                        rascunhoSelectKey.value = "";
                        this.style.background = "#ffebee"; // Vermelho claro para indicar sele√ß√£o inv√°lida
                    }
                }
            });

            // Listener para quando o campo perde o foco (blur)
            rascunhoBuscaInput.addEventListener("blur", function () {
                const valor = this.value.trim();
                if (valor && !rascunhoSelectKey.value) {
                    // Tenta encontrar correspond√™ncia exata
                    const orcamentoEncontrado = listaOrcamentosCompleta.find(r =>
                        r.nome.toLowerCase() === valor.toLowerCase()
                    );
                    if (orcamentoEncontrado) {
                        rascunhoSelectKey.value = orcamentoEncontrado.key;
                        this.value = orcamentoEncontrado.nome; // Garante que o nome est√° completo
                        this.style.background = "#e8f5e9";
                    }
                }
            });

            // Listener para capturar quando pressiona Enter (seleciona op√ß√£o do datalist)
            rascunhoBuscaInput.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault(); // Previne submit se houver formul√°rio
                    const valor = this.value.trim();
                    if (valor) {
                        // Tenta encontrar correspond√™ncia exata
                        setTimeout(() => {
                            const orcamentoEncontrado = listaOrcamentosCompleta.find(r =>
                                r.nome.toLowerCase() === valor.toLowerCase()
                            );
                            if (orcamentoEncontrado) {
                                rascunhoSelectKey.value = orcamentoEncontrado.key;
                                this.value = orcamentoEncontrado.nome;
                                this.style.background = "#e8f5e9";
                            }
                        }, 50);
                    }
                }
            });
        }

        carregarListaRascunhos(); // Carrega a lista de rascunhos salvos

        /* ========================================================= */
        /* ========== PREVIEW EM TEMPO REAL DO OR√áAMENTO ========== */
        /* ========================================================= */

        // Fun√ß√£o de debounce para evitar chamadas excessivas ao servidor
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Fun√ß√£o para coletar apenas as chapas do formul√°rio
        function coletarChapas() {
            const chapas = [];
            document.querySelectorAll(".chapa").forEach(cDiv => {
                const chapa = {
                    material: cDiv.querySelector(".material")?.value || "",
                    comprimento: parseFloat(cDiv.querySelector(".chapaComprimento")?.value) || 0,
                    largura: parseFloat(cDiv.querySelector(".chapaLargura")?.value) || 0,
                    espessura: parseFloat(cDiv.querySelector(".chapaEspessura")?.value) || 0,
                    isConjunto: cDiv.querySelector(".isConjunto")?.checked || false,
                    descricaoConjunto: cDiv.querySelector(".descricaoConjunto")?.value || "",
                    codigoConjunto: cDiv.querySelector(".codigoConjunto")?.value || "",
                    quantidadeConjunto: parseInt(cDiv.querySelector(".quantidadeConjunto")?.value) || 1,
                    pecas: []
                };

                cDiv.querySelectorAll(".peca").forEach(pDiv => {
                    const peca = {
                        descricao: pDiv.querySelector(".descricao")?.value || "",
                        codigo: pDiv.querySelector(".codigo")?.value || "",
                        comprimento: parseFloat(pDiv.querySelector(".pecaComprimento")?.value) || 0,
                        largura: parseFloat(pDiv.querySelector(".pecaLargura")?.value) || 0,
                        numPecasLote: parseInt(pDiv.querySelector(".numPecasLote")?.value) || 0,
                        numPecasChapa: parseInt(pDiv.querySelector(".numPecasChapa")?.value) || 0,
                        tempoCorte: pDiv.querySelector(".temCorte")?.checked ? (parseInt(pDiv.querySelector(".tempoCorte")?.value) || 0) : 0,
                        numDobras: pDiv.querySelector(".temDobra")?.checked ? (parseInt(pDiv.querySelector(".numDobras")?.value) || 0) : 0,
                        tempoDobra: pDiv.querySelector(".temDobra")?.checked ? (parseFloat(pDiv.querySelector(".tempoDobra")?.value) || 0) : 0,
                        setupDobra: pDiv.querySelector(".temDobra")?.checked ? (parseFloat(pDiv.querySelector(".setupDobra")?.value) || 0) : 0,
                        processos: [],
                        adicionaisTotal: 0,
                        tempoTotal: 0
                    };

                    // Coleta processos adicionais da pe√ßa
                    if (pDiv.querySelector(".temProcessos")?.checked) {
                        pDiv.querySelectorAll(".processo").forEach(procDiv => {
                            const tempoSetup = parseFloat(procDiv.querySelector(".procSetup")?.value) || 0;
                            const valorHora = parseFloat(procDiv.querySelector(".procValorHora")?.value) || 0;
                            const horas = parseFloat(procDiv.querySelector(".procHoras")?.value) || 0;
                            const qtdMat = parseFloat(procDiv.querySelector(".procQtdMat")?.value) || 0;
                            const valorMat = parseFloat(procDiv.querySelector(".procValorMat")?.value) || 0;
                            const precoProc = (tempoSetup + horas) * valorHora + (qtdMat * valorMat);
                            peca.adicionaisTotal += precoProc;
                            peca.tempoTotal += (tempoSetup + horas);
                        });
                    }

                    chapa.pecas.push(peca);
                });

                if (chapa.pecas.length > 0) {
                    chapas.push(chapa);
                }
            });
            return chapas;
        }

        // Fun√ß√£o para coletar processos do pedido
        function coletarProcessosPedido() {
            const processos = [];
            document.querySelectorAll(".procPedido").forEach(procDiv => {
                processos.push({
                    descricao: procDiv.querySelector(".procPedidoDescricao")?.value || "",
                    valorHora: parseFloat(procDiv.querySelector(".procPedidoValorHora")?.value) || 0,
                    horas: parseFloat(procDiv.querySelector(".procPedidoHoras")?.value) || 0,
                    material: procDiv.querySelector(".procPedidoMaterial")?.value || "",
                    valorMat: parseFloat(procDiv.querySelector(".procPedidoValorMat")?.value) || 0,
                    qtdMat: parseFloat(procDiv.querySelector(".procPedidoQtdMat")?.value) || 0,
                    valorFixo: parseFloat(procDiv.querySelector(".procPedidoValorFixo")?.value) || 0
                });
            });
            return processos;
        }

        // Fun√ß√£o para formatar n√∫mero em reais
        function formatarReais(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        }

        // Fun√ß√£o para atualizar o preview
        function atualizarPreview() {
            try {
                // Coleta dados do formul√°rio
                const dados = {
                    chapas: coletarChapas(),
                    produtosCadastrados: coletarProdutosCadastrados(),
                    processosPedido: coletarProcessosPedido()
                };

                // Verifica se h√° dados para calcular
                const temDados = dados.chapas.length > 0 || dados.produtosCadastrados.length > 0 || dados.processosPedido.length > 0;
                
                if (!temDados) {
                    document.getElementById("previewStatus").textContent = "Preencha os dados para ver o preview";
                    document.getElementById("previewTotal").textContent = "R$ 0,00";
                    document.getElementById("previewDetalhamento").innerHTML = "";
                    return;
                }

                // Mostra loading
                document.getElementById("previewLoading").classList.remove("hidden");
                document.getElementById("previewStatus").textContent = "Calculando...";

                // Chama o servidor para calcular
                google.script.run
                    .withSuccessHandler(function(resultado) {
                        // Esconde loading
                        document.getElementById("previewLoading").classList.add("hidden");
                        
                        if (resultado.erro) {
                            document.getElementById("previewStatus").textContent = "Erro ao calcular: " + resultado.erro;
                            return;
                        }

                        // Atualiza status
                        const agora = new Date();
                        document.getElementById("previewStatus").textContent = "Atualizado √†s " + agora.toLocaleTimeString('pt-BR');
                        
                        // Atualiza total
                        document.getElementById("previewTotal").textContent = formatarReais(resultado.total);

                        // Atualiza detalhamento
                        let detalhamentoHtml = "";
                        
                        // Agrupa por tipo
                        const produtos = resultado.detalhamento.filter(d => d.tipo === 'produto');
                        const pecas = resultado.detalhamento.filter(d => d.tipo === 'peca');
                        const processos = resultado.detalhamento.filter(d => d.tipo === 'processo');

                        if (produtos.length > 0) {
                            detalhamentoHtml += '<div style="margin-bottom:12px;"><strong>üì¶ Produtos Cadastrados:</strong><br>';
                            produtos.forEach(p => {
                                detalhamentoHtml += `&nbsp;&nbsp;‚Ä¢ ${p.descricao} (${p.quantidade}x) - ${formatarReais(p.precoTotal)}<br>`;
                            });
                            detalhamentoHtml += '</div>';
                        }

                        if (pecas.length > 0) {
                            detalhamentoHtml += '<div style="margin-bottom:12px;"><strong>üîß Pe√ßas/Chapas:</strong><br>';
                            pecas.forEach(p => {
                                detalhamentoHtml += `&nbsp;&nbsp;‚Ä¢ ${p.descricao || p.codigo} (${p.quantidade}x) - ${formatarReais(p.precoTotal)}<br>`;
                            });
                            detalhamentoHtml += '</div>';
                        }

                        if (processos.length > 0) {
                            detalhamentoHtml += '<div style="margin-bottom:12px;"><strong>‚öôÔ∏è Processos Adicionais:</strong><br>';
                            processos.forEach(p => {
                                detalhamentoHtml += `&nbsp;&nbsp;‚Ä¢ ${p.descricao} - ${formatarReais(p.precoTotal)}<br>`;
                            });
                            detalhamentoHtml += '</div>';
                        }

                        document.getElementById("previewDetalhamento").innerHTML = detalhamentoHtml;
                    })
                    .withFailureHandler(function(erro) {
                        document.getElementById("previewLoading").classList.add("hidden");
                        document.getElementById("previewStatus").textContent = "Erro ao calcular preview";
                        console.error("Erro ao calcular preview:", erro);
                    })
                    .calcularPreviewOrcamento(dados);

            } catch (erro) {
                console.error("Erro ao atualizar preview:", erro);
                document.getElementById("previewStatus").textContent = "Erro ao processar dados";
            }
        }

        // Cria vers√£o com debounce para evitar muitas chamadas
        const atualizarPreviewDebounced = debounce(atualizarPreview, 600);

        // MutationObserver para detectar mudan√ßas nos containers
        const observerConfig = { childList: true, subtree: true };

        // Observer para container de chapas
        const chapasObserver = new MutationObserver(function(mutations) {
            atualizarPreviewDebounced();
        });

        const chapasContainer = document.getElementById("chapasContainer");
        if (chapasContainer) {
            chapasObserver.observe(chapasContainer, observerConfig);
        }

        // Observer para container de produtos
        const produtosObserver = new MutationObserver(function(mutations) {
            atualizarPreviewDebounced();
        });

        const produtosContainer = document.getElementById("produtosCadastradosContainer");
        if (produtosContainer) {
            produtosObserver.observe(produtosContainer, observerConfig);
        }

        // Observer para container de processos do pedido
        const processosObserver = new MutationObserver(function(mutations) {
            atualizarPreviewDebounced();
        });

        const processosContainer = document.getElementById("processosPedidoContainer");
        if (processosContainer) {
            processosObserver.observe(processosContainer, observerConfig);
        }

        // Event listeners para campos num√©ricos e de pre√ßo (com delega√ß√£o de eventos)
        document.addEventListener('input', function(e) {
            const target = e.target;
            
            // Verifica se √© um campo num√©rico relevante
            if (target.type === 'number' || 
                target.classList.contains('produtoPrecoUnit') ||
                target.classList.contains('produtoQuantidade') ||
                target.classList.contains('chapaComprimento') ||
                target.classList.contains('chapaLargura') ||
                target.classList.contains('chapaEspessura') ||
                target.classList.contains('pecaComprimento') ||
                target.classList.contains('pecaLargura') ||
                target.classList.contains('numPecasLote') ||
                target.classList.contains('numPecasChapa') ||
                target.classList.contains('tempoCorte') ||
                target.classList.contains('numDobras') ||
                target.classList.contains('tempoDobra') ||
                target.classList.contains('setupDobra') ||
                target.classList.contains('procValorHora') ||
                target.classList.contains('procHoras') ||
                target.classList.contains('procValorMat') ||
                target.classList.contains('procQtdMat') ||
                target.classList.contains('procPedidoValorHora') ||
                target.classList.contains('procPedidoHoras') ||
                target.classList.contains('procPedidoValorMat') ||
                target.classList.contains('procPedidoQtdMat') ||
                target.classList.contains('procPedidoValorFixo')) {
                atualizarPreviewDebounced();
            }
        });

        // Event listeners para checkboxes que afetam c√°lculos
        document.addEventListener('change', function(e) {
            const target = e.target;
            
            if (target.type === 'checkbox' && 
                (target.classList.contains('temCorte') ||
                 target.classList.contains('temDobra') ||
                 target.classList.contains('temProcessos') ||
                 target.classList.contains('isConjunto'))) {
                atualizarPreviewDebounced();
            }
        });

        // Atualiza preview inicial (ap√≥s um pequeno delay para garantir que tudo carregou)
        setTimeout(function() {
            atualizarPreview();
        }, 1000);

        /* ========================================================= */
        /* ========== ENVIO DE ARQUIVOS DO CLIENTE (01_IN) ========= */
        /* ========================================================= */

        function enviarArquivosCliente(event) {
            // Esse handler √© chamado pelo submit do form principal, mas s√≥ deve tratar o envio de arquivos
            if (event) {
                event.preventDefault();
            }

            const inputArquivos = document.getElementById("arquivosCliente");
            const statusEl = document.getElementById("arquivosStatus");
            const btnSubmit = document.getElementById("btnEnviarArquivos");

            if (!inputArquivos || !inputArquivos.files || inputArquivos.files.length === 0) {
                alert("Selecione pelo menos um arquivo do cliente para enviar.");
                return false;
            }

            const data = document.getElementById("projetoData").value.trim();
            const indice = document.getElementById("projetoIndice").value.trim();
            const iniciais = document.getElementById("projetoIniciais").value.trim();
            const codigoProjeto = data + indice + iniciais;
            const nomePastaCampo = document.getElementById("projetoPasta").value.trim();
            const descricao = document.getElementById("obsDescricao").value.trim();
            const nomePasta = nomePastaCampo || descricao;

            if (!data || !indice || !iniciais || !nomePasta) {
                alert("Preencha Data, √çndice, Iniciais e Nome/Descri√ß√£o da pasta antes de enviar arquivos.");
                return false;
            }

            // Preenche campos hidden com os dados do projeto
            document.getElementById("hiddenCodigoProjeto").value = codigoProjeto;
            document.getElementById("hiddenNomePasta").value = nomePasta;
            document.getElementById("hiddenDataProjeto").value = data;

            // Feedback visual: desabilita bot√£o e mostra status
            const originalText = btnSubmit ? btnSubmit.textContent : "";
            const originalDisabled = btnSubmit ? btnSubmit.disabled : false;
            if (btnSubmit) {
                btnSubmit.disabled = true;
                btnSubmit.textContent = "Enviando arquivos...";
            }
            statusEl.textContent = "Enviando arquivos para a pasta 01_IN...";

            const form = document.getElementById("mainForm");

            // IMPORTANTE: Quando h√° file inputs, s√≥ podemos passar o formul√°rio como √∫nico par√¢metro
            google.script.run
                .withSuccessHandler(function (res) {
                    if (btnSubmit) {
                        btnSubmit.disabled = originalDisabled;
                        btnSubmit.textContent = originalText;
                    }
                    if (res && res.ok) {
                        statusEl.textContent = "Arquivos salvos com sucesso em " +
                            (res.inFolderNome || "01_IN") +
                            " (" + (res.quantidade || 0) + " arquivo(s)).";
                        // Limpa o campo de arquivos ap√≥s sucesso
                        if (inputArquivos) {
                            inputArquivos.value = "";
                        }
                    } else {
                        statusEl.textContent = "Arquivos enviados, mas n√£o foi poss√≠vel obter detalhes da pasta.";
                    }
                })
                .withFailureHandler(function (err) {
                    if (btnSubmit) {
                        btnSubmit.disabled = originalDisabled;
                        btnSubmit.textContent = originalText;
                    }
                    statusEl.textContent = "Erro ao enviar arquivos.";
                    alert("Erro ao enviar arquivos do cliente:\n" + (err && err.message ? err.message : err));
                })
                .salvarArquivosCliente(form);

            return false;
        }

    </script>
</body>

</html>