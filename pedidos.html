<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <base target="_top">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>Pedidos — Sistema TUBA</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e40af 45%, #0ea5a1 100%);
      --card-bg: #ffffff;
      --surface: #f8fafc;
      --accent: #0ea5ff;
      --accent-hover: #0284c7;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --success: #10b981;
      --warning: #f59e0b;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.12);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--text-primary);
      background: var(--bg-gradient);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 16px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header compacto e responsivo */
    .header {
      background: rgba(255, 255, 255, 0.98);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(10px);
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .brand img {
      height: 40px;
      width: 40px;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
    }

    .brand-text h1 {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .brand-text p {
      font-size: 12px;
      color: var(--text-secondary);
      margin: 2px 0 0 0;
    }

    .btn-voltar {
      padding: 8px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition);
      white-space: nowrap;
    }

    .btn-voltar:hover {
      background: #fff;
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-voltar:active {
      transform: scale(0.98);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn-refresh {
      padding: 8px 14px;
      background: linear-gradient(135deg, var(--accent), #3b82f6);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition);
      box-shadow: 0 2px 8px rgba(14, 165, 255, 0.2);
    }

    .btn-refresh:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(14, 165, 255, 0.3);
    }

    .btn-refresh:active {
      transform: scale(0.98);
    }

    /* Card principal */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      overflow: hidden;
    }

    /* Controles de filtro responsivos */
    .controls {
      padding: 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .search-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      transition: var(--transition);
    }

    .search-wrapper:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(14, 165, 255, 0.1);
    }

    .search-wrapper svg {
      flex-shrink: 0;
      opacity: 0.5;
    }

    .search-wrapper input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 14px;
      outline: none;
      min-width: 0;
    }

    .search-wrapper input::placeholder {
      color: var(--text-muted);
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .filter-group select {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      outline: none;
      transition: var(--transition);
    }

    .filter-group select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(14, 165, 255, 0.1);
    }

    /* Tabela responsiva com scroll horizontal */
    .table-container {
      overflow-x: auto;
      overflow-y: visible;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 600px;
    }

    thead {
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    thead th {
      text-align: left;
      padding: 12px 14px;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: var(--transition);
    }

    tbody tr:hover {
      background: linear-gradient(90deg, rgba(14, 165, 255, 0.04), rgba(59, 130, 246, 0.02));
    }

    tbody td {
      padding: 14px;
      vertical-align: middle;
      color: var(--text-primary);
    }

    tbody td[contenteditable="true"] {
      cursor: text;
      position: relative;
      transition: var(--transition);
    }

    tbody td[contenteditable="true"]:hover {
      background: rgba(14, 165, 255, 0.05);
    }

    tbody td[contenteditable="true"]:focus {
      background: #fff;
      outline: 2px solid var(--accent);
      outline-offset: -2px;
      border-radius: 4px;
    }

    /* Select de status estilizado */
    .status-select {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      outline: none;
      transition: var(--transition);
      background: white;
    }

    .status-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(14, 165, 255, 0.1);
    }

    /* Botão de ação */
    .btn-action {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--danger-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-danger:active {
      transform: scale(0.98);
    }

    /* Estados vazios e de erro */
    .empty-state,
    .error-state {
      padding: 48px 24px;
      text-align: center;
      color: var(--text-secondary);
    }

    .empty-state svg,
    .error-state svg {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      opacity: 0.3;
    }

    .empty-state h3,
    .error-state h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: var(--text-primary);
    }

    .empty-state p,
    .error-state p {
      font-size: 14px;
      margin: 0;
    }

    /* Loading spinner */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Footer */
    footer {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
      font-size: 12px;
      color: var(--text-secondary);
      box-shadow: var(--shadow-sm);
    }

    /* Responsividade mobile */
    @media (max-width: 768px) {
      .page {
        padding: 12px;
        gap: 12px;
      }

      .header {
        padding: 12px;
      }

      .header-top {
        flex-wrap: wrap;
      }

      .brand img {
        height: 36px;
        width: 36px;
      }

      .brand-text h1 {
        font-size: 16px;
      }

      .brand-text p {
        font-size: 11px;
      }

      .btn-voltar,
      .btn-refresh {
        padding: 7px 12px;
        font-size: 13px;
      }

      .controls {
        padding: 12px;
      }

      .filter-group {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group label {
        font-size: 12px;
      }

      table {
        font-size: 12px;
        min-width: 500px;
      }

      thead th {
        padding: 10px 12px;
        font-size: 11px;
      }

      tbody td {
        padding: 12px;
      }

      .btn-action {
        padding: 6px 10px;
        font-size: 12px;
      }
    }

    @media (max-width: 480px) {
      .page {
        padding: 8px;
      }

      .header {
        padding: 10px;
      }

      .brand-text p {
        display: none;
      }

      table {
        min-width: 450px;
      }

      thead th,
      tbody td {
        padding: 8px 10px;
      }
    }

    /* Scroll personalizado */
    .table-container::-webkit-scrollbar {
      height: 8px;
    }

    .table-container::-webkit-scrollbar-track {
      background: var(--surface);
    }

    .table-container::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- Header -->
    <div class="header">
      <div class="header-top">
        <div class="brand">
          <img src="https://i.imgur.com/F8X7ZMs.png" alt="Logo TUBA">
          <div class="brand-text">
            <h1>Pedidos</h1>
            <p>Controle e acompanhamento</p>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn-voltar" onclick="voltarPagina()" title="Voltar para o dashboard">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            <span>Voltar</span>
          </button>
          <button class="btn-refresh" onclick="carregarPedidos()" title="Atualizar lista">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
            </svg>
            <span id="refreshText">Atualizar</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Card principal -->
    <div class="card">
      <!-- Controles de filtro -->
      <div class="controls">
        <div class="search-wrapper">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <input 
            id="globalSearch" 
            type="search"
            placeholder="Pesquisar por cliente, projeto, status..." 
            oninput="filtroGlobal()"
            autocomplete="off"
          >
        </div>

        <div class="filter-group">
          <label for="filterStatus">Status:</label>
          <select id="filterStatus" onchange="filtroStatus()">
            <option value="">Todos os status</option>
          </select>
        </div>
      </div>

      <!-- Tabela -->
      <div class="table-container">
        <table id="tabelaPedidos" role="table" aria-label="Lista de pedidos">
          <!-- Conteúdo carregado via JavaScript -->
        </table>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <strong>&copy; <span id="ano"></span> TUBA FERRAMENTARIA LTDA</strong><br>
      Sistema de Gestão de Pedidos
    </footer>
  </div>

  <script>
    const token = "<?= token ?>"; 
    let currentData = [];
    let opcoesStatusGlobal = [];
    let statusColIndex = 2;
    let isLoading = false;

    // Helper: ano atual
    document.getElementById('ano').textContent = new Date().getFullYear();

    /**
     * Carrega os pedidos do servidor
     */
    function carregarPedidos() {
      if (isLoading) return;
      
      isLoading = true;
      const refreshBtn = document.querySelector('.btn-refresh');
      const refreshText = document.getElementById('refreshText');
      
      // Visual feedback
      refreshBtn.disabled = true;
      refreshText.innerHTML = '<span class="loading"></span> Carregando...';
      
      google.script.run
        .withSuccessHandler(function(res) {
          renderizarPedidos(res);
          isLoading = false;
          refreshBtn.disabled = false;
          refreshText.textContent = 'Atualizar';
        })
        .withFailureHandler(function(err) {
          renderizarPedidosErro(err);
          isLoading = false;
          refreshBtn.disabled = false;
          refreshText.textContent = 'Atualizar';
        })
        .getPedidos();
    }

    /**
     * Renderiza erro ao carregar pedidos
     */
    function renderizarPedidosErro(err) {
      console.error('Erro ao carregar pedidos:', err);
      const tabela = document.getElementById('tabelaPedidos');
      tabela.innerHTML = `
        <tbody>
          <tr>
            <td colspan="100%">
              <div class="error-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="8" x2="12" y2="12"/>
                  <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <h3>Erro ao carregar pedidos</h3>
                <p>${err.message || 'Ocorreu um erro desconhecido. Tente novamente.'}</p>
              </div>
            </td>
          </tr>
        </tbody>
      `;
    }

    /**
     * Renderiza a tabela de pedidos
     */
    function renderizarPedidos(res) {
      if (!res) {
        renderizarPedidosErro({ message: 'Resposta inválida do servidor.' });
        return;
      }

      const dados = res.dados ?? [];
      const opcoes = res.opcoesStatus ?? [];
      opcoesStatusGlobal = opcoes;

      // Atualiza filtro de status
      const filter = document.getElementById('filterStatus');
      const selectedValue = filter.value;
      filter.innerHTML = '<option value="">Todos os status</option>';
      opcoes.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        if (s === selectedValue) opt.selected = true;
        filter.appendChild(opt);
      });

      currentData = dados;
      const tabela = document.getElementById('tabelaPedidos');
      tabela.innerHTML = '';

      // Estado vazio
      if (dados.length === 0) {
        tabela.innerHTML = `
          <tbody>
            <tr>
              <td colspan="100%">
                <div class="empty-state">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4"/>
                    <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                  </svg>
                  <h3>Nenhum pedido encontrado</h3>
                  <p>Adicione um novo pedido para começar</p>
                </div>
              </td>
            </tr>
          </tbody>
        `;
        return;
      }

      // Determina coluna de status dinamicamente
      const header = dados[0] || [];
      const foundIndex = header.findIndex(h => /status/i.test(String(h)));
      statusColIndex = foundIndex >= 0 ? foundIndex : 2;

      // Cabeçalho
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      header.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headRow.appendChild(th);
      });
      const thActions = document.createElement('th');
      thActions.textContent = 'Ações';
      thActions.style.textAlign = 'center';
      headRow.appendChild(thActions);
      thead.appendChild(headRow);
      tabela.appendChild(thead);

      // Corpo
      const tbody = document.createElement('tbody');
      for (let i = 1; i < dados.length; i++) {
        const rowVals = dados[i];
        const tr = document.createElement('tr');
        tr.dataset.status = '';

        for (let j = 0; j < rowVals.length; j++) {
          const td = document.createElement('td');
          const val = rowVals[j] !== undefined && rowVals[j] !== null ? rowVals[j] : '';

          // Coluna de status (select)
          if (j === statusColIndex) {
            const select = document.createElement('select');
            select.className = 'status-select';
            opcoes.forEach(opt => {
              const op = document.createElement('option');
              op.value = opt;
              op.textContent = opt;
              if (String(val) === String(opt)) op.selected = true;
              select.appendChild(op);
            });
            
            tr.dataset.status = String(select.value).trim();

            (function (rIndex, cIndex, sel, trEl) {
              sel.addEventListener('change', function () {
                trEl.dataset.status = String(sel.value).trim();
                google.script.run.updatePedido(rIndex + 1, cIndex + 1, sel.value);
                filtroStatus();
              });
            })(i, j, select, tr);
            
            td.appendChild(select);
          } else {
            // Células editáveis
            td.textContent = val;
            td.contentEditable = true;
            
            (function (rIndex, cIndex, cell) {
              cell.addEventListener('blur', function () {
                const newValue = cell.innerText.trim();
                google.script.run.updatePedido(rIndex + 1, cIndex + 1, newValue);
              });
              
              cell.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                  e.preventDefault();
                  cell.blur();
                }
              });
            })(i, j, td);
          }
          
          tr.appendChild(td);
        }

        // Ações
        const tdActions = document.createElement('td');
        tdActions.style.textAlign = 'center';
        
        const btnExcluir = document.createElement('button');
        btnExcluir.className = 'btn-action btn-danger';
        btnExcluir.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
          </svg>
          <span>Excluir</span>
        `;
        
        (function (rIndex) {
          btnExcluir.addEventListener('click', function () {
            if (!confirm('Tem certeza que deseja excluir este pedido? Esta ação não pode ser desfeita.')) return;
            btnExcluir.disabled = true;
            btnExcluir.textContent = 'Excluindo...';
            google.script.run
              .withSuccessHandler(carregarPedidos)
              .withFailureHandler(function(err) {
                alert('Erro ao excluir pedido: ' + err.message);
                btnExcluir.disabled = false;
                btnExcluir.innerHTML = '<span>Excluir</span>';
              })
              .deletePedido(rIndex + 1);
          });
        })(i);
        
        tdActions.appendChild(btnExcluir);
        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      }

      tabela.appendChild(tbody);
    }

    /**
     * Filtro global (busca em todos os campos)
     */
    function filtroGlobal() {
      const q = document.getElementById('globalSearch').value.trim().toLowerCase();
      const rows = document.querySelectorAll('#tabelaPedidos tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = q === '' || text.includes(q) ? '' : 'none';
      });
    }

    /**
     * Filtro por status
     */
    function filtroStatus() {
      const sel = String(document.getElementById('filterStatus').value || '').trim().toLowerCase();
      const rows = document.querySelectorAll('#tabelaPedidos tbody tr');
      
      rows.forEach(row => {
        if (!sel) {
          row.style.display = '';
          return;
        }
        
        let val = (row.dataset.status || '').trim().toLowerCase();
        
        // Fallback: extrai do select se dataset vazio
        if (!val) {
          const statusCell = row.cells[statusColIndex];
          if (statusCell) {
            const select = statusCell.querySelector('select');
            if (select) {
              val = String(select.value || '').trim().toLowerCase();
            }
          }
        }
        
        row.style.display = (val === sel) ? '' : 'none';
      });
    }

    /**
     * Volta para o dashboard
     */
    function voltarPagina() {
      if (!token) {
        alert("Token não encontrado. Por favor, recarregue a página.");
        return;
      }
      const baseUrl = "https://script.google.com/macros/s/AKfycbyqo2sqE_x5VhtQPInTBS4XO78vk-S0Ec2LbgDtbUYVyX98oOA_oh4VRMdrmk8DBWvx6g/exec";
      window.location.href = `${baseUrl}?page=dashboard&token=${token}`;
    }

    // Inicialização
    carregarPedidos();

    // Atalhos de teclado
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + K para focar na busca
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('globalSearch').focus();
      }
      
      // F5 ou Ctrl/Cmd + R para atualizar
      if (e.key === 'F5' || ((e.ctrlKey || e.metaKey) && e.key === 'r')) {
        e.preventDefault();
        carregarPedidos();
      }
    });
  </script>
</body>

</html>