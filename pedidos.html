<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <base target="_top">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pedidos — Sistema TUBA</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-1: linear-gradient(135deg, #0f172a 0%, #1e40af 45%, #0ea5a1 100%);
      --card-bg: rgba(255, 255, 255, 0.98);
      --glass: rgba(255, 255, 255, 0.06);
      --accent: #0ea5ff;
      --muted: #64748b;
      --radius: 12px;
      --max-width: 1200px;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color: #0f172a;
      background: var(--bg-1);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 36px 20px;
      gap: 24px;
    }

    .topbar {
      width: 100%;
      max-width: var(--max-width);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
      color: white;
    }

    .brand img {
      height: 44px;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(2, 6, 23, 0.4)
    }

    .brand h1 {
      font-size: 18px;
      margin: 0;
      font-weight: 700;
      letter-spacing: 0.2px;
      color: #fff
    }

    .card {
      width: 100%;
      max-width: var(--max-width);
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.12);
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .search {
      display: flex;
      gap: 8px;
      align-items: center;
      background: #f1f5f9;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, 0.04);
    }

    .search input {
      border: 0;
      background: transparent;
      padding: 6px 4px;
      outline: none;
      font-size: 14px;
      width: 360px;
    }

    .table-wrapper {
      overflow: auto;
      border-radius: 8px;
      padding: 6px;
      background: linear-gradient(180deg, rgba(2, 6, 23, 0.02), rgba(2, 6, 23, 0.01));
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      color: #0f172a;
      min-width: 900px;
      background: transparent;
    }

    thead th {
      text-align: left;
      padding: 12px 14px;
      background: #f8fafc;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      position: sticky;
      top: 0;
      z-index: 2;
      border-bottom: 1px solid rgba(2, 6, 23, 0.06)
    }

    tbody td {
      padding: 12px 14px;
      border-top: 1px solid rgba(15, 23, 42, 0.06);
      vertical-align: middle;
      background: #fff;
    }

    tbody tr:hover {
      background: linear-gradient(90deg, rgba(14, 165, 255, 0.03), rgba(59, 130, 246, 0.02));
    }

    td[contenteditable="true"] {
      background: #fbfdff;
      outline: none;
      border-radius: 6px;
      padding: 10px
    }

    select {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid rgba(2, 6, 23, 0.06);
      background: white;
      font-weight: 600;
    }

    .btn {
      appearance: none;
      border: 0;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      gap: 8px;
      align-items: center
    }

    .btn-primary {
      background: linear-gradient(90deg, var(--accent), #3b82f6);
      color: white;
      box-shadow: 0 6px 18px rgba(14, 165, 255, 0.12)
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      border-radius: 10px;
      padding: 8px 12px;
      border: 0
    }

    .btn {
                appearance: none;
                border: none;
                padding: 10px 14px;
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
                display: inline-flex;
                gap: 8px;
                align-items: center;
                background: #1a73e8;
                color: white;
            }

    footer {
      width: 100%;
      max-width: var(--max-width);
      color: #64748b;
      text-align: center;
      padding: 12px 0;
      font-size: 13px
    }

    @media (max-width:880px) {
      .search input {
        width: 160px
      }

      table {
        min-width: 720px
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <button class="btn" style="position:absolute; top:16px; left:16px;" onclick="voltarPagina()" title="Voltar">
      ← Voltar
    </button>
    <div class="topbar">
      <div class="brand">
        <img src="https://i.imgur.com/F8X7ZMs.png" alt="Logo">
        <div>
          <h1>Pedidos</h1>
          <div style="font-size:13px;color:rgba(255,255,255,0.85);margin-top:4px">Controle e acompanhamento de pedidos
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-ghost" onclick="carregarPedidos()">Atualizar</button>
        <!-- botão de adicionar removido conforme solicitado -->
      </div>
    </div>

    <div class="card">
      <div class="controls">
        <div class="search" role="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:0.7">
            <path d="M21 21l-4.35-4.35" stroke="#0f172a" stroke-width="1.5" stroke-linecap="round"
              stroke-linejoin="round" />
            <circle cx="11" cy="11" r="6" stroke="#0f172a" stroke-width="1.5" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
          <input id="globalSearch" placeholder="Pesquisar por cliente, projeto, status..." oninput="filtroGlobal()">
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <label style="font-size:13px;color:var(--muted)">Filtrar status:</label>
          <select id="filterStatus" onchange="filtroStatus()"
            style="padding:8px;border-radius:8px;border:1px solid rgba(2,6,23,0.06)">
            <option value="">Todos</option>
          </select>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="tabelaPedidos" aria-label="Lista de pedidos">
          <!-- conteúdo preenchido via JS -->
        </table>
      </div>
    </div>

    <footer class="card" style="text-align:center;font-size:13px">
      &copy; <span id="ano"></span> — TUBA FERRAMENTARIA LTDA
    </footer>
  </div>

  <script>
    const token = "<?= token ?>"; 
    // helper
    document.getElementById('ano').textContent = new Date().getFullYear();

    function carregarPedidos() {
      // add failure handler to surface server errors to the UI
      google.script.run
        .withSuccessHandler(renderizarPedidos)
        .withFailureHandler(renderizarPedidosErro)
        .getPedidos();
    }

    let currentData = [];
    let opcoesStatusGlobal = [];
    // índice (zero-based) da coluna que contém "Status". Inicializa com 2 por compatibilidade.
    let statusColIndex = 2;

    function renderizarPedidosErro(err) {
      console.error('Erro ao carregar pedidos:', err);
      const tabela = document.getElementById('tabelaPedidos');
      tabela.innerHTML = '';
      const tbody = document.createElement('tbody');
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 1;
      td.style.padding = '14px';
      td.textContent = 'Erro ao carregar pedidos. Verifique o console para mais detalhes.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      tabela.appendChild(tbody);
    }

    function renderizarPedidos(res) {
      // Defesa contra res nulo/indefinido (evita TypeError como "Cannot read properties of null (reading 'dados')")
      if (!res) {
        renderizarPedidosErro({ message: 'Resposta inválida do servidor (null/undefined).' });
        return;
      }

      // res: { dados: values, opcoesStatus: [...] }
      const dados = res.dados ?? [];
      const opcoes = res.opcoesStatus ?? [];
      opcoesStatusGlobal = opcoes;

      // preencher filtro status
      const filter = document.getElementById('filterStatus');
      filter.innerHTML = '<option value="">Todos</option>';
      opcoes.forEach(s => {
        const opt = document.createElement('option'); opt.value = s; opt.textContent = s; filter.appendChild(opt);
      });

      currentData = dados;
      const tabela = document.getElementById('tabelaPedidos');
      tabela.innerHTML = '';

      if (dados.length === 0) {
        const tbodyEmpty = document.createElement('tbody');
        const trEmpty = document.createElement('tr');
        const tdEmpty = document.createElement('td');
        tdEmpty.textContent = 'Nenhum pedido encontrado';
        tdEmpty.style.padding = '14px';
        trEmpty.appendChild(tdEmpty);
        tbodyEmpty.appendChild(trEmpty);
        tabela.appendChild(tbodyEmpty);
        return;
      }

      // Determina dinamicamente a coluna de status a partir do cabeçalho (procura por "status")
      const header = dados[0] || [];
      const foundIndex = header.findIndex(h => /status/i.test(String(h)));
      statusColIndex = foundIndex >= 0 ? foundIndex : 2; // fallback para 2 se não encontrar

      // Cabeçalho
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      header.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headRow.appendChild(th);
      });
      // ações
      const thA = document.createElement('th'); thA.textContent = 'Ações'; headRow.appendChild(thA);
      thead.appendChild(headRow);
      tabela.appendChild(thead);

      // Body
      const tbody = document.createElement('tbody');
      for (let i = 1; i < dados.length; i++) {
        const rowVals = dados[i];
        const tr = document.createElement('tr');
        // inicializa dataset.status
        tr.dataset.status = '';

        for (let j = 0; j < rowVals.length; j++) {
          const td = document.createElement('td');
          const val = rowVals[j] !== undefined && rowVals[j] !== null ? rowVals[j] : '';
          // usa statusColIndex dinâmico em vez de 2 fixo
          if (j === statusColIndex) {
            const select = document.createElement('select');
            opcoes.forEach(opt => {
              const op = document.createElement('option'); op.value = opt; op.textContent = opt;
              if (String(val) === String(opt)) op.selected = true;
              select.appendChild(op);
            });
            // define dataset.status inicial
            tr.dataset.status = String(select.value).trim();

            // on change: atualiza planilha, dataset e reaplica filtro
            (function (rIndex, cIndex, sel, trEl) {
              sel.addEventListener('change', function () {
                trEl.dataset.status = String(sel.value).trim();
                // server expects row index starting at 1 - original code used i+1
                google.script.run.updatePedido(rIndex + 1, cIndex + 1, sel.value);
                // re-filtra para refletir a mudança imediatamente
                filtroStatus();
              });
            })(i, j, select, tr);
            td.appendChild(select);
          } else {
            td.textContent = val;
            td.contentEditable = true;
            (function (rIndex, cIndex, cell) {
              cell.addEventListener('blur', function () {
                google.script.run.updatePedido(rIndex + 1, cIndex + 1, cell.innerText);
              });
            })(i, j, td);
          }
          tr.appendChild(td);
        }

        // ações
        const tdActions = document.createElement('td');
        const btnExcluir = document.createElement('button');
        btnExcluir.className = 'btn btn-danger';
        btnExcluir.textContent = 'Excluir';
        (function (rIndex) {
          btnExcluir.addEventListener('click', function () {
            if (!confirm('Deseja excluir este pedido?')) return;
            google.script.run.withSuccessHandler(carregarPedidos).deletePedido(rIndex + 1);
          });
        })(i);
        tdActions.appendChild(btnExcluir);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      }

      tabela.appendChild(tbody);
    }

    function filtroGlobal() {
      const q = document.getElementById('globalSearch').value.trim().toLowerCase();
      document.querySelectorAll('#tabelaPedidos tbody tr').forEach(r => {
        const text = r.textContent.toLowerCase();
        r.style.display = q === '' ? '' : (text.includes(q) ? '' : 'none');
      });
    }

    function filtroStatus() {
      const sel = String(document.getElementById('filterStatus').value || '').trim().toLowerCase();
      document.querySelectorAll('#tabelaPedidos tbody tr').forEach(r => {
        if (!sel) { r.style.display = ''; return; }
        // usa dataset.status como fonte principal
        let val = (r.dataset.status || '').trim().toLowerCase();
        // fallback: se dataset vazio, tenta extrair do cell (compatibilidade)
        if (!val) {
          const statusCell = r.cells[statusColIndex];
          if (statusCell) {
            const select = statusCell.querySelector('select');
            if (select) {
              val = String(select.value || '').trim().toLowerCase();
            } else {
              val = String(statusCell.textContent || '').trim().toLowerCase();
            }
          }
        }
        r.style.display = (val === sel) ? '' : 'none';
      });
    }
    function voltarPagina() {
      if (!token) {
        alert("Token não encontrado — recarregue a página.");
        return;
      }
      const baseUrl = "https://script.google.com/macros/s/AKfycbyqo2sqE_x5VhtQPInTBS4XO78vk-S0Ec2LbgDtbUYVyX98oOA_oh4VRMdrmk8DBWvx6g/exec";
      window.location.href = `${baseUrl}?page=dashboard&token=${token}`;
    }
    carregarPedidos();
  </script>
</body>

</html>