<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="format-detection" content="telephone=no">
  <title>Controle de Ve√≠culos ‚Äî Visualiza√ß√£o</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }

    body {
      overscroll-behavior: contain;
    }

    .btn {
      appearance: none;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      background: #1a73e8;
      color: white;
      transition: all 0.2s;
      touch-action: manipulation;
    }

    .btn:active {
      transform: scale(0.96);
    }

    th.sortable {
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      transition: background 0.2s;
    }

    th.sortable:hover {
      background: #cbd5e1;
    }

    th.sortable .arrow {
      display: inline-block;
      width: 0;
      height: 0;
      margin-left: 6px;
      vertical-align: middle;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      opacity: 0.3;
    }

    th.sortable.asc .arrow {
      border-bottom: 6px solid #334155;
      opacity: 1;
    }

    th.sortable.desc .arrow {
      border-top: 6px solid #334155;
      opacity: 1;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        font-size: 12px;
        min-width: 900px;
      }

      th,
      td {
        padding: 8px 6px !important;
      }

      .btn {
        padding: 8px 12px;
        font-size: 13px;
      }

      .mobile-scroll-hint {
        display: block;
        text-align: center;
        color: #64748b;
        font-size: 11px;
        padding: 8px;
        background: #f8fafc;
        border-radius: 6px;
        margin-bottom: 8px;
      }
    }

    @media (min-width: 769px) {
      .mobile-scroll-hint {
        display: none;
      }
    }

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .status-em-uso {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-finalizado {
      background: #dcfce7;
      color: #166534;
    }

    .status-pendente {
      background: #fef3c7;
      color: #92400e;
    }

    /* Loading spinner */
    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Better button states */
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:not(:disabled):active {
      transform: scale(0.96);
    }

    /* Smooth transitions */
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* Improved filter section */
    .filter-section {
      background: #f8fafc;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    /* Better input styles */
    input,
    select {
      transition: all 0.2s;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    /* Sticky header for mobile */
    @media (max-width: 768px) {
      thead {
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
    }

    /* Compact header for mobile */
    @media (max-width: 640px) {
      .header-logo {
        width: 48px;
        height: 48px;
      }

      .header-title {
        font-size: 18px;
      }

      .header-subtitle {
        font-size: 12px;
      }

      .btn-voltar {
        position: relative;
        top: 0;
        left: 0;
        margin-bottom: 12px;
      }
    }
  </style>
</head>

<body class="bg-slate-50 min-h-screen p-3 md:p-6">
  <!-- Bot√£o Voltar -->
  <div class="mb-3 md:mb-0">
    <button class="btn btn-voltar md:absolute md:top-4 md:left-4" onclick="voltarPagina()" title="Voltar">
      ‚Üê Voltar
    </button>
  </div>

  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header class="flex flex-wrap items-center gap-3 md:gap-4 mb-4 md:mb-6">
      <img src="https://i.imgur.com/ncKzLXK.png" alt="Logo"
        class="header-logo w-16 h-16 md:w-20 md:h-20 object-contain" />
      <div class="flex-1 min-w-0">
        <h1 class="header-title text-xl md:text-2xl font-semibold text-slate-800">Controle de Ve√≠culos</h1>
        <p class="header-subtitle text-xs md:text-sm text-slate-500 mt-1">Visualize as sa√≠das e registre o retorno dos
          ve√≠culos</p>
      </div>
      <div class="w-full sm:w-auto">
        <button id="btnAtualizar"
          class="w-full sm:w-auto bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Atualizar
        </button>
      </div>
    </header>

    <div class="bg-white rounded-xl shadow-sm md:shadow p-3 md:p-4">
      <!-- Mensagem de feedback -->
      <div id="mensagem" class="mb-4 hidden p-3 rounded-lg text-sm font-medium"></div>

      <!-- Filtros -->
      <div class="filter-section">
        <h3 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
          </svg>
          Filtros
        </h3>

        <!-- Busca textual -->
        <div class="mb-3">
          <div class="flex gap-2">
            <input id="txtBusca" type="search" placeholder="üîç Pesquisar funcion√°rio, ve√≠culo ou motivo"
              class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500"
              autocomplete="off" />
            <button id="btnLimparBusca"
              class="px-3 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg text-sm font-medium transition">
              Limpar
            </button>
          </div>
        </div>

        <!-- Filtros de sele√ß√£o -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
          <select id="selStatus" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500">
            <option value="">üìã Todos os status</option>
            <option value="Em uso">üöó Em uso</option>
            <option value="Finalizado">‚úÖ Finalizado</option>
            <option value="Pendente">‚è≥ Pendente</option>
          </select>

          <select id="selVeiculo" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500">
            <option value="">üöô Todos os ve√≠culos</option>
          </select>
        </div>

        <!-- Filtro de datas -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-end">
          <div>
            <label class="text-xs text-slate-600 mb-1 block">Data In√≠cio</label>
            <input id="dtInicio" type="date"
              class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500" />
          </div>
          <div>
            <label class="text-xs text-slate-600 mb-1 block">Data Fim</label>
            <input id="dtFim" type="date"
              class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500" />
          </div>
          <button id="btnLimparDatas"
            class="px-3 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg text-sm font-medium transition">
            Limpar datas
          </button>
        </div>
      </div>

      <!-- Hint de scroll para mobile -->
      <div class="mobile-scroll-hint">
        ‚Üê Deslize horizontalmente para ver mais colunas ‚Üí
      </div>

      <!-- Tabela -->
      <div class="table-container overflow-x-auto rounded-lg border border-slate-200">
        <table id="tblVeiculos" class="w-full text-sm table-auto border-collapse">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th data-col="row" class="px-3 py-3 text-left sortable font-semibold"># <span class="arrow"></span></th>
              <th data-col="0" class="px-3 py-3 text-left sortable font-semibold">DATA <span class="arrow"></span></th>
              <th data-col="1" class="px-3 py-3 text-left sortable font-semibold">FUNCION√ÅRIO <span
                  class="arrow"></span></th>
              <th data-col="2" class="px-3 py-3 text-left sortable font-semibold">VE√çCULO <span class="arrow"></span>
              </th>
              <th data-col="3" class="px-3 py-3 text-left sortable font-semibold">SA√çDA <span class="arrow"></span></th>
              <th data-col="4" class="px-3 py-3 text-left sortable font-semibold">PREVIS√ÉO <span class="arrow"></span>
              </th>
              <th data-col="5" class="px-3 py-3 text-left sortable font-semibold">MOTIVO <span class="arrow"></span>
              </th>
              <th data-col="6" class="px-3 py-3 text-left sortable font-semibold">STATUS <span class="arrow"></span>
              </th>
              <th data-col="7" class="px-3 py-3 text-left sortable font-semibold">RETORNO <span class="arrow"></span>
              </th>
              <th class="px-3 py-3 text-center font-semibold">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="corpoTabela" class="divide-y divide-slate-200"></tbody>
        </table>
      </div>

      <!-- Rodap√© informativo -->
      <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-100">
        <p class="text-xs text-blue-800 flex items-start gap-2">
          <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
              clip-rule="evenodd" />
          </svg>
          <span><strong>Dica:</strong> Clique em "Registrar Volta" para marcar o retorno do ve√≠culo. O status ser√°
            atualizado para "Finalizado" e o hor√°rio de retorno ser√° registrado automaticamente.</span>
        </p>
      </div>
    </div>
  </div>

  <script>
    // Polyfill para Array.from
    if (!Array.from) {
      Array.from = function (arrayLike) {
        return Array.prototype.slice.call(arrayLike);
      };
    }

    // Extrair token da URL (compat√≠vel com Google Apps Script)
    function getTokenFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || '';
    }

    const token = getTokenFromURL();
    const isEmbedded = window.location.search.includes('embedded=1') || window.self !== window.top;
    
    const mensagemEl = document.getElementById('mensagem');
    const corpo = document.getElementById('corpoTabela');
    const btnAtualizar = document.getElementById('btnAtualizar');

    // filtros DOM
    const txtBusca = document.getElementById('txtBusca');
    const selStatus = document.getElementById('selStatus');
    const selVeiculo = document.getElementById('selVeiculo');
    const dtInicio = document.getElementById('dtInicio');
    const dtFim = document.getElementById('dtFim');
    const btnLimparBusca = document.getElementById('btnLimparBusca');
    const btnLimparDatas = document.getElementById('btnLimparDatas');

    // estado local
    let allRows = [];
    let sortCol = 'row';
    let sortDir = 'asc';

    // carregar dados da planilha
    function carregarDados() {
      // Validar se google.script.run existe
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        // Aguarda um pouco mais para o Google Apps Script carregar (especialmente em iframes)
        let retryCount = 0;
        const maxRetries = 10;
        
        const checkGoogleScript = setInterval(() => {
          retryCount++;
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            clearInterval(checkGoogleScript);
            carregarDados();
            return;
          }
          
          if (retryCount >= maxRetries) {
            clearInterval(checkGoogleScript);
            mostrarMensagem('‚ùå Erro: Ambiente Google Apps Script n√£o carregado. Aguarde alguns segundos e atualize a p√°gina.', 'bg-red-100 text-red-700 border border-red-200');
            corpo.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-red-600">
              <div class="flex flex-col items-center gap-3">
                <p>Erro ao inicializar</p>
                <button onclick="location.reload()" class="btn">üîÑ Tentar novamente</button>
              </div>
            </td></tr>`;
          }
        }, 500);
        
        return;
      }

      mostrarMensagem('', '');
      corpo.innerHTML = `<tr><td colspan="10" class="p-8 text-center text-slate-500">
        <div class="flex flex-col items-center gap-3">
          <div class="spinner"></div>
          <span>Carregando dados...</span>
        </div>
      </td></tr>`;

      // Timeout para detectar se a chamada demorou muito
      const timeoutId = setTimeout(() => {
        mostrarMensagem('‚è≥ Carregamento est√° demorando mais que o esperado. Aguarde...', 'bg-yellow-100 text-yellow-800 border border-yellow-200');
      }, 10000);

      google.script.run
        .withSuccessHandler(rows => {
          clearTimeout(timeoutId);
          allRows = Array.isArray(rows) ? rows : [];
          popularOpcoesVeiculo(allRows);
          aplicarFiltrosERender();
          mostrarMensagem('‚úÖ Dados carregados com sucesso!', 'bg-green-100 text-green-800 border border-green-200');
          setTimeout(() => mostrarMensagem('', ''), 2000);
        })
        .withFailureHandler(err => {
          clearTimeout(timeoutId);
          const errorMsg = err && err.message ? err.message : (typeof err === 'string' ? err : 'Erro desconhecido');
          mostrarMensagem('‚ùå Erro ao carregar dados: ' + errorMsg, 'bg-red-100 text-red-700 border border-red-200');
          corpo.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-red-600">
            <div class="flex flex-col items-center gap-3">
              <p>Erro ao carregar dados</p>
              <button onclick="carregarDados()" class="btn">üîÑ Tentar novamente</button>
            </div>
          </td></tr>`;
        })
        .getControleVeiculos();
    }

    // popular select de ve√≠culos
    function popularOpcoesVeiculo(rows) {
      const set = new Set();
      rows.forEach(r => {
        const v = (r.values && r.values[2]) ? String(r.values[2]).trim() : '';
        if (v) set.add(v);
      });

      selVeiculo.innerHTML = '<option value="">üöô Todos os ve√≠culos</option>';
      Array.from(set).sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' })).forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        selVeiculo.appendChild(opt);
      });
    }

    function aplicarFiltrosERender() {
      let rows = allRows.slice();

      // filtro textual
      const q = (txtBusca.value || '').trim().toLowerCase();
      if (q) {
        rows = rows.filter(r => {
          const v = r.values || [];
          const func = String(v[1] || '').toLowerCase();
          const veic = String(v[2] || '').toLowerCase();
          const motivo = String(v[5] || '').toLowerCase();
          return func.includes(q) || veic.includes(q) || motivo.includes(q);
        });
      }

      // filtro status
      const statusFilter = (selStatus.value || '').trim().toLowerCase();
      if (statusFilter) {
        rows = rows.filter(r => {
          const s = String((r.values && r.values[6]) || '').trim().toLowerCase();
          return s === statusFilter;
        });
      }

      // filtro ve√≠culo
      const vFilter = (selVeiculo.value || '').trim().toLowerCase();
      if (vFilter) {
        rows = rows.filter(r => {
          const v = String((r.values && r.values[2]) || '').trim().toLowerCase();
          return v === vFilter;
        });
      }

      // filtro datas
      const start = dtInicio.value ? new Date(dtInicio.value) : null;
      const end = dtFim.value ? new Date(dtFim.value) : null;
      if (start || end) {
        rows = rows.filter(r => {
          const dateStr = (r.values && r.values[0]) ? String(r.values[0]).trim() : '';
          const d = parseDateLike(dateStr);
          if (!d) return false;
          if (start && d < start) return false;
          if (end) {
            const endOfDay = new Date(end);
            endOfDay.setHours(23, 59, 59, 999);
            if (d > endOfDay) return false;
          }
          return true;
        });
      }

      // ordenar
      rows.sort((a, b) => compareRows(a, b, sortCol, sortDir));

      renderizarTabela(rows);
      atualizarSetaOrdenacao();
    }

    function parseDateLike(text) {
      if (!text) return null;
      const ddmmy = text.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if (ddmmy) {
        const d = new Date(Number(ddmmy[3]), Number(ddmmy[2]) - 1, Number(ddmmy[1]));
        if (!isNaN(d.getTime())) return d;  // MUDAN√áA AQUI
      }
      const d2 = new Date(text);
      if (!isNaN(d2.getTime())) return d2;  // MUDAN√áA AQUI
      return null;
    }

    function compareRows(a, b, col, dir) {
      const mul = dir === 'asc' ? 1 : -1;
      if (col === 'row') {
        const ra = Number(a.row || 0);
        const rb = Number(b.row || 0);
        return (ra - rb) * mul;
      }

      const ai = a.values && a.values[col] !== undefined ? a.values[col] : '';
      const bi = b.values && b.values[col] !== undefined ? b.values[col] : '';

      if (String(col) === '0') {
        const da = parseDateLike(String(ai));
        const db = parseDateLike(String(bi));
        if (da && db) return (da - db) * mul;
        if (da && !db) return -1 * mul;
        if (!da && db) return 1 * mul;
      }

      const na = Number(String(ai).replace(/[^\d\.-]/g, ''));
      const nb = Number(String(bi).replace(/[^\d\.-]/g, ''));
      if (!isNaN(na) && !isNaN(nb)) return (na - nb) * mul;

      return String(ai).localeCompare(String(bi), undefined, { sensitivity: 'base' }) * mul;
    }

    function atualizarSetaOrdenacao() {
      document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
        const col = th.getAttribute('data-col') || 'row';
        if (String(col) === String(sortCol)) th.classList.add(sortDir);
      });
    }

    function getStatusClass(status) {
      const s = String(status).trim().toLowerCase();
      if (s === 'em uso') return 'status-em-uso';
      if (s === 'finalizado') return 'status-finalizado';
      if (s === 'pendente') return 'status-pendente';
      return '';
    }

    function renderizarTabela(rows) {
      if (!Array.isArray(rows) || rows.length === 0) {
        corpo.innerHTML = `<tr><td colspan="10" class="p-8 text-center text-slate-500">
          <div class="flex flex-col items-center gap-2">
            <svg class="w-12 h-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span class="font-medium">Nenhum registro encontrado</span>
            <span class="text-xs">Tente ajustar os filtros</span>
          </div>
        </td></tr>`;
        return;
      }

      corpo.innerHTML = rows.map(r => {
        const vals = r.values || [];
        const data = vals[0] || '';
        const func = vals[1] || '';
        const veic = vals[2] || '';
        const horaSaida = vals[3] || '';
        const previsao = vals[4] || '';
        const motivo = vals[5] || '';
        const status = vals[6] || '';
        const horaRetorno = vals[7] || '';
        const rowNum = r.row;

        const isEnabled = (status && String(status).trim().toLowerCase() === 'em uso');
        const statusClass = getStatusClass(status);

        const btn = isEnabled
          ? `<button data-row="${rowNum}" class="registrar-volta px-3 py-1.5 rounded-lg text-xs font-semibold bg-green-600 text-white hover:bg-green-700 transition whitespace-nowrap">
              ‚úì Registrar Volta
            </button>`
          : `<button disabled class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-slate-100 text-slate-400 cursor-not-allowed whitespace-nowrap">
              Registrar Volta
            </button>`;

        return `<tr class="hover:bg-slate-50 transition fade-in">
          <td class="px-3 py-3 font-medium text-slate-600">${rowNum}</td>
          <td class="px-3 py-3">${escapeHtml(data)}</td>
          <td class="px-3 py-3 font-medium">${escapeHtml(func)}</td>
          <td class="px-3 py-3">${escapeHtml(veic)}</td>
          <td class="px-3 py-3">${escapeHtml(horaSaida)}</td>
          <td class="px-3 py-3">${escapeHtml(previsao)}</td>
          <td class="px-3 py-3 max-w-xs truncate" title="${escapeHtml(motivo)}">${escapeHtml(motivo)}</td>
          <td class="px-3 py-3"><span class="status-badge ${statusClass}">${escapeHtml(status)}</span></td>
          <td class="px-3 py-3">${escapeHtml(horaRetorno)}</td>
          <td class="px-3 py-3 text-center">${btn}</td>
        </tr>`;
      }).join('');

      // adicionar listeners
      document.querySelectorAll('.registrar-volta').forEach(btn => {
        btn.addEventListener('click', () => {
          const row = parseInt(btn.getAttribute('data-row'), 10);
          if (!row) return;
          if (!confirm('Confirma o registro de volta deste ve√≠culo agora?')) return;

          btn.disabled = true;
          btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div>';

          // Timeout para detectar se a opera√ß√£o demorou muito
          const timeoutId = setTimeout(() => {
            mostrarMensagem('‚è≥ Registrando retorno... Aguarde...', 'bg-yellow-100 text-yellow-800 border border-yellow-200');
          }, 5000);

          google.script.run
            .withSuccessHandler(() => {
              clearTimeout(timeoutId);
              mostrarMensagem('‚úÖ Volta registrada com sucesso!', 'bg-green-100 text-green-800 border border-green-200');
              carregarDados();
            })
            .withFailureHandler(err => {
              clearTimeout(timeoutId);
              const errorMsg = err && err.message ? err.message : (typeof err === 'string' ? err : 'Erro desconhecido');
              mostrarMensagem('‚ùå Erro ao registrar volta: ' + errorMsg, 'bg-red-100 text-red-700 border border-red-200');
              btn.disabled = false;
              btn.innerHTML = '‚úì Registrar Volta';
              carregarDados();
            })
            .registrarRetornoVeiculo(row);
        });
      });
    }

    function mostrarMensagem(texto, classes) {
      if (!texto) {
        mensagemEl.className = 'mb-4 hidden';
        mensagemEl.textContent = '';
        return;
      }
      mensagemEl.textContent = texto;
      mensagemEl.className = 'mb-4 p-3 rounded-lg text-sm font-medium fade-in ' + classes;
      mensagemEl.classList.remove('hidden');

      // Auto-hide ap√≥s 5 segundos
      setTimeout(() => {
        mensagemEl.classList.add('hidden');
      }, 5000);
    }

    function escapeHtml(str) {
      if (str === undefined || str === null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ordena√ß√£o por clique nos headers
    document.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.getAttribute('data-col') || 'row';
        if (String(col) === String(sortCol)) {
          sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
        } else {
          sortCol = col;
          sortDir = 'asc';
        }
        aplicarFiltrosERender();
      });
    });

    // eventos de filtros
    [txtBusca, selStatus, selVeiculo, dtInicio, dtFim].forEach(el => {
      el.addEventListener('input', debounce(() => aplicarFiltrosERender(), 250));
      el.addEventListener('change', () => aplicarFiltrosERender());
    });

    btnLimparBusca.addEventListener('click', () => {
      txtBusca.value = '';
      aplicarFiltrosERender();
    });

    btnLimparDatas.addEventListener('click', () => {
      dtInicio.value = '';
      dtFim.value = '';
      aplicarFiltrosERender();
    });

    btnAtualizar.addEventListener('click', () => {
      btnAtualizar.disabled = true;
      btnAtualizar.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div> Atualizando...';
      carregarDados();
      setTimeout(() => {
        btnAtualizar.disabled = false;
        btnAtualizar.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg> Atualizar`;
      }, 1000);
    });

    // Detectar se est√° em iframe e ajustar comportamento
    if (isEmbedded) {
      // Remove o bot√£o voltar se estiver em iframe (o app principal j√° tem)
      const btnVoltar = document.querySelector('.btn-voltar');
      if (btnVoltar) {
        btnVoltar.style.display = 'none';
      }
      
      // Ajusta o padding do header para mobile quando em iframe
      document.body.style.paddingTop = '0';
    }

    // Aguarda um pouco antes de carregar para garantir que o Google Apps Script est√° pronto
    // Isso √© especialmente importante em iframes e dispositivos m√≥veis
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(carregarDados, 300);
      });
    } else {
      setTimeout(carregarDados, 300);
    }

    // Adiciona listener para mensagens do iframe pai (se necess√°rio)
    window.addEventListener('message', function(event) {
      // Aceita mensagens de qualquer origem (voc√™ pode restringir se necess√°rio)
      if (event.data && event.data.type === 'RELOAD') {
        carregarDados();
      }
    });

    function voltarPagina() {
      // Se estiver em iframe, comunica com o pai para fechar
      if (isEmbedded && window.parent && window.parent !== window.self) {
        try {
          // Tenta comunicar com o iframe pai
          window.parent.postMessage({ type: 'CLOSE_IFRAME' }, '*');
          return;
        } catch (e) {
          console.log('N√£o foi poss√≠vel comunicar com iframe pai:', e);
        }
      }
      
      // Fallback: redireciona normalmente
      const baseUrl = "https://script.google.com/macros/s/AKfycbyqo2sqE_x5VhtQPInTBS4XO78vk-S0Ec2LbgDtbUYVyX98oOA_oh4VRMdrmk8DBWvx6g/exec";
      const url = token ? `${baseUrl}?page=dashboard&token=${encodeURIComponent(token)}` : `${baseUrl}?page=dashboard`;
      
      // Tenta usar replace para evitar problemas em alguns navegadores
      try {
        window.location.replace(url);
      } catch (e) {
        window.location.href = url;
      }
    }

    function debounce(fn, wait) {
      var t;
      return function () {
        var context = this;
        var args = arguments;
        clearTimeout(t);
        t = setTimeout(function () {
          fn.apply(context, args);
        }, wait);
      };
    }
  </script>
</body>

</html>