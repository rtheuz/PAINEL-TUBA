<! DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apresentação - Kanban e Segurança</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Montserrat', sans-serif;
    }

    body {
      position: relative;
      background: #000;
    }

    .slide-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
      pointer-events: none;
    }

    .slide-container.active {
      opacity: 1;
      pointer-events: auto;
      z-index: 2;
    }

    .slide-container.fade-out {
      opacity: 0;
      z-index: 1;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    .controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 14px;
      backdrop-filter: blur(10px);
      display: none;
      flex-direction: column;
      gap: 10px;
      min-width: 250px;
    }

    .controls.visible {
      display: flex;
    }

    .controls h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 8px;
    }

    .control-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .control-item label {
      font-size: 13px;
    }

    .control-item input {
      width: 80px;
      padding: 5px 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 13px;
    }

    .control-item input:focus {
      outline: none;
      border-color: #4ecdc4;
      background: rgba(255, 255, 255, 0.2);
    }

    .toggle-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1001;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .toggle-controls:hover {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    .status-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4ecdc4;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.5;
        transform: scale(1.2);
      }
    }

    .status-dot.kanban {
      background: #1a73e8;
    }

    .status-dot.seguranca {
      background: #ff6b6b;
    }

    .countdown {
      font-weight: 600;
      color: #4ecdc4;
    }

    body.presentation-mode .controls,
    body.presentation-mode .toggle-controls,
    body.presentation-mode .status-indicator {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }

    body.presentation-mode:hover .controls,
    body.presentation-mode:hover .toggle-controls,
    body.presentation-mode:hover .status-indicator {
      opacity: 1;
      pointer-events: auto;
    }

    .mensagem-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .mensagem-item-texto {
      flex: 1;
      color: rgba(255, 255, 255, 0.9);
      word-break: break-word;
    }

    .mensagem-item-acoes {
      display: flex;
      gap: 5px;
      margin-left: 10px;
    }

    .mensagem-item-acoes button {
      padding: 4px 8px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .mensagem-item-acoes button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .mensagem-item-acoes button.deletar {
      background: rgba(255, 107, 107, 0.5);
    }

    .mensagem-item-acoes button.deletar:hover {
      background: rgba(255, 107, 107, 0.7);
    }

    .mensagem-display {
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 20px;
      margin-bottom: 10px;
      border-radius: 10px;
      border-left: 4px solid;
      backdrop-filter: blur(10px);
      animation: slideIn 0.5s ease-out;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .mensagem-display.small { font-size: 16px; }
    .mensagem-display.medium { font-size: 24px; }
    .mensagem-display.large { font-size: 32px; }
    .mensagem-display.xlarge { font-size: 48px; font-weight: 600; }
  </style>
</head>

<body>
  <div class="slide-container active" id="kanbanSlide">
    <iframe id="kanbanFrame" src=""></iframe>
  </div>

  <div class="slide-container" id="segurancaSlide">
    <iframe id="segurancaFrame" src=""></iframe>
  </div>

  <div class="status-indicator" id="statusIndicator">
    <div class="status-dot kanban" id="statusDot"></div>
    <span id="statusText">Carregando...</span>
    <span class="countdown" id="countdown"></span>
  </div>

  <button class="toggle-controls" id="toggleControls" title="Mostrar/Ocultar Controles">&#9881;</button>

  <div class="controls" id="controls">
    <h3>&#9881; Configurações</h3>
    <div class="control-item">
      <label>Tempo Kanban (minutos):</label>
      <input type="number" id="timeKanban" min="1" max="60" value="5">
    </div>
    <div class="control-item">
      <label>Tempo Segurança (minutos):</label>
      <input type="number" id="timeSeguranca" min="1" max="60" value="1">
    </div>
    <div style="margin-top: 5px; padding: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; font-size: 12px; color: rgba(255, 255, 255, 0.8);">
      O Kanban é exibido predominantemente.  A Segurança aparece brevemente entre os ciclos.
    </div>
    <div class="control-item">
      <label>Transição (segundos):</label>
      <input type="number" id="transitionTime" min="0.5" max="5" step="0.5" value="1.5">
    </div>
    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.3);">
      <button id="btnApplySettings" style="width: 100%; padding: 8px; background: #4ecdc4; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
        Aplicar Configurações
      </button>
    </div>
    
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.3);">
      <h3 style="margin: 0 0 10px 0; font-size: 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.3); padding-bottom: 8px;">Mensagens</h3>
      <div style="margin-bottom: 10px;">
        <input type="text" id="novaMensagemTexto" placeholder="Digite a mensagem..." 
               style="width: 100%; padding: 8px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 13px; margin-bottom: 8px;">
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <select id="novaMensagemCor" style="flex: 1; padding: 6px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: rgb(48, 48, 48); font-size: 12px;">
            <option value="#ffffff">Branco</option>
            <option value="#ff6b6b">Vermelho</option>
            <option value="#4ecdc4">Ciano</option>
            <option value="#1a73e8">Azul</option>
            <option value="#ffd93d">Amarelo</option>
            <option value="#6bcf7f">Verde</option>
          </select>
          <select id="novaMensagemTamanho" style="flex: 1; padding: 6px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: (48, 48, 48); font-size: 12px;">
            <option value="small">Pequeno</option>
            <option value="medium" selected>Médio</option>
            <option value="large">Grande</option>
            <option value="xlarge">Muito Grande</option>
          </select>
        </div>
        <button id="btnAdicionarMensagem" style="width: 100%; padding: 8px; background: #6bcf7f; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
          Adicionar Mensagem
        </button>
      </div>
      <div id="listaMensagens" style="max-height: 200px; overflow-y: auto;"></div>
    </div>
  </div>
  
  <div id="mensagensDisplay" style="position: fixed; top: 60px; left: 20px; right: 20px; z-index: 999; pointer-events: none;"></div>

  <script>
    var WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyqo2sqE_x5VhtQPInTBS4XO78vk-S0Ec2LbgDtbUYVyX98oOA_oh4VRMdrmk8DBWvx6g/exec";
    
    var config = {
      timeKanban: 10,
      timeSeguranca: 1,
      transitionTime: 1.5
    };

    var currentSlide = 'kanban';
    var timer = null;
    var countdownTimer = null;
    var timeRemaining = 0;
    var mensagens = [];
    var syncInterval = null;

    var kanbanSlide = document.getElementById('kanbanSlide');
    var segurancaSlide = document.getElementById('segurancaSlide');
    var kanbanFrame = document. getElementById('kanbanFrame');
    var segurancaFrame = document.getElementById('segurancaFrame');
    var statusText = document.getElementById('statusText');
    var statusDot = document.getElementById('statusDot');
    var countdown = document. getElementById('countdown');
    var toggleControls = document.getElementById('toggleControls');
    var controls = document.getElementById('controls');

    function getToken() {
      var urlParams = new URLSearchParams(window.location.search);
      var urlToken = urlParams. get('token');
      if (urlToken) {
        localStorage.setItem('token', urlToken);
        return urlToken;
      }
      return localStorage.getItem('token');
    }

    var token = getToken();

    var kanbanUrl = token 
      ?  WEBAPP_URL + "?page=kanban&token=" + token
      : WEBAPP_URL + "?page=kanban";
    var segurancaUrl = WEBAPP_URL + "?page=seguranca";

    kanbanFrame.src = kanbanUrl;
    segurancaFrame.src = segurancaUrl;

    function loadSettings() {
      var saved = localStorage.getItem('apresentacaoConfig');
      if (saved) {
        config = JSON.parse(saved);
        document.getElementById('timeKanban').value = config.timeKanban;
        document.getElementById('timeSeguranca').value = config.timeSeguranca;
        document.getElementById('transitionTime').value = config.transitionTime;
      }
    }

    function saveSettings() {
      localStorage.setItem('apresentacaoConfig', JSON.stringify(config));
    }

    function applySettings() {
      config.timeKanban = parseInt(document.getElementById('timeKanban').value) || 5;
      config.timeSeguranca = parseInt(document.getElementById('timeSeguranca').value) || 1;
      config.transitionTime = parseFloat(document.getElementById('transitionTime'). value) || 1.5;
      saveSettings();
      resetCycle();
      alert('Configurações aplicadas!  O ciclo será reiniciado.');
    }

    function updateTransitionTime() {
      var style = document.createElement('style');
      style.textContent = '. slide-container { transition: opacity ' + config.transitionTime + 's ease-in-out; }';
      document.head.appendChild(style);
    }

    function updateStatus(slide, timeLeft) {
      var minutes = Math.floor(timeLeft / 60);
      var seconds = Math.floor(timeLeft % 60);
      countdown.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
      
      if (slide === 'kanban') {
        statusText.textContent = 'Exibindo: Kanban';
        statusDot.className = 'status-dot kanban';
      } else {
        statusText. textContent = 'Exibindo: Segurança';
        statusDot. className = 'status-dot seguranca';
      }
    }

    function switchSlide() {
      if (currentSlide === 'kanban') {
        kanbanSlide.classList.remove('active');
        kanbanSlide.classList.add('fade-out');
        
        setTimeout(function() {
          segurancaSlide.classList.remove('fade-out');
          segurancaSlide.classList. add('active');
          currentSlide = 'seguranca';
          timeRemaining = config. timeSeguranca * 60;
          updateStatus('seguranca', timeRemaining);
          scheduleNextSwitch();
        }, config.transitionTime * 1000);
      } else {
        segurancaSlide.classList.remove('active');
        segurancaSlide.classList.add('fade-out');
        
        setTimeout(function() {
          kanbanSlide. classList.remove('fade-out');
          kanbanSlide. classList.add('active');
          currentSlide = 'kanban';
          timeRemaining = config. timeKanban * 60;
          updateStatus('kanban', timeRemaining);
          scheduleNextSwitch();
        }, config.transitionTime * 1000);
      }
    }

    function scheduleNextSwitch() {
      if (timer) clearTimeout(timer);
      if (countdownTimer) clearInterval(countdownTimer);
      
      var currentTime = currentSlide === 'kanban' ? config.timeKanban : config.timeSeguranca;
      timeRemaining = currentTime * 60;
      
      countdownTimer = setInterval(function() {
        timeRemaining--;
        if (timeRemaining > 0) {
          updateStatus(currentSlide, timeRemaining);
        } else {
          clearInterval(countdownTimer);
        }
      }, 1000);
      
      timer = setTimeout(function() {
        switchSlide();
      }, currentTime * 60 * 1000);
    }

    function startCycle() {
      timeRemaining = config. timeKanban * 60;
      updateStatus('kanban', timeRemaining);
      scheduleNextSwitch();
    }

    function resetCycle() {
      if (timer) clearTimeout(timer);
      if (countdownTimer) clearInterval(countdownTimer);
      
      currentSlide = 'kanban';
      segurancaSlide.classList.remove('active');
      segurancaSlide.classList.add('fade-out');
      kanbanSlide.classList.remove('fade-out');
      kanbanSlide. classList.add('active');
      
      updateTransitionTime();
      startCycle();
    }

    function adicionarMensagem() {
      var texto = document.getElementById('novaMensagemTexto').value. trim();
      var cor = document.getElementById('novaMensagemCor').value;
      var tamanho = document. getElementById('novaMensagemTamanho').value;

      if (! texto) {
        alert('Digite uma mensagem! ');
        return;
      }

      google.script.run
        . withSuccessHandler(function(result) {
          if (result.success) {
            document.getElementById('novaMensagemTexto').value = '';
            carregarMensagens();
            alert('Mensagem adicionada com sucesso!');
          } else {
            alert('Erro ao adicionar mensagem: ' + (result.error || 'Erro desconhecido'));
          }
        })
        .withFailureHandler(function(error) {
          alert('Erro ao adicionar mensagem: ' + error. message);
        })
        .salvarMensagemApresentacao(texto, cor, tamanho);
    }

    function deletarMensagem(mensagemId) {
      if (! confirm('Tem certeza que deseja deletar esta mensagem?')) return;

      google.script. run
        .withSuccessHandler(function(result) {
          if (result.success) {
            carregarMensagens();
          } else {
            alert('Erro ao deletar mensagem: ' + (result. error || 'Erro desconhecido'));
          }
        })
        . withFailureHandler(function(error) {
          alert('Erro ao deletar mensagem: ' + error.message);
        })
        .deletarMensagemApresentacao(mensagemId);
    }

    function carregarMensagens() {
      google.script.run
        .withSuccessHandler(function(result) {
          mensagens = result || [];
          atualizarListaMensagens();
          atualizarMensagensDisplay();
        })
        .withFailureHandler(function(error) {
          console.error('Erro ao carregar mensagens:', error);
        })
        .getMensagensApresentacao();
    }

    function atualizarListaMensagens() {
      var container = document.getElementById('listaMensagens');
      container.innerHTML = '';

      if (mensagens.length === 0) {
        container.innerHTML = '<div style="color: rgba(255,255,255,0.5); font-size: 11px; text-align: center; padding: 10px;">Nenhuma mensagem cadastrada</div>';
        return;
      }

      for (var i = 0; i < mensagens.length; i++) {
        var mensagem = mensagens[i];
        var div = document.createElement('div');
        div.className = 'mensagem-item';
        
        var textoDiv = document.createElement('div');
        textoDiv.className = 'mensagem-item-texto';
        textoDiv. style.color = mensagem.cor;
        textoDiv.textContent = mensagem. texto;
        
        var acoesDiv = document. createElement('div');
        acoesDiv.className = 'mensagem-item-acoes';
        
        var btnDeletar = document.createElement('button');
        btnDeletar. className = 'deletar';
        btnDeletar.innerHTML = '&#128465;';
        btnDeletar.title = 'Deletar';
        btnDeletar.setAttribute('data-id', mensagem.id);
        btnDeletar.onclick = function() {
          var id = this.getAttribute('data-id');
          deletarMensagem(id);
        };
        
        acoesDiv.appendChild(btnDeletar);
        div.appendChild(textoDiv);
        div.appendChild(acoesDiv);
        container.appendChild(div);
      }
    }

    function atualizarMensagensDisplay() {
      var container = document.getElementById('mensagensDisplay');
      container.innerHTML = '';

      if (mensagens.length === 0) return;

      for (var i = 0; i < mensagens.length; i++) {
        var mensagem = mensagens[i];
        var div = document.createElement('div');
        div.className = 'mensagem-display ' + mensagem.tamanho;
        div.style.color = mensagem.cor;
        div.style.borderLeftColor = mensagem. cor;
        div.textContent = mensagem. texto;
        container.appendChild(div);
      }
    }

    function iniciarSincronizacao() {
      carregarMensagens();
      if (syncInterval) clearInterval(syncInterval);
      syncInterval = setInterval(function() {
        carregarMensagens();
      }, 3000);
    }

    toggleControls. addEventListener('click', function() {
      controls.classList.toggle('visible');
    });

    document.getElementById('btnApplySettings').addEventListener('click', function() {
      applySettings();
    });

    document.getElementById('btnAdicionarMensagem').addEventListener('click', function() {
      adicionarMensagem();
    });

    document.getElementById('novaMensagemTexto').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        adicionarMensagem();
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e. key === 'Escape') {
        controls.classList.toggle('visible');
      } else if (e. key === 'ArrowRight' || e.key === 'ArrowLeft') {
        if (timer) clearTimeout(timer);
        switchSlide();
      }
    });

    var presentationModeTimer = setTimeout(function() {
      document.body.classList.add('presentation-mode');
    }, 3000);

    document.addEventListener('mousemove', function() {
      clearTimeout(presentationModeTimer);
      document.body.classList. remove('presentation-mode');
      presentationModeTimer = setTimeout(function() {
        document.body.classList.add('presentation-mode');
      }, 3000);
    });

    setInterval(function() {
      if (currentSlide === 'kanban') {
        kanbanFrame.src = kanbanFrame.src;
      } else {
        segurancaFrame.src = segurancaFrame.src;
      }
    }, 300000);

    loadSettings();
    updateTransitionTime();
    startCycle();
    iniciarSincronizacao();
  </script>
</body>

</html>