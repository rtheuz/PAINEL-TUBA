<! DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apresenta√ß√£o - Kanban e Seguran√ßa</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Montserrat', sans-serif;
    }

    body {
      position: relative;
      background: #000;
    }

    .slide-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
      pointer-events: none;
    }

    .slide-container.active {
      opacity: 1;
      pointer-events: auto;
      z-index: 2;
    }

    .slide-container.fade-out {
      opacity: 0;
      z-index: 1;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    .controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 14px;
      backdrop-filter: blur(10px);
      display: none;
      flex-direction: column;
      gap: 10px;
      min-width: 250px;
    }

    .controls.visible {
      display: flex;
    }

    .controls h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 8px;
    }

    .control-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .control-item label {
      font-size: 13px;
    }

    .control-item input {
      width: 80px;
      padding: 5px 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 13px;
    }

    .control-item input:focus {
      outline: none;
      border-color: #4ecdc4;
      background: rgba(255, 255, 255, 0.2);
    }

    .toggle-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1001;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .toggle-controls:hover {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    .status-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4ecdc4;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.5;
        transform: scale(1.2);
      }
    }

    .status-dot.kanban {
      background: #1a73e8;
    }

    .status-dot.seguranca {
      background: #ff6b6b;
    }

    .countdown {
      font-weight: 600;
      color: #4ecdc4;
    }

    body.presentation-mode .controls,
    body.presentation-mode .toggle-controls,
    body.presentation-mode .status-indicator {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }

    body.presentation-mode:hover .controls,
    body.presentation-mode:hover .toggle-controls,
    body.presentation-mode:hover .status-indicator {
      opacity: 1;
      pointer-events: auto;
    }

    .mensagem-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .mensagem-item-texto {
      flex: 1;
      color: rgba(255, 255, 255, 0.9);
      word-break: break-word;
    }

    .mensagem-item-acoes {
      display: flex;
      gap: 5px;
      margin-left: 10px;
    }

    .mensagem-item-acoes button {
      padding: 4px 8px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .mensagem-item-acoes button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .mensagem-item-acoes button.deletar {
      background: rgba(255, 107, 107, 0.5);
    }

    .mensagem-item-acoes button.deletar:hover {
      background: rgba(255, 107, 107, 0.7);
    }

    .mensagem-display {
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 20px;
      margin-bottom: 10px;
      border-radius: 10px;
      border-left: 4px solid;
      backdrop-filter: blur(10px);
      animation: slideIn 0.5s ease-out;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .mensagem-display.small { font-size: 16px; }
    .mensagem-display.medium { font-size: 24px; }
    .mensagem-display.large { font-size: 32px; }
    .mensagem-display.xlarge { font-size: 48px; font-weight: 600; }

    /* Notifica√ß√£o de novo or√ßamento */
    .notificacao-novo-orcamento {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-in;
    }

    .notificacao-novo-orcamento.ativo {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .notificacao-conteudo {
      background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
      color: white;
      padding: 40px 60px;
      border-radius: 20px;
      text-align: center;
      max-width: 600px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: pulse 2s ease-in-out infinite;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .notificacao-conteudo h2 {
      margin: 0 0 20px 0;
      font-size: 36px;
      font-weight: 600;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .notificacao-conteudo p {
      margin: 0 0 30px 0;
      font-size: 20px;
      opacity: 0.95;
    }

    .notificacao-conteudo button {
      background: white;
      color: #1a73e8;
      border: none;
      padding: 15px 40px;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .notificacao-conteudo button:hover {
      background: #f0f0f0;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .notificacao-conteudo button:active {
      transform: translateY(0);
    }
  </style>
</head>

<body>
  <div class="slide-container active" id="kanbanSlide">
    <iframe id="kanbanFrame" src=""></iframe>
  </div>

  <div class="slide-container" id="segurancaSlide">
    <iframe id="segurancaFrame" src=""></iframe>
  </div>

  <div class="status-indicator" id="statusIndicator">
    <div class="status-dot kanban" id="statusDot"></div>
    <span id="statusText">Carregando...</span>
    <span class="countdown" id="countdown"></span>
  </div>

  <button class="toggle-controls" id="toggleControls" title="Mostrar/Ocultar Controles">&#9881;</button>

  <div class="controls" id="controls">
    <h3>&#9881; Configura√ß√µes</h3>
    <div class="control-item">
      <label>Tempo Kanban (minutos):</label>
      <input type="number" id="timeKanban" min="1" max="60" value="5">
    </div>
    <div class="control-item">
      <label>Tempo Seguran√ßa (minutos):</label>
      <input type="number" id="timeSeguranca" min="1" max="60" value="1">
    </div>
    <div style="margin-top: 5px; padding: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; font-size: 12px; color: rgba(255, 255, 255, 0.8);">
      O Kanban √© exibido predominantemente.  A Seguran√ßa aparece brevemente entre os ciclos.
    </div>
    <div class="control-item">
      <label>Transi√ß√£o (segundos):</label>
      <input type="number" id="transitionTime" min="0.5" max="5" step="0.5" value="1.5">
    </div>
    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.3);">
      <button id="btnApplySettings" style="width: 100%; padding: 8px; background: #4ecdc4; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
        Aplicar Configura√ß√µes
      </button>
    </div>
    
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.3);">
      <h3 style="margin: 0 0 10px 0; font-size: 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.3); padding-bottom: 8px;">Mensagens</h3>
      <div style="margin-bottom: 10px;">
        <input type="text" id="novaMensagemTexto" placeholder="Digite a mensagem..." 
               style="width: 100%; padding: 8px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 13px; margin-bottom: 8px;">
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <select id="novaMensagemCor" style="flex: 1; padding: 6px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: rgb(48, 48, 48); font-size: 12px;">
            <option value="#ffffff">Branco</option>
            <option value="#ff6b6b">Vermelho</option>
            <option value="#4ecdc4">Ciano</option>
            <option value="#1a73e8">Azul</option>
            <option value="#ffd93d">Amarelo</option>
            <option value="#6bcf7f">Verde</option>
          </select>
          <select id="novaMensagemTamanho" style="flex: 1; padding: 6px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: (48, 48, 48); font-size: 12px;">
            <option value="small">Pequeno</option>
            <option value="medium" selected>M√©dio</option>
            <option value="large">Grande</option>
            <option value="xlarge">Muito Grande</option>
          </select>
        </div>
        <button id="btnAdicionarMensagem" style="width: 100%; padding: 8px; background: #6bcf7f; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
          Adicionar Mensagem
        </button>
      </div>
      <div id="listaMensagens" style="max-height: 200px; overflow-y: auto;"></div>
    </div>
  </div>
  
  <div id="mensagensDisplay" style="position: fixed; top: 60px; left: 20px; right: 20px; z-index: 999; pointer-events: none;"></div>

    <!-- Notifica√ß√£o de novo or√ßamento -->
  <div class="notificacao-novo-orcamento" id="notificacaoNovoOrcamento">
    <div class="notificacao-conteudo">
      <h2>üîî Novo Or√ßamento!</h2>
      <p>Um novo or√ßamento entrou na aba de <strong>Rascunho</strong></p>
      <button id="btnConfirmarNotificacao">Confirmar Visualiza√ß√£o</button>
    </div>
  </div>

  <!-- Notifica√ß√£o breve de novo projeto em prepara√ß√£o -->
  <div class="notificacao-preparacao" id="notificacaoPreparacao" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10001; background: linear-gradient(135deg, #ff9800 0%, #ff6b00 100%); color: white; padding: 20px 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); display: none; animation: slideDown 0.5s ease-out; max-width: 500px; text-align: center;">
    <h3 style="margin: 0 0 10px 0; font-size: 24px; font-weight: 600;">‚öôÔ∏è Novo Projeto em Prepara√ß√£o!</h3>
    <p id="mensagemPreparacao" style="margin: 0; font-size: 16px; opacity: 0.95;"></p>
  </div>

  <style>
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
  </style>

  <!-- √Åudio para notifica√ß√£o ser√° gerado via Web Audio API -->

  <script>
    var WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyqo2sqE_x5VhtQPInTBS4XO78vk-S0Ec2LbgDtbUYVyX98oOA_oh4VRMdrmk8DBWvx6g/exec";
    
    var config = {
      timeKanban: 10,
      timeSeguranca: 1,
      transitionTime: 1.5
    };

    var currentSlide = 'kanban';
    var timer = null;
    var countdownTimer = null;
    var timeRemaining = 0;
    var mensagens = [];
    var syncInterval = null;
    var orcamentosRascunhoVistos = new Set(); // IDs dos or√ßamentos j√° vistos
    var notificacaoAtiva = false;
    var audioContext = null; // Contexto de √°udio reutiliz√°vel
    var intervaloAudio = null;
    var intervaloVerificacao = null;
    var primeiraVerificacao = true; // Flag para marcar or√ßamentos existentes como vistos
    var ultimaConfirmacaoVerificada = null; // Timestamp da √∫ltima confirma√ß√£o verificada
    var intervaloVerificacaoConfirmacao = null; // Intervalo para verificar confirma√ß√µes
    var timestampNotificacaoAtual = null; // Timestamp da notifica√ß√£o atual
    var orcamentosNotificacaoAtual = []; // Or√ßamentos da notifica√ß√£o atual
    var projetosPreparacaoVistos = new Set(); // IDs dos projetos em prepara√ß√£o j√° vistos
    var primeiraVerificacaoPreparacao = true; // Flag para marcar projetos existentes como vistos
    var intervaloAudioPreparacao = null; // Intervalo de √°udio para notifica√ß√£o de prepara√ß√£o

    var kanbanSlide = document.getElementById('kanbanSlide');
    var segurancaSlide = document.getElementById('segurancaSlide');
    var kanbanFrame = document. getElementById('kanbanFrame');
    var segurancaFrame = document.getElementById('segurancaFrame');
    var statusText = document.getElementById('statusText');
    var statusDot = document.getElementById('statusDot');
    var countdown = document. getElementById('countdown');
    var toggleControls = document.getElementById('toggleControls');
    var controls = document.getElementById('controls');

    function getToken() {
      var urlParams = new URLSearchParams(window.location.search);
      var urlToken = urlParams. get('token');
      if (urlToken) {
        localStorage.setItem('token', urlToken);
        return urlToken;
      }
      return localStorage.getItem('token');
    }

    var token = getToken();

    var kanbanUrl = token 
      ?  WEBAPP_URL + "?page=kanban&token=" + token
      : WEBAPP_URL + "?page=kanban";
    var segurancaUrl = WEBAPP_URL + "?page=seguranca";

    kanbanFrame.src = kanbanUrl;
    segurancaFrame.src = segurancaUrl;

    function loadSettings() {
      var saved = localStorage.getItem('apresentacaoConfig');
      if (saved) {
        config = JSON.parse(saved);
        document.getElementById('timeKanban').value = config.timeKanban;
        document.getElementById('timeSeguranca').value = config.timeSeguranca;
        document.getElementById('transitionTime').value = config.transitionTime;
      }
    }

    function saveSettings() {
      localStorage.setItem('apresentacaoConfig', JSON.stringify(config));
    }

    function applySettings() {
      config.timeKanban = parseInt(document.getElementById('timeKanban').value) || 5;
      config.timeSeguranca = parseInt(document.getElementById('timeSeguranca').value) || 1;
      config.transitionTime = parseFloat(document.getElementById('transitionTime'). value) || 1.5;
      saveSettings();
      resetCycle();
      alert('Configura√ß√µes aplicadas!  O ciclo ser√° reiniciado.');
    }

    function updateTransitionTime() {
      var style = document.createElement('style');
      style.textContent = '. slide-container { transition: opacity ' + config.transitionTime + 's ease-in-out; }';
      document.head.appendChild(style);
    }

    function updateStatus(slide, timeLeft) {
      var minutes = Math.floor(timeLeft / 60);
      var seconds = Math.floor(timeLeft % 60);
      countdown.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
      
      if (slide === 'kanban') {
        statusText.textContent = 'Exibindo: Kanban';
        statusDot.className = 'status-dot kanban';
      } else {
        statusText. textContent = 'Exibindo: Seguran√ßa';
        statusDot. className = 'status-dot seguranca';
      }
    }

    function switchSlide() {
      if (currentSlide === 'kanban') {
        kanbanSlide.classList.remove('active');
        kanbanSlide.classList.add('fade-out');
        
        setTimeout(function() {
          segurancaSlide.classList.remove('fade-out');
          segurancaSlide.classList. add('active');
          currentSlide = 'seguranca';
          timeRemaining = config. timeSeguranca * 60;
          updateStatus('seguranca', timeRemaining);
          scheduleNextSwitch();
        }, config.transitionTime * 1000);
      } else {
        segurancaSlide.classList.remove('active');
        segurancaSlide.classList.add('fade-out');
        
        setTimeout(function() {
          kanbanSlide. classList.remove('fade-out');
          kanbanSlide. classList.add('active');
          currentSlide = 'kanban';
          timeRemaining = config. timeKanban * 60;
          updateStatus('kanban', timeRemaining);
          scheduleNextSwitch();
        }, config.transitionTime * 1000);
      }
    }

    function scheduleNextSwitch() {
      if (timer) clearTimeout(timer);
      if (countdownTimer) clearInterval(countdownTimer);
      
      var currentTime = currentSlide === 'kanban' ? config.timeKanban : config.timeSeguranca;
      timeRemaining = currentTime * 60;
      
      countdownTimer = setInterval(function() {
        timeRemaining--;
        if (timeRemaining > 0) {
          updateStatus(currentSlide, timeRemaining);
        } else {
          clearInterval(countdownTimer);
        }
      }, 1000);
      
      timer = setTimeout(function() {
        switchSlide();
      }, currentTime * 60 * 1000);
    }

    function startCycle() {
      timeRemaining = config. timeKanban * 60;
      updateStatus('kanban', timeRemaining);
      scheduleNextSwitch();
    }

    function resetCycle() {
      if (timer) clearTimeout(timer);
      if (countdownTimer) clearInterval(countdownTimer);
      
      currentSlide = 'kanban';
      segurancaSlide.classList.remove('active');
      segurancaSlide.classList.add('fade-out');
      kanbanSlide.classList.remove('fade-out');
      kanbanSlide. classList.add('active');
      
      updateTransitionTime();
      startCycle();
    }

    function adicionarMensagem() {
      var texto = document.getElementById('novaMensagemTexto').value. trim();
      var cor = document.getElementById('novaMensagemCor').value;
      var tamanho = document. getElementById('novaMensagemTamanho').value;

      if (! texto) {
        alert('Digite uma mensagem! ');
        return;
      }

      google.script.run
        . withSuccessHandler(function(result) {
          if (result.success) {
            document.getElementById('novaMensagemTexto').value = '';
            carregarMensagens();
            alert('Mensagem adicionada com sucesso!');
          } else {
            alert('Erro ao adicionar mensagem: ' + (result.error || 'Erro desconhecido'));
          }
        })
        .withFailureHandler(function(error) {
          alert('Erro ao adicionar mensagem: ' + error. message);
        })
        .salvarMensagemApresentacao(texto, cor, tamanho);
    }

    function deletarMensagem(mensagemId) {
      if (! confirm('Tem certeza que deseja deletar esta mensagem?')) return;

      google.script. run
        .withSuccessHandler(function(result) {
          if (result.success) {
            carregarMensagens();
          } else {
            alert('Erro ao deletar mensagem: ' + (result. error || 'Erro desconhecido'));
          }
        })
        . withFailureHandler(function(error) {
          alert('Erro ao deletar mensagem: ' + error.message);
        })
        .deletarMensagemApresentacao(mensagemId);
    }

    function carregarMensagens() {
      google.script.run
        .withSuccessHandler(function(result) {
          mensagens = result || [];
          atualizarListaMensagens();
          atualizarMensagensDisplay();
        })
        .withFailureHandler(function(error) {
          console.error('Erro ao carregar mensagens:', error);
        })
        .getMensagensApresentacao();
    }

    function atualizarListaMensagens() {
      var container = document.getElementById('listaMensagens');
      container.innerHTML = '';

      if (mensagens.length === 0) {
        container.innerHTML = '<div style="color: rgba(255,255,255,0.5); font-size: 11px; text-align: center; padding: 10px;">Nenhuma mensagem cadastrada</div>';
        return;
      }

      for (var i = 0; i < mensagens.length; i++) {
        var mensagem = mensagens[i];
        var div = document.createElement('div');
        div.className = 'mensagem-item';
        
        var textoDiv = document.createElement('div');
        textoDiv.className = 'mensagem-item-texto';
        textoDiv. style.color = mensagem.cor;
        textoDiv.textContent = mensagem. texto;
        
        var acoesDiv = document. createElement('div');
        acoesDiv.className = 'mensagem-item-acoes';
        
        var btnDeletar = document.createElement('button');
        btnDeletar. className = 'deletar';
        btnDeletar.innerHTML = '&#128465;';
        btnDeletar.title = 'Deletar';
        btnDeletar.setAttribute('data-id', mensagem.id);
        btnDeletar.onclick = function() {
          var id = this.getAttribute('data-id');
          deletarMensagem(id);
        };
        
        acoesDiv.appendChild(btnDeletar);
        div.appendChild(textoDiv);
        div.appendChild(acoesDiv);
        container.appendChild(div);
      }
    }

    function atualizarMensagensDisplay() {
      var container = document.getElementById('mensagensDisplay');
      container.innerHTML = '';

      if (mensagens.length === 0) return;

      for (var i = 0; i < mensagens.length; i++) {
        var mensagem = mensagens[i];
        var div = document.createElement('div');
        div.className = 'mensagem-display ' + mensagem.tamanho;
        div.style.color = mensagem.cor;
        div.style.borderLeftColor = mensagem. cor;
        div.textContent = mensagem. texto;
        container.appendChild(div);
      }
    }

    function iniciarSincronizacao() {
      carregarMensagens();
      if (syncInterval) clearInterval(syncInterval);
      syncInterval = setInterval(function() {
        carregarMensagens();
      }, 3000);
    }

    // Fun√ß√£o para verificar novos or√ßamentos em rascunho
    function verificarNovosOrcamentos() {
      // S√≥ verifica quando o slide do kanban est√° ativo
      if (currentSlide !== 'kanban' || notificacaoAtiva) return;

      // Primeiro tenta via API (mais confi√°vel)
      verificarNovosOrcamentosViaAPI();

      // Tamb√©m tenta acessar o iframe diretamente (pode funcionar se mesmo dom√≠nio)
      try {
        var iframe = document.getElementById('kanbanFrame');
        if (!iframe || !iframe.contentWindow) return;

        // Tenta acessar o conte√∫do do iframe (pode falhar por CORS)
        var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        if (!iframeDoc || !iframeDoc.querySelector) return;
        
        // Procura pela coluna de rascunho
        var colunas = iframeDoc.querySelectorAll('.column');
        var colunaRascunho = null;
        
        for (var i = 0; i < colunas.length; i++) {
          var titulo = colunas[i].querySelector('.column-title');
          if (titulo && (titulo.textContent.toLowerCase().includes('rascunho') || 
                         titulo.textContent.toLowerCase().includes('or√ßamento'))) {
            // Verifica se tem cards de rascunho
            var cards = colunas[i].querySelectorAll('.card.orc-rascunho');
            if (cards.length > 0) {
              colunaRascunho = colunas[i];
              break;
            }
          }
        }

        if (!colunaRascunho) return;

        // Obt√©m todos os cards de rascunho
        var cardsRascunho = colunaRascunho.querySelectorAll('.card.orc-rascunho');
        var novosOrcamentos = [];

        for (var j = 0; j < cardsRascunho.length; j++) {
          var card = cardsRascunho[j];
          var cliente = card.dataset.cliente || '';
          var projeto = card.dataset.projeto || '';
          var id = cliente + '|' + projeto;

          if (!id || id === '|') continue;

          // Na primeira verifica√ß√£o, marca todos como vistos (n√£o s√£o novos)
          if (primeiraVerificacao) {
            orcamentosRascunhoVistos.add(id);
          } else if (!orcamentosRascunhoVistos.has(id)) {
            // Se n√£o foi visto antes e n√£o √© a primeira verifica√ß√£o, √© novo
            novosOrcamentos.push({
              id: id,
              cliente: cliente,
              projeto: projeto
            });
            orcamentosRascunhoVistos.add(id);
          }
        }

        // Ap√≥s a primeira verifica√ß√£o, marca a flag como false
        if (primeiraVerificacao) {
          primeiraVerificacao = false;
        }

        // Se encontrou novos or√ßamentos, exibe notifica√ß√£o
        if (novosOrcamentos.length > 0) {
          exibirNotificacaoNovoOrcamento(novosOrcamentos);
        }
      } catch (e) {
        // Ignora erros de CORS - j√° tentamos via API
      }
    }

    // M√©todo alternativo: verificar via API se o iframe n√£o for acess√≠vel
    function verificarNovosOrcamentosViaAPI() {
      if (notificacaoAtiva) return;

      // Tenta fazer uma requisi√ß√£o para obter dados do kanban
      if (window.google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(data) {
            if (!data || notificacaoAtiva) return;

            // Procura pela coluna de rascunho nos dados
            // Verifica todas as colunas que podem conter rascunhos
            var colunaRascunho = null;
            var colunaOrcamento = null;
            
            for (var status in data) {
              var statusLower = status.toLowerCase();
              if (statusLower.includes('rascunho')) {
                colunaRascunho = data[status];
              } else if (statusLower.includes('or√ßamento') || statusLower.includes('orcamento')) {
                colunaOrcamento = data[status];
              }
            }

            // Usa a coluna de rascunho se encontrada, sen√£o usa a de or√ßamento
            var colunaParaVerificar = colunaRascunho || colunaOrcamento;
            if (!colunaParaVerificar || !Array.isArray(colunaParaVerificar)) return;

            // Verifica novos or√ßamentos
            var novosOrcamentos = [];
            for (var i = 0; i < colunaParaVerificar.length; i++) {
              var orcamento = colunaParaVerificar[i];
              var cliente = orcamento.cliente || '';
              var projeto = orcamento.projeto || '';
              var id = cliente + '|' + projeto;

              if (!id || id === '|') continue; // Ignora or√ßamentos sem identifica√ß√£o

              // Verifica se √© rascunho
              var statusOrc = orcamento.statusOrcamento || orcamento.status || '';
              var statusLower = statusOrc.toString().toLowerCase();
              
              // Considera rascunho se:
              // 1. Est√° na coluna de rascunho, OU
              // 2. O status cont√©m "rascunho", OU
              // 3. Est√° na coluna de or√ßamento e n√£o tem status definido (assumimos que √© rascunho)
              var isRascunho = colunaRascunho !== null || 
                               statusLower.includes('rascunho') ||
                               (colunaOrcamento !== null && !statusOrc);

              if (isRascunho) {
                // Na primeira verifica√ß√£o, marca todos como vistos (n√£o s√£o novos)
                if (primeiraVerificacao) {
                  orcamentosRascunhoVistos.add(id);
                } else if (!orcamentosRascunhoVistos.has(id)) {
                  // Se n√£o foi visto antes e n√£o √© a primeira verifica√ß√£o, √© novo
                  novosOrcamentos.push({
                    id: id,
                    cliente: cliente,
                    projeto: projeto
                  });
                  orcamentosRascunhoVistos.add(id);
                }
              }
            }

            // Ap√≥s a primeira verifica√ß√£o, marca a flag como false
            if (primeiraVerificacao) {
              primeiraVerificacao = false;
            }

            if (novosOrcamentos.length > 0) {
              exibirNotificacaoNovoOrcamento(novosOrcamentos);
            }
          })
          .withFailureHandler(function(error) {
            // Silenciosamente ignora erros - pode n√£o ter acesso √† API
            console.log('N√£o foi poss√≠vel verificar or√ßamentos via API');
          })
          .getKanbanData();
      } else {
        // Se n√£o tem google.script, tenta fazer requisi√ß√£o HTTP direta
        try {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', WEBAPP_URL + '?page=kanban' + (token ? '&token=' + token : ''), true);
          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
              // Se retornar HTML, n√£o podemos processar facilmente
              // Neste caso, confiamos apenas no m√©todo do iframe
            }
          };
          xhr.send();
        } catch (e) {
          // Ignora erros
        }
      }
    }

    // Fun√ß√£o para exibir a notifica√ß√£o
    function exibirNotificacaoNovoOrcamento(novosOrcamentos) {
      if (notificacaoAtiva) {
        // Se j√° h√° notifica√ß√£o ativa, adiciona os novos or√ßamentos √† lista
        orcamentosNotificacaoAtual = orcamentosNotificacaoAtual.concat(novosOrcamentos);
        atualizarMensagemNotificacao();
        return;
      }

      var novoTimestamp = new Date().getTime();
      notificacaoAtiva = true;
      timestampNotificacaoAtual = novoTimestamp;
      ultimaConfirmacaoVerificada = null; // Reseta a confirma√ß√£o anterior para nova notifica√ß√£o
      orcamentosNotificacaoAtual = novosOrcamentos;
      
      // Salva no servidor que h√° notifica√ß√µes pendentes
      salvarOrcamentosPendentesNoServidor(novosOrcamentos);
      
      atualizarMensagemNotificacao();
      
      var notificacao = document.getElementById('notificacaoNovoOrcamento');
      notificacao.classList.add('ativo');

      // Inicia o som de notifica√ß√£o
      iniciarSomNotificacao();
      
      // Verifica imediatamente se h√° confirma√ß√£o pendente (para ignorar confirma√ß√µes antigas)
      setTimeout(function() {
        verificarEIgnorarConfirmacoesAntigas(novoTimestamp);
      }, 500);
    }
    
    // Verifica e ignora confirma√ß√µes antigas (anteriores ao timestamp da notifica√ß√£o)
    function verificarEIgnorarConfirmacoesAntigas(timestampNotificacao) {
      if (!notificacaoAtiva || timestampNotificacaoAtual !== timestampNotificacao) return;
      
      if (window.google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (!notificacaoAtiva || timestampNotificacaoAtual !== timestampNotificacao) return;
            
            if (result && result.confirmado && result.timestamp) {
              var timestampConfirmacao = result.timestamp;
              
              // Se a confirma√ß√£o √© anterior ou igual ao timestamp da notifica√ß√£o, ignora
              // Isso evita que confirma√ß√µes antigas fechem notifica√ß√µes novas
              if (timestampConfirmacao <= timestampNotificacao) {
                // Confirma√ß√£o antiga - atualiza ultimaConfirmacaoVerificada para ignor√°-la
                ultimaConfirmacaoVerificada = timestampConfirmacao;
              }
            }
          })
          .withFailureHandler(function(error) {
            // Silenciosamente ignora erros
          })
          .verificarConfirmacaoNotificacaoOrcamento();
      }
    }

    // Atualiza a mensagem da notifica√ß√£o com os or√ßamentos atuais
    function atualizarMensagemNotificacao() {
      var notificacao = document.getElementById('notificacaoNovoOrcamento');
      var conteudo = notificacao.querySelector('.notificacao-conteudo p');
      
      if (orcamentosNotificacaoAtual.length === 1) {
        conteudo.innerHTML = 'Um novo or√ßamento entrou na aba de <strong>Rascunho</strong><br>' +
                            '<small>Cliente: ' + orcamentosNotificacaoAtual[0].cliente + '</small>';
      } else {
        conteudo.innerHTML = '<strong>' + orcamentosNotificacaoAtual.length + '</strong> novos or√ßamentos entraram na aba de <strong>Rascunho</strong>';
      }
    }

    // Salva or√ßamentos pendentes no servidor
    function salvarOrcamentosPendentesNoServidor(orcamentos) {
      if (window.google && google.script && google.script.run) {
        var ids = orcamentos.map(function(o) { return o.id; });
        google.script.run
          .withSuccessHandler(function(result) {
            // Silenciosamente salva
          })
          .withFailureHandler(function(error) {
            console.log('Erro ao salvar or√ßamentos pendentes:', error);
          })
          .salvarOrcamentosPendentesNotificacao(ids);
      }
    }

    // Fun√ß√£o para gerar e tocar som de notifica√ß√£o
    function tocarSomNotificacao() {
      if (!notificacaoAtiva) return; // N√£o toca se a notifica√ß√£o n√£o est√° ativa
      
      try {
        // Cria ou reutiliza o contexto de √°udio
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        // Se o contexto estiver suspenso, resume
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
        
        var currentTime = audioContext.currentTime;
        var oscillator = audioContext.createOscillator();
        var gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Configura um som de alerta (duas notas)
        oscillator.frequency.setValueAtTime(800, currentTime);
        oscillator.frequency.setValueAtTime(1000, currentTime + 0.1);
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.3);

        oscillator.start(currentTime);
        oscillator.stop(currentTime + 0.3);

        // Toca uma segunda nota ap√≥s um pequeno delay
        setTimeout(function() {
          if (!notificacaoAtiva) return; // Verifica novamente antes de tocar segunda nota
          
          try {
            var oscillator2 = audioContext.createOscillator();
            var gainNode2 = audioContext.createGain();

            oscillator2.connect(gainNode2);
            gainNode2.connect(audioContext.destination);

            var currentTime2 = audioContext.currentTime;
            oscillator2.frequency.setValueAtTime(1000, currentTime2);
            oscillator2.frequency.setValueAtTime(1200, currentTime2 + 0.1);
            oscillator2.type = 'sine';

            gainNode2.gain.setValueAtTime(0.3, currentTime2);
            gainNode2.gain.exponentialRampToValueAtTime(0.01, currentTime2 + 0.3);

            oscillator2.start(currentTime2);
            oscillator2.stop(currentTime2 + 0.3);
          } catch (e) {
            console.log('Erro ao tocar segunda nota:', e);
          }
        }, 150);
      } catch (e) {
        console.log('Erro ao criar √°udio:', e);
        // Fallback: usa beep do sistema
        try {
          var audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OSdTQ8OUKjk8LZjHAY4kdfyzHksBSR3x/Dej0AKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknU0PDlCo5PC2YxwGOJHX8sx5LAUkd8fw3o9AChRetOnrqFUU');
          audio.volume = 0.5;
          audio.play().catch(function(err) {
            console.log('Erro ao tocar √°udio fallback:', err);
          });
        } catch (e2) {
          console.log('Erro no fallback de √°udio:', e2);
        }
      }
    }

    // Fun√ß√£o para tocar o som repetidamente (limitado a 10 segundos)
    function iniciarSomNotificacao() {
      // Para qualquer intervalo anterior
      pararSomNotificacao();
      
      // Toca o som imediatamente
      tocarSomNotificacao();

      var tempoInicio = Date.now();
      var duracaoMaxima = 10000; // 10 segundos em milissegundos

      // Configura para tocar a cada 3 segundos, mas apenas por 10 segundos
      intervaloAudio = setInterval(function() {
        var tempoDecorrido = Date.now() - tempoInicio;
        
        if (tempoDecorrido >= duracaoMaxima) {
          // Para o som ap√≥s 10 segundos
          pararSomNotificacao();
          return;
        }
        
        if (notificacaoAtiva) {
          tocarSomNotificacao();
        } else {
          pararSomNotificacao();
        }
      }, 3000);
    }

    // Fun√ß√£o para parar o som de notifica√ß√£o de or√ßamento
    function pararSomNotificacao() {
      if (intervaloAudio) {
        clearInterval(intervaloAudio);
        intervaloAudio = null;
      }
    }

    // Fun√ß√£o para confirmar a visualiza√ß√£o
    function confirmarVisualizacao() {
      // Salva a confirma√ß√£o no servidor para sincronizar com outras inst√¢ncias
      var timestamp = new Date().getTime();
      
      if (window.google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              // Confirma√ß√£o salva com sucesso
              fecharNotificacaoLocal();
            } else {
              // Se falhar, fecha localmente mesmo assim
              fecharNotificacaoLocal();
            }
          })
          .withFailureHandler(function(error) {
            // Se falhar, fecha localmente mesmo assim
            console.log('Erro ao salvar confirma√ß√£o:', error);
            fecharNotificacaoLocal();
          })
          .confirmarNotificacaoOrcamento(timestamp);
      } else {
        // Se n√£o tem acesso ao Google Apps Script, fecha localmente
        fecharNotificacaoLocal();
      }
    }

    // Fun√ß√£o para fechar a notifica√ß√£o localmente
    function fecharNotificacaoLocal() {
      // S√≥ fecha se realmente estiver ativa
      if (!notificacaoAtiva) return;
      
      notificacaoAtiva = false;
      var timestampFechamento = new Date().getTime();
      timestampNotificacaoAtual = null;
      orcamentosNotificacaoAtual = [];
      var notificacao = document.getElementById('notificacaoNovoOrcamento');
      notificacao.classList.remove('ativo');
      pararSomNotificacao();
      ultimaConfirmacaoVerificada = timestampFechamento;
    }

    // Fun√ß√£o para verificar se houve confirma√ß√£o de outra inst√¢ncia
    function verificarConfirmacaoRemota() {
      if (!notificacaoAtiva) return; // S√≥ verifica se h√° notifica√ß√£o ativa
      
      // Garante que temos um timestamp v√°lido
      if (!timestampNotificacaoAtual) {
        // Se por algum motivo n√£o temos timestamp, cria um agora
        timestampNotificacaoAtual = new Date().getTime();
      }

      if (window.google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            // Verifica novamente se ainda est√° ativa (pode ter sido fechada durante a requisi√ß√£o)
            if (!notificacaoAtiva || !timestampNotificacaoAtual) return;
            
            if (result && result.confirmado && result.timestamp) {
              var timestampConfirmacao = result.timestamp;
              
              // S√≥ fecha se a confirma√ß√£o for MAIS RECENTE (n√£o igual) que o timestamp da notifica√ß√£o atual
              // Isso garante que s√≥ fecha quando realmente houve uma confirma√ß√£o AP√ìS a notifica√ß√£o aparecer
              // Usa > ao inv√©s de >= para evitar fechar por confirma√ß√µes simult√¢neas
              if (timestampConfirmacao > timestampNotificacaoAtual) {
                // Confirma√ß√£o √© mais recente que a notifica√ß√£o - fecha
                fecharNotificacaoLocal();
              }
              // N√£o fecha em nenhum outro caso
            }
          })
          .withFailureHandler(function(error) {
            // Silenciosamente ignora erros
          })
          .verificarConfirmacaoNotificacaoOrcamento();
      }
    }

    // Fun√ß√£o para verificar se h√° notifica√ß√µes pendentes ao carregar a p√°gina
    function verificarNotificacoesPendentes() {
      if (notificacaoAtiva) return; // Se j√° h√° notifica√ß√£o ativa, n√£o verifica

      if (window.google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.pendente && result.orcamentos && result.orcamentos.length > 0) {
              // H√° notifica√ß√µes pendentes - verifica se ainda h√° or√ßamentos em rascunho
              verificarOrcamentosPendentesEExibir(result.orcamentos, result.timestamp);
            }
          })
          .withFailureHandler(function(error) {
            // Silenciosamente ignora erros
          })
          .verificarOrcamentosPendentesNotificacao();
      }
    }

    // Verifica se os or√ßamentos pendentes ainda existem e exibe notifica√ß√£o
    function verificarOrcamentosPendentesEExibir(idsPendentes, timestampPendente) {
      // Verifica se h√° confirma√ß√£o mais recente
      if (window.google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(resultConfirmacao) {
            if (resultConfirmacao && resultConfirmacao.confirmado && resultConfirmacao.timestamp) {
              // Se h√° confirma√ß√£o mais recente que a notifica√ß√£o pendente, n√£o exibe
              if (resultConfirmacao.timestamp >= timestampPendente) {
                return;
              }
            }
            
            // Busca os dados do kanban para obter informa√ß√µes dos or√ßamentos
            google.script.run
              .withSuccessHandler(function(dataKanban) {
                if (!dataKanban) return;
                
                // Procura pelos or√ßamentos pendentes nos dados
                var orcamentosEncontrados = [];
                var idsSet = new Set(idsPendentes);
                
                for (var status in dataKanban) {
                  var coluna = dataKanban[status];
                  if (!Array.isArray(coluna)) continue;
                  
                  for (var i = 0; i < coluna.length; i++) {
                    var orcamento = coluna[i];
                    var cliente = orcamento.cliente || '';
                    var projeto = orcamento.projeto || '';
                    var id = cliente + '|' + projeto;
                    
                    if (idsSet.has(id)) {
                      var statusOrc = orcamento.statusOrcamento || orcamento.status || '';
                      var statusLower = statusOrc.toString().toLowerCase();
                      
                      // Verifica se ainda √© rascunho
                      var isRascunho = status.toLowerCase().includes('rascunho') || 
                                      status.toLowerCase().includes('or√ßamento') ||
                                      statusLower.includes('rascunho');
                      
                      if (isRascunho) {
                        orcamentosEncontrados.push({
                          id: id,
                          cliente: cliente,
                          projeto: projeto
                        });
                        orcamentosRascunhoVistos.add(id);
                      }
                    }
                  }
                }
                
                // Se encontrou or√ßamentos ainda em rascunho, exibe notifica√ß√£o
                if (orcamentosEncontrados.length > 0) {
                  // Usa timestamp atual, n√£o o pendente, para evitar fechamento por confirma√ß√µes antigas
                  exibirNotificacaoNovoOrcamento(orcamentosEncontrados);
                }
              })
              .withFailureHandler(function(error) {
                // Silenciosamente ignora
              })
              .getKanbanData();
          })
          .withFailureHandler(function(error) {
            // Silenciosamente ignora
          })
          .verificarConfirmacaoNotificacaoOrcamento();
      }
    }

    // Fun√ß√£o para verificar novos projetos em prepara√ß√£o
    function verificarNovosProjetosPreparacao() {
      // S√≥ verifica quando o slide do kanban est√° ativo
      if (currentSlide !== 'kanban') return;

      // Tenta verificar via API
      if (window.google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(data) {
            if (!data) return;

            // Procura pela coluna de prepara√ß√£o
            var colunaPreparacao = null;
            for (var status in data) {
              var statusLower = status.toLowerCase();
              if (statusLower.includes('prepara√ß√£o') || statusLower.includes('preparacao')) {
                colunaPreparacao = data[status];
                break;
              }
            }

            if (!colunaPreparacao || !Array.isArray(colunaPreparacao)) return;

            // Verifica novos projetos
            var novosProjetos = [];
            for (var i = 0; i < colunaPreparacao.length; i++) {
              var projeto = colunaPreparacao[i];
              var cliente = projeto.cliente || '';
              var projetoNome = projeto.projeto || '';
              var id = cliente + '|' + projetoNome;

              if (!id || id === '|') continue;

              // Na primeira verifica√ß√£o, marca todos como vistos
              if (primeiraVerificacaoPreparacao) {
                projetosPreparacaoVistos.add(id);
              } else if (!projetosPreparacaoVistos.has(id)) {
                // Se n√£o foi visto antes e n√£o √© a primeira verifica√ß√£o, √© novo
                novosProjetos.push({
                  id: id,
                  cliente: cliente,
                  projeto: projetoNome
                });
                projetosPreparacaoVistos.add(id);
              }
            }

            // Ap√≥s a primeira verifica√ß√£o, marca a flag como false
            if (primeiraVerificacaoPreparacao) {
              primeiraVerificacaoPreparacao = false;
            }

            // Se encontrou novos projetos, exibe notifica√ß√£o breve
            if (novosProjetos.length > 0) {
              exibirNotificacaoPreparacao(novosProjetos);
            }
          })
          .withFailureHandler(function(error) {
            // Silenciosamente ignora erros
          })
          .getKanbanData();
      }
    }

    // Fun√ß√£o para exibir notifica√ß√£o breve de prepara√ß√£o
    function exibirNotificacaoPreparacao(novosProjetos) {
      console.log('Exibindo notifica√ß√£o de prepara√ß√£o para', novosProjetos.length, 'projetos'); // Debug
      var notificacao = document.getElementById('notificacaoPreparacao');
      var mensagem = document.getElementById('mensagemPreparacao');
      
      if (!notificacao || !mensagem) {
        console.error('Elementos de notifica√ß√£o de prepara√ß√£o n√£o encontrados');
        return;
      }
      
      if (novosProjetos.length === 1) {
        mensagem.textContent = 'Cliente: ' + novosProjetos[0].cliente + ' - Projeto: ' + novosProjetos[0].projeto;
      } else {
        mensagem.textContent = novosProjetos.length + ' novos projetos entraram em prepara√ß√£o';
      }
      
      // Mostra a notifica√ß√£o
      notificacao.style.display = 'block';
      
      // Inicia o som por 10 segundos (sempre toca, mesmo se houver notifica√ß√£o de or√ßamento)
      console.log('Iniciando som de prepara√ß√£o'); // Debug
      iniciarSomPreparacao();
      
      // Remove a notifica√ß√£o ap√≥s 5 segundos (visual)
      setTimeout(function() {
        notificacao.style.display = 'none';
      }, 5000);
    }

    // Fun√ß√£o espec√≠fica para tocar som de prepara√ß√£o (mais alto e claro)
    function tocarSomPreparacao() {
      console.log('Tocando som de prepara√ß√£o'); // Debug
      try {
        // Cria ou reutiliza o contexto de √°udio
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        // Se o contexto estiver suspenso, resume
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
        
        var currentTime = audioContext.currentTime;
        
        // Primeira nota - mais alta e clara (frequ√™ncia mais alta)
        var oscillator1 = audioContext.createOscillator();
        var gainNode1 = audioContext.createGain();
        oscillator1.connect(gainNode1);
        gainNode1.connect(audioContext.destination);
        
        // Frequ√™ncias mais altas e distintas
        oscillator1.frequency.setValueAtTime(1200, currentTime);
        oscillator1.frequency.setValueAtTime(1500, currentTime + 0.2);
        oscillator1.type = 'triangle'; // Tipo square √© mais chamativo que sine
        
        // Volume bem mais alto (0.7 ao inv√©s de 0.3)
        gainNode1.gain.setValueAtTime(0.7, currentTime);
        gainNode1.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.5);
        
        oscillator1.start(currentTime);
        oscillator1.stop(currentTime + 0.5);
        
        // Segunda nota ap√≥s delay curto
        setTimeout(function() {
          try {
            var oscillator2 = audioContext.createOscillator();
            var gainNode2 = audioContext.createGain();
            oscillator2.connect(gainNode2);
            gainNode2.connect(audioContext.destination);
            
            var currentTime2 = audioContext.currentTime;
            oscillator2.frequency.setValueAtTime(1500, currentTime2);
            oscillator2.frequency.setValueAtTime(1800, currentTime2 + 0.2);
            oscillator2.type = 'triangle';
            
            gainNode2.gain.setValueAtTime(0.7, currentTime2);
            gainNode2.gain.exponentialRampToValueAtTime(0.01, currentTime2 + 0.5);
            
            oscillator2.start(currentTime2);
            oscillator2.stop(currentTime2 + 0.5);
          } catch (e) {
            console.log('Erro ao tocar segunda nota de prepara√ß√£o:', e);
          }
        }, 250);
        
        // Terceira nota para tornar mais distintivo
        setTimeout(function() {
          try {
            var oscillator3 = audioContext.createOscillator();
            var gainNode3 = audioContext.createGain();
            oscillator3.connect(gainNode3);
            gainNode3.connect(audioContext.destination);
            
            var currentTime3 = audioContext.currentTime;
            oscillator3.frequency.setValueAtTime(1800, currentTime3);
            oscillator3.frequency.setValueAtTime(2000, currentTime3 + 0.2);
            oscillator3.type = 'triangle';
            
            gainNode3.gain.setValueAtTime(0.7, currentTime3);
            gainNode3.gain.exponentialRampToValueAtTime(0.01, currentTime3 + 0.5);
            
            oscillator3.start(currentTime3);
            oscillator3.stop(currentTime3 + 0.5);
          } catch (e) {
            console.log('Erro ao tocar terceira nota de prepara√ß√£o:', e);
          }
        }, 500);
      } catch (e) {
        console.log('Erro ao criar √°udio de prepara√ß√£o:', e);
        // Fallback: usa beep do sistema mais alto
        try {
          var audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OSdTQ8OUKjk8LZjHAY4kdfyzHksBSR3x/Dej0AKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknU0PDlCo5PC2YxwGOJHX8sx5LAUkd8fw3o9AChRetOnrqFUU');
          audio.volume = 0.9; // Volume bem mais alto no fallback
          audio.play().catch(function(err) {
            console.log('Erro ao tocar √°udio fallback de prepara√ß√£o:', err);
          });
        } catch (e2) {
          console.log('Erro no fallback de √°udio de prepara√ß√£o:', e2);
        }
      }
    }

    // Fun√ß√£o para tocar som de prepara√ß√£o (limitado a 10 segundos)
    function iniciarSomPreparacao() {
      // Para qualquer intervalo anterior
      pararSomPreparacao();
      
      // Toca o som imediatamente (sempre toca, mesmo se houver notifica√ß√£o de or√ßamento)
      tocarSomPreparacao();

      var tempoInicio = Date.now();
      var duracaoMaxima = 10000; // 10 segundos em milissegundos

      // Configura para tocar a cada 2.5 segundos (mais frequente), mas apenas por 10 segundos
      intervaloAudioPreparacao = setInterval(function() {
        var tempoDecorrido = Date.now() - tempoInicio;
        
        if (tempoDecorrido >= duracaoMaxima) {
          // Para o som ap√≥s 10 segundos
          pararSomPreparacao();
          return;
        }
        
        // Toca o som sempre (n√£o verifica notifica√ß√£o de or√ßamento)
        tocarSomPreparacao();
      }, 2500); // A cada 2.5 segundos para ser mais frequente e chamativo
    }

    // Fun√ß√£o para parar o som de prepara√ß√£o
    function pararSomPreparacao() {
      if (intervaloAudioPreparacao) {
        clearInterval(intervaloAudioPreparacao);
        intervaloAudioPreparacao = null;
      }
    }

    // Inicia a verifica√ß√£o peri√≥dica de novos or√ßamentos
    function iniciarVerificacaoOrcamentos() {
      // Verifica a cada 5 segundos
      if (intervaloVerificacao) clearInterval(intervaloVerificacao);
      intervaloVerificacao = setInterval(function() {
        verificarNovosOrcamentos();
        verificarNovosProjetosPreparacao(); // Tamb√©m verifica prepara√ß√£o
      }, 5000);

      // Primeira verifica√ß√£o ap√≥s 2 segundos
      setTimeout(function() {
        verificarNovosOrcamentos();
        verificarNovosProjetosPreparacao();
      }, 2000);
    }

    // Inicia a verifica√ß√£o peri√≥dica de confirma√ß√µes remotas
    function iniciarVerificacaoConfirmacao() {
      // Verifica a cada 2 segundos se h√° confirma√ß√£o de outra inst√¢ncia
      if (intervaloVerificacaoConfirmacao) clearInterval(intervaloVerificacaoConfirmacao);
      intervaloVerificacaoConfirmacao = setInterval(function() {
        verificarConfirmacaoRemota();
      }, 2000);
    }

    toggleControls. addEventListener('click', function() {
      controls.classList.toggle('visible');
    });

    document.getElementById('btnApplySettings').addEventListener('click', function() {
      applySettings();
    });

    document.getElementById('btnAdicionarMensagem').addEventListener('click', function() {
      adicionarMensagem();
    });

    document.getElementById('novaMensagemTexto').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        adicionarMensagem();
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e. key === 'Escape') {
        controls.classList.toggle('visible');
      } else if (e. key === 'ArrowRight' || e.key === 'ArrowLeft') {
        if (timer) clearTimeout(timer);
        switchSlide();
      }
    });

    var presentationModeTimer = setTimeout(function() {
      document.body.classList.add('presentation-mode');
    }, 3000);

    document.addEventListener('mousemove', function() {
      clearTimeout(presentationModeTimer);
      document.body.classList. remove('presentation-mode');
      presentationModeTimer = setTimeout(function() {
        document.body.classList.add('presentation-mode');
      }, 3000);
    });

    setInterval(function() {
      if (currentSlide === 'kanban') {
        kanbanFrame.src = kanbanFrame.src;
      } else {
        segurancaFrame.src = segurancaFrame.src;
      }
    }, 300000);

    // Configura o bot√£o de confirma√ß√£o
    document.getElementById('btnConfirmarNotificacao').addEventListener('click', function() {
      confirmarVisualizacao();
    });

    // Permite fechar com ESC tamb√©m
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && notificacaoAtiva) {
        confirmarVisualizacao();
      }
    });

    loadSettings();
    updateTransitionTime();
    startCycle();
    iniciarSincronizacao();
    iniciarVerificacaoOrcamentos();
    iniciarVerificacaoConfirmacao();
    
    // Verifica notifica√ß√µes pendentes ao carregar a p√°gina
    setTimeout(function() {
      verificarNotificacoesPendentes();
    }, 3000); // Aguarda 3 segundos para garantir que tudo est√° carregado
  </script>
</body>

</html>