<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #001941, #398669);
      overflow: hidden;
    }

    /* Fundo animado com formas suaves */
    body::before {
      content: '';
      position: absolute;
      width: 250%;
      height: 250%;
      background: radial-gradient(circle, rgba(15, 143, 175, 0.2) 0%, transparent 70%);
      animation: rotate 30s linear infinite;
      z-index: 0;
    }

    @keyframes rotate {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .login-box {
      position: relative;
      z-index: 1;
      width: 360px;
      padding: 50px 40px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(15px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .login-box:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }

    .login-box img {
      width: 185px;
      margin-bottom: 20px;
    }

    .login-box h2 {
      font-weight: 600;
      color: #fff;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
      margin-bottom: 30px;
    }

    .input-group {
      position: relative;
      margin-bottom: 20px;
    }

    .input-group input {
      width: 100%;
      padding: 14px 40px 14px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.25);
      color: hwb(0 17% 83%);
      font-size: 14px;
      outline: none;
      transition: border 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    }

    .input-group input::placeholder {
      color: rgba(53, 53, 53, 0.7);
    }

    .input-group input:focus {
      border-color: #535353;
      background: rgba(255, 255, 255, 0.35);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
    }

    .input-group .icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      color: rgba(255, 255, 255, 0.8);
    }

    button {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      background: rgba(26, 139, 232, 0.8);
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    button:hover:not(:disabled) {
      background: rgba(26, 115, 232, 1);
      transform: translateY(-2px);
    }

    button:disabled {
      background: rgba(26, 115, 232, 0.5);
      cursor: not-allowed;
    }

    .error {
      color: #ff6b6b;
      font-size: 13px;
      margin-top: 10px;
      min-height: 18px;
    }

    .info {
      color: #dfeff7;
      font-size: 12px;
      margin-top: 10px;
      min-height: 18px;
    }

    @media(max-width:400px) {
      .login-box {
        width: 90%;
        padding: 40px 25px;
      }

      .login-box img {
        width: 140px;
      }
    }
  </style>
</head>

<body>

  <div class="login-box">
    <img src="https://i.imgur.com/F8X7ZMs.png" alt="Logo">
    <h2>Bem-vindo</h2>

    <div class="input-group">
      <input type="text" id="usuario" placeholder="UsuÃ¡rio" autofocus>
      <div class="icon">ðŸ‘¤</div>
    </div>

    <div class="input-group">
      <input type="password" id="senha" placeholder="Senha">
      <div class="icon">ðŸ”’</div>
    </div>

    <div class="error" id="erro"></div>
    <div class="info" id="info"></div>
    <button id="loginBtn" onclick="login()">Entrar</button>
  </div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyqo2sqE_x5VhtQPInTBS4XO78vk-S0Ec2LbgDtbUYVyX98oOA_oh4VRMdrmk8DBWvx6g/exec";

    var redirectTo = <?!= (typeof redirectTo !== 'undefined' && redirectTo) ? ("'" + String(redirectTo).replace(/'/g, "\\'") + "'") : "null" ?>;
    var postLoginMsg = <?!= (typeof postLoginMsg !== 'undefined' && postLoginMsg) ? ("'" + String(postLoginMsg).replace(/'/g, "\\'") + "'") : "null" ?>;

    // Flag vinda do Code.gs: templateLogin.embedded
    var embeddedMode = <?!= (typeof embedded !== 'undefined' && embedded) ? 'true' : 'false' ?>;

    function isEmbeddedMode() {
      return embeddedMode === true || embeddedMode === 'true';
    }

    // (initInfo permanece igual)
    (function initInfo() {
      const infoEl = document.getElementById('info');
      if (redirectTo) {
        try {
          const u = new URL(WEBAPP_URL + (redirectTo.startsWith('?') ? redirectTo : ('?' + redirectTo)));
          const p = u.searchParams.get('page') || redirectTo;
          infoEl.textContent = "Ao entrar vocÃª serÃ¡ redirecionado para: " + p;
        } catch (e) {
          infoEl.textContent = "Ao entrar vocÃª serÃ¡ redirecionado para a pÃ¡gina solicitada.";
        }
      } else if (postLoginMsg) {
        infoEl.textContent = postLoginMsg;
      }
    })();

    function login() {
      console.log('isEmbeddedMode() =', isEmbeddedMode());

      const usuario = document.getElementById('usuario').value.trim();
      const senha = document.getElementById('senha').value.trim();
      const btn = document.getElementById('loginBtn');
      const erro = document.getElementById('erro');

      if (!usuario || !senha) {
        erro.innerText = "Preencha usuÃ¡rio e senha";
        return;
      }

      btn.disabled = true;
      btn.textContent = "Entrando...";
      erro.innerText = "";

      google.script.run
        .withSuccessHandler(res => {
          if (res && res.success) {

            if (isEmbeddedMode()) {
              console.log("Executando em modo EMBEDDED: Enviando token para o app externo.");
              const message = { type: 'AUTH_TOKEN', token: res.token, redirectTo: redirectTo };
              window.top.postMessage(message, '*');
              btn.textContent = "Sucesso!";
            } else {
              console.log("Executando em modo Standalone: Redirecionando para o dashboard.");
              localStorage.setItem('token', res.token);  // <-- ADICIONE ESTA LINHA
              let destinationUrl = WEBAPP_URL + "?page=dashboard&token=" + encodeURIComponent(res.token);

              if (redirectTo) {
                destinationUrl = WEBAPP_URL + redirectTo +
                  (redirectTo.includes('?') ? '&' : '?') +
                  'token=' + encodeURIComponent(res.token);
              }

              window.top.location.href = destinationUrl;
            }

          } else {
            erro.innerText = "UsuÃ¡rio ou senha incorretos";
            btn.disabled = false;
            btn.textContent = "Entrar";
          }
        })
        .withFailureHandler(err => {
          erro.innerText = "Erro: " + err.message;
          btn.disabled = false;
          btn.textContent = "Entrar";
        })
        .autenticarUsuario(usuario, senha);
    }

    document.addEventListener('keydown', function (event) {
      if (event.key === 'Enter') login();
    });
  </script>
</body>

</html>